import 'dart:typed_data';

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../../../../../infrastructure/providers/storage_providers.dart';
import '../../../../../l10n/app_localizations.dart';
import '../../../common/editable_number_field.dart';
import '../../../common/m3_color_picker.dart';
import '../../../library/m3_library_picker_dialog.dart';
import '../m3_panel_styles.dart';
import 'm3_collection_color_utils.dart';

/// Material 3 visual properties panel for collection content
class M3VisualPropertiesPanel extends ConsumerStatefulWidget {
  final Map<String, dynamic> element;
  final Function(String, dynamic) onPropertyChanged;
  final Function(String, dynamic) onContentPropertyChanged;

  const M3VisualPropertiesPanel({
    Key? key,
    required this.element,
    required this.onPropertyChanged,
    required this.onContentPropertyChanged,
  }) : super(key: key);

  @override
  ConsumerState<M3VisualPropertiesPanel> createState() =>
      _M3VisualPropertiesPanelState();
}

class _M3VisualPropertiesPanelState
    extends ConsumerState<M3VisualPropertiesPanel> {
  // Âä†ËΩΩÁ∫πÁêÜÂõæÁâá - ‰ºòÂåñÁâà
  // ‰ΩøÁî®ÂÜÖÂ≠òÁºìÂ≠òÈÅøÂÖçÈáçÂ§çÂä†ËΩΩ
  static final Map<String, List<int>> _textureCache = {};
  // Êú¨Âú∞Áä∂ÊÄÅÊù•Ë∑üË∏™Â°´ÂÖÖÊ®°ÂºèÂíåÈÄÇÂ∫îÊ®°Âºè
  String? _localTextureFillMode;
  String? _localTextureFitMode;

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final colorScheme = Theme.of(context).colorScheme;
    final textTheme = Theme.of(context).textTheme;
    final opacity = (widget.element['opacity'] as num?)?.toDouble() ?? 1.0;
    final content = widget.element['content'] as Map<String, dynamic>;
    final fontColor = content['fontColor'] as String? ?? '#000000';
    final backgroundColor =
        content['backgroundColor'] as String? ?? 'transparent';
    final padding = (content['padding'] as num?)?.toDouble() ?? 0.0;

    // Âä®ÊÄÅËé∑ÂèñÁ∫πÁêÜÁõ∏ÂÖ≥Â±ûÊÄßÔºåÁ°Æ‰øùËÉΩÂèçÊò†ÊúÄÊñ∞ÁöÑÁî®Êà∑Êõ¥Êîπ
    final textureFillMode = _localTextureFillMode ??
        content['textureFillMode'] as String? ??
        'repeat'; // ÈªòËÆ§Â°´ÂÖÖÊ®°Âºè

    final textureFitMode = _localTextureFitMode ??
        content['textureFitMode'] as String? ??
        'scaleToFill'; // ÈªòËÆ§ÈÄÇÂ∫îÊ®°Âºè

    debugPrint(
        'üîç UIÊûÑÂª∫: textureFillMode=$textureFillMode, textureFitMode=$textureFitMode');
    return M3PanelStyles.buildPersistentPanelCard(
      context: context,
      panelId: 'collection_visual_properties',
      title: l10n.visualSettings,
      defaultExpanded: true,
      children: [
        // Color settings
        M3PanelStyles.buildSectionTitle(
            context, l10n.collectionPropertyPanelColorSettings),
        Row(
          children: [
            Text(
              '${l10n.textPropertyPanelFontColor}:',
              style: textTheme.bodyMedium?.copyWith(
                color: colorScheme.onSurfaceVariant,
              ),
            ),
            const SizedBox(width: 8.0),
            InkWell(
              onTap: () async {
                final color = await M3ColorPicker.show(
                  context,
                  initialColor: CollectionColorUtils.hexToColor(fontColor),
                  enableAlpha: true,
                  enableColorCode: true,
                );
                if (color != null) {
                  widget.onContentPropertyChanged(
                      'fontColor', CollectionColorUtils.colorToHex(color));
                }
              },
              borderRadius: BorderRadius.circular(8),
              child: Ink(
                decoration: BoxDecoration(
                  color: CollectionColorUtils.hexToColor(fontColor),
                  border: Border.all(color: colorScheme.outline),
                  borderRadius: BorderRadius.circular(8),
                ),
                width: 40,
                height: 40,
              ),
            ),
            const SizedBox(width: 16.0),
            Text(
              '${l10n.backgroundColor}:',
              style: textTheme.bodyMedium?.copyWith(
                color: colorScheme.onSurfaceVariant,
              ),
            ),
            const SizedBox(width: 8.0),
            InkWell(
              onTap: () async {
                final color = await M3ColorPicker.show(
                  context,
                  initialColor:
                      CollectionColorUtils.hexToColor(backgroundColor),
                  enableAlpha: true,
                  enableColorCode: true,
                );
                if (color != null) {
                  widget.onContentPropertyChanged('backgroundColor',
                      CollectionColorUtils.colorToHex(color));
                }
              },
              borderRadius: BorderRadius.circular(8),
              child: Ink(
                decoration: BoxDecoration(
                  color: CollectionColorUtils.hexToColor(backgroundColor),
                  border: Border.all(color: colorScheme.outline),
                  borderRadius: BorderRadius.circular(8),
                ),
                width: 40,
                height: 40,
              ),
            ),
          ],
        ),

        const SizedBox(height: 16.0),

        // Opacity
        M3PanelStyles.buildSectionTitle(context, l10n.opacity),
        Row(
          children: [
            Expanded(
              flex: 3,
              child: Slider(
                value: opacity,
                min: 0.0,
                max: 1.0,
                divisions: 100,
                label: '${(opacity * 100).round()}%',
                activeColor: colorScheme.primary,
                inactiveColor: colorScheme.surfaceContainerHighest,
                onChanged: (value) {
                  widget.onPropertyChanged('opacity', value);
                },
              ),
            ),
            const SizedBox(width: 8.0),
            Expanded(
              flex: 2,
              child: EditableNumberField(
                label: l10n.opacity,
                value: opacity * 100,
                suffix: '%',
                min: 0,
                max: 100,
                decimalPlaces: 0,
                onChanged: (value) {
                  widget.onPropertyChanged('opacity', value / 100);
                },
              ),
            ),
          ],
        ),
        const SizedBox(height: 16.0),

        // Background Texture Sub-panel
        _buildBackgroundTextureSubPanel(
            context, content, colorScheme, l10n, textTheme),

        const SizedBox(height: 16.0),

        // Padding
        M3PanelStyles.buildSectionTitle(context, l10n.textPropertyPanelPadding),
        Row(
          children: [
            Expanded(
              flex: 3,
              child: Slider(
                value: padding,
                min: 0,
                max: 100,
                divisions: 100,
                label: '${padding.round()}px',
                activeColor: colorScheme.primary,
                inactiveColor: colorScheme.surfaceContainerHighest,
                onChanged: (value) {
                  widget.onContentPropertyChanged('padding', value);
                },
              ),
            ),
            const SizedBox(width: 8.0),
            Expanded(
              flex: 2,
              child: EditableNumberField(
                label: l10n.textPropertyPanelPadding,
                value: padding,
                suffix: 'px',
                min: 0,
                max: 100,
                decimalPlaces: 0,
                onChanged: (value) {
                  widget.onContentPropertyChanged('padding', value);
                },
              ),
            ),
          ],
        ),

        const SizedBox(height: 16.0),
      ],
    );
  }

  // Build background texture sub-panel with organized controls
  Widget _buildBackgroundTextureSubPanel(
    BuildContext context,
    Map<String, dynamic> content,
    ColorScheme colorScheme,
    AppLocalizations l10n,
    TextTheme textTheme,
  ) {
    // Get texture properties - only background mode is used now
    final textureFillMode = _localTextureFillMode ??
        content['textureFillMode'] as String? ??
        'repeat'; // Default to repeat as specified

    final textureFitMode = content['textureFitMode'] as String? ??
        'scaleToFill'; // Default to scaleToFill as specified
    final textureOpacity = _getLatestTextureOpacity(content);

    // Get texture size properties (actual pixel values)
    final texture = _findTextureData(content);
    final defaultWidth = texture?['width']?.toDouble() ?? 100.0;
    final defaultHeight = texture?['height']?.toDouble() ?? 100.0;
    final textureWidth =
        (content['textureWidth'] as num?)?.toDouble() ?? defaultWidth;
    final textureHeight =
        (content['textureHeight'] as num?)?.toDouble() ?? defaultHeight;

    return M3PanelStyles.buildPersistentPanelCard(
      context: context,
      panelId: 'background_texture_subpanel',
      title:
          'ËÉåÊôØÁ∫πÁêÜ', // Using static text since backgroundTexture might not be defined
      defaultExpanded: false,
      children: [
        // Texture Fill Mode Settings (only repeat, cover, stretch, contain)
        M3PanelStyles.buildSectionTitle(context, l10n.textureFillMode),
        DropdownButton<String>(
          value: textureFillMode,
          isExpanded: true,
          items: [
            DropdownMenuItem(
              value: 'repeat',
              child: Text(l10n.textureFillModeRepeat),
            ),
            DropdownMenuItem(
              value: 'cover',
              child: Text(l10n.textureFillModeCover),
            ),
            const DropdownMenuItem(
              value: 'stretch',
              child: Text('Êãâ‰º∏'), // Stretch mode
            ),
            DropdownMenuItem(
              value: 'contain',
              child: Text(l10n.textureFillModeContain),
            ),
          ],
          onChanged: (value) {
            if (value != null) {
              debugPrint('üîÑ Á∫πÁêÜÂ°´ÂÖÖÊ®°ÂºèÂàáÊç¢: $textureFillMode -> $value');

              // Update local state first
              _localTextureFillMode = value;

              widget.onContentPropertyChanged('textureFillMode', value);
              // Force UI refresh
              setState(() {});
            }
          },
        ),

        const SizedBox(height: 16.0),

        // Texture Fit Mode Settings (scaleToFit, scaleToFill, scaleToCover)
        M3PanelStyles.buildSectionTitle(context, 'Á∫πÁêÜÈÄÇÂ∫îÊ®°Âºè'),
        DropdownButton<String>(
          value: textureFitMode,
          isExpanded: true,
          items: const [
            DropdownMenuItem(
              value: 'scaleToFit',
              child: Text('Áº©ÊîæÈÄÇÂ∫î'),
            ),
            DropdownMenuItem(
              value: 'scaleToFill',
              child: Text('Áº©ÊîæÂ°´ÂÖÖ'),
            ),
            DropdownMenuItem(
              value: 'scaleToCover',
              child: Text('Áº©ÊîæË¶ÜÁõñ'),
            ),
          ],
          onChanged: (value) {
            if (value != null) {
              debugPrint('üîÑ Á∫πÁêÜÈÄÇÂ∫îÊ®°ÂºèÂàáÊç¢: $textureFitMode -> $value');
              widget.onContentPropertyChanged('textureFitMode', value);
              setState(() {});
            }
          },
        ),

        const SizedBox(height: 16.0),

        // Texture Size Settings with restore default button
        M3PanelStyles.buildSectionTitle(context, 'Á∫πÁêÜÂ∞∫ÂØ∏'),
        Row(
          children: [
            Expanded(
              child: EditableNumberField(
                label: 'ÂÆΩÂ∫¶',
                value: textureWidth,
                suffix: 'px',
                min: 1,
                max: 9999,
                decimalPlaces: 0,
                onChanged: (value) {
                  widget.onContentPropertyChanged('textureWidth', value);
                  setState(() {});
                },
              ),
            ),
            const SizedBox(width: 8.0),
            Expanded(
              child: EditableNumberField(
                label: 'È´òÂ∫¶',
                value: textureHeight,
                suffix: 'px',
                min: 1,
                max: 9999,
                decimalPlaces: 0,
                onChanged: (value) {
                  widget.onContentPropertyChanged('textureHeight', value);
                  setState(() {});
                },
              ),
            ),
            const SizedBox(width: 8.0),
            IconButton(
              icon: const Icon(Icons.restore),
              tooltip: 'ÊÅ¢Â§çÈªòËÆ§Â∞∫ÂØ∏',
              onPressed: () {
                widget.onContentPropertyChanged('textureWidth', defaultWidth);
                widget.onContentPropertyChanged('textureHeight', defaultHeight);
                setState(() {});
              },
            ),
          ],
        ),
        const SizedBox(height: 16.0),

        // Texture Transparency Settings
        M3PanelStyles.buildSectionTitle(context, 'Á∫πÁêÜÈÄèÊòéÂ∫¶'),
        Row(
          children: [
            Expanded(
              flex: 3,
              child: Slider(
                value: textureOpacity,
                min: 0.0,
                max: 1.0,
                divisions: 100,
                label: '${(textureOpacity * 100).round()}%',
                activeColor: colorScheme.primary,
                inactiveColor: colorScheme.surfaceContainerHighest,
                onChanged: (value) {
                  widget.onContentPropertyChanged('textureOpacity', value);
                  setState(() {});
                },
              ),
            ),
            const SizedBox(width: 8.0),
            Expanded(
              flex: 2,
              child: EditableNumberField(
                label: 'ÈÄèÊòéÂ∫¶',
                value: textureOpacity * 100,
                suffix: '%',
                min: 0,
                max: 100,
                decimalPlaces: 0,
                onChanged: (value) {
                  widget.onContentPropertyChanged(
                      'textureOpacity', value / 100);
                  setState(() {});
                },
              ),
            ),
          ],
        ),

        const SizedBox(height: 16.0),

        // Texture preview and management
        M3PanelStyles.buildSectionTitle(context, 'Á∫πÁêÜÈ¢ÑËßà'),
        Row(
          children: [
            Container(
              width: 120,
              height: 120,
              decoration: BoxDecoration(
                border: Border.all(color: colorScheme.outline),
                borderRadius: BorderRadius.circular(8),
              ),
              child: _buildTexturePreview(content),
            ),
            const SizedBox(width: 16.0),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                mainAxisSize: MainAxisSize.min,
                children: [
                  FilledButton.icon(
                    icon: const Icon(Icons.image),
                    label: Text(l10n.textureSelectFromLibrary),
                    onPressed: () => _selectTexture(
                        context, content, widget.onContentPropertyChanged),
                  ),
                  if (content.containsKey('backgroundTexture'))
                    const SizedBox(height: 8.0),
                  if (content.containsKey('backgroundTexture'))
                    SizedBox(
                      width: double.infinity,
                      child: TextButton.icon(
                        icon: const Icon(Icons.delete_outline),
                        label: Text(l10n.textureRemove),
                        onPressed: () {
                          debugPrint('‚ú® Â∞ùËØïÁßªÈô§ËÉåÊôØÁ∫πÁêÜ');
                          widget.onContentPropertyChanged(
                              'backgroundTexture', null);
                          setState(() {});
                        },
                      ),
                    ),
                ],
              ),
            ),
          ],
        ),
      ],
    );
  }

  // Â¢ûÂº∫ÁâàÁöÑÁ∫πÁêÜÈ¢ÑËßà
  Widget _buildTexturePreview(Map<String, dynamic> content) {
    // ÈÄíÂΩíÊü•ÊâæÁ∫πÁêÜÊï∞ÊçÆ
    final texture = _findTextureData(content);

    debugPrint('Á∫πÁêÜÈ¢ÑËßàÊ£ÄÊü•: ÊâæÂà∞Á∫πÁêÜ=${texture != null}');

    if (texture == null || texture.isEmpty) {
      debugPrint('Êú™Ê£ÄÊµãÂà∞Á∫πÁêÜÔºöÊ≤°ÊúâÊâæÂà∞ÊúâÊïàÁöÑ backgroundTexture Êï∞ÊçÆ');
      return const Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(Icons.texture_outlined, color: Colors.grey),
            SizedBox(height: 4),
            Text('Êó†Á∫πÁêÜ', style: TextStyle(fontSize: 10, color: Colors.grey)),
          ],
        ),
      );
    }

    final textureId = texture['id'] as String?;
    final texturePath = texture['path'] as String?;

    debugPrint('Á∫πÁêÜÊï∞ÊçÆ: id=$textureId, path=$texturePath');

    if (textureId == null || texturePath == null || texturePath.isEmpty) {
      debugPrint('Á∫πÁêÜÊï∞ÊçÆ‰∏çÂÆåÊï¥: id=$textureId, path=$texturePath');
      return const Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(Icons.broken_image_outlined, color: Colors.orange),
            SizedBox(height: 4),
            Text('Êï∞ÊçÆ‰∏çÂÆåÊï¥', style: TextStyle(fontSize: 10, color: Colors.orange)),
          ],
        ),
      );
    } // Ëé∑ÂèñÁ∫πÁêÜÂ°´ÂÖÖÊ®°ÂºèÂíåÂ∫îÁî®ËåÉÂõ¥
    final fillMode = _getLatestTextureProperty('textureFillMode', content) ??
        'repeat'; // Áî±‰∫éÁßªÈô§‰∫ÜtextureApplicationRangeÔºåÁõ¥Êé•‰ΩøÁî®backgroundÊ®°Âºè
    const applicationRange = 'background';

    // Á°ÆÂÆöÁ∫πÁêÜÈ¢ÑËßàÁöÑ BoxFit Ê®°Âºè
    BoxFit previewFit;
    switch (fillMode) {
      case 'contain':
        previewFit = BoxFit.contain;
        break;
      case 'cover':
        previewFit = BoxFit.cover;
        break;
      case 'noRepeat':
        previewFit = BoxFit.none;
        break;
      case 'repeat':
      case 'repeatX':
      case 'repeatY':
      default:
        // ÂØπ‰∫éÈáçÂ§çÊ®°ÂºèÔºå‰ΩøÁî® cover ‰ª•‰æø‰∫éÈ¢ÑËßà
        previewFit = BoxFit.cover;
        break;
    }

    debugPrint(
        'Á∫πÁêÜÊ†∑Âºè: Â°´ÂÖÖÊ®°Âºè=$fillMode, Â∫îÁî®ËåÉÂõ¥=$applicationRange, È¢ÑËßàÈÄÇÂ∫îÊñπÂºè=$previewFit');

    return ClipRRect(
      borderRadius: BorderRadius.circular(8),
      child: Stack(
        children: [
          // Á∫πÁêÜÂõæÂÉè
          FutureBuilder<List<int>>(
            future: _loadTextureImage(texturePath),
            builder: (context, snapshot) {
              // Ëé∑ÂèñÊúÄÊñ∞ÁöÑÁ∫πÁêÜ‰∏çÈÄèÊòéÂ∫¶
              final textureOpacity = _getLatestTextureOpacity(content);

              if (snapshot.connectionState == ConnectionState.waiting) {
                return const Center(
                  child: SizedBox(
                    width: 24,
                    height: 24,
                    child: CircularProgressIndicator(strokeWidth: 2),
                  ),
                );
              }

              if (snapshot.hasError) {
                debugPrint('Âä†ËΩΩÁ∫πÁêÜÂ§±Ë¥•: ${snapshot.error}');
                return const Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(Icons.error_outline, color: Colors.red, size: 18),
                      SizedBox(height: 4),
                      Text('Âä†ËΩΩÂ§±Ë¥•',
                          style: TextStyle(fontSize: 10, color: Colors.red)),
                    ],
                  ),
                );
              }

              if (!snapshot.hasData || snapshot.data!.isEmpty) {
                debugPrint('Á∫πÁêÜÊï∞ÊçÆ‰∏∫Á©∫');
                return const Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(Icons.image_not_supported,
                          color: Colors.orange, size: 18),
                      SizedBox(height: 4),
                      Text('Êï∞ÊçÆ‰∏∫Á©∫',
                          style: TextStyle(fontSize: 10, color: Colors.orange)),
                    ],
                  ),
                );
              }

              debugPrint(
                  'Á∫πÁêÜÂä†ËΩΩÊàêÂäü, ÂõæÁâáÊï∞ÊçÆÈïøÂ∫¶: ${snapshot.data!.length}, ‰∏çÈÄèÊòéÂ∫¶: $textureOpacity');
              return Opacity(
                opacity: textureOpacity,
                child: Image.memory(
                  Uint8List.fromList(snapshot.data!),
                  fit: previewFit,
                  width: double.infinity,
                  height: double.infinity,
                  errorBuilder: (context, error, stackTrace) {
                    debugPrint('Ê∏≤ÊüìÁ∫πÁêÜÂ§±Ë¥•: $error');
                    return const Center(
                      child: Column(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          Icon(Icons.image_not_supported,
                              color: Colors.red, size: 18),
                          SizedBox(height: 4),
                          Text('Ê∏≤ÊüìÂ§±Ë¥•',
                              style:
                                  TextStyle(fontSize: 10, color: Colors.red)),
                        ],
                      ),
                    );
                  },
                ),
              );
            },
          ),

          // Âè≥‰∏ãËßíÊòæÁ§∫Â°´ÂÖÖÊ®°ÂºèÊ†áËØÜ
          Positioned(
            right: 0,
            bottom: 0,
            child: Container(
              padding: const EdgeInsets.all(2),
              color: Colors.black.withOpacity(0.5),
              child: Row(
                mainAxisSize: MainAxisSize.min,
                children: [
                  const Icon(
                    applicationRange == 'character'
                        ? Icons.text_fields
                        : Icons.crop_free,
                    color: Colors.white,
                    size: 10,
                  ),
                  const SizedBox(width: 2),
                  Icon(
                    fillMode == 'repeat'
                        ? Icons.grid_on
                        : fillMode == 'contain'
                            ? Icons.fit_screen
                            : fillMode == 'cover'
                                ? Icons.crop
                                : Icons.texture,
                    color: Colors.white,
                    size: 10,
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  // ÈÄíÂΩíÊü•ÊâæÁ∫πÁêÜÊï∞ÊçÆ
  Map<String, dynamic>? _findTextureData(Map<String, dynamic> content) {
    // È¶ñÂÖàÊ£ÄÊü•ÂΩìÂâçÂ±ÇÊòØÂê¶ÊúâËÉåÊôØÁ∫πÁêÜ
    if (content.containsKey('backgroundTexture') &&
        content['backgroundTexture'] != null &&
        content['backgroundTexture'] is Map<String, dynamic>) {
      return content['backgroundTexture'] as Map<String, dynamic>;
    }

    // Â¶ÇÊûúÂΩìÂâçÂ±ÇÊ≤°ÊúâËÉåÊôØÁ∫πÁêÜÔºå‰ΩÜÊúâÂµåÂ•óÂÜÖÂÆπÔºåÂàôÈÄíÂΩíÊü•Êâæ
    if (content.containsKey('content') &&
        content['content'] != null &&
        content['content'] is Map<String, dynamic>) {
      return _findTextureData(content['content'] as Map<String, dynamic>);
    }

    // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞‰ªª‰ΩïÁ∫πÁêÜÊï∞ÊçÆÔºåËøîÂõûnull
    return null;
  }

  // Ëé∑ÂèñÊúÄÊñ∞ÁöÑÁ∫πÁêÜ‰∏çÈÄèÊòéÂ∫¶ÂÄº
  double _getLatestTextureOpacity(Map<String, dynamic> localContent) {
    if (widget.element['content'] != null &&
        (widget.element['content'] as Map<String, dynamic>)
            .containsKey('textureOpacity')) {
      final value =
          (widget.element['content'] as Map<String, dynamic>)['textureOpacity'];
      if (value is num) {
        return value.toDouble();
      }
    }

    final value = localContent['textureOpacity'];
    if (value is num) {
      return value.toDouble();
    }

    return 1.0;
  }

  // Ëé∑ÂèñÊúÄÊñ∞ÁöÑÁ∫πÁêÜÂ±ûÊÄßÂÄº
  String? _getLatestTextureProperty(
      String propertyName, Map<String, dynamic> localContent) {
    if (widget.element['content'] != null &&
        (widget.element['content'] as Map<String, dynamic>)
            .containsKey(propertyName)) {
      final value =
          (widget.element['content'] as Map<String, dynamic>)[propertyName];
      return value is String ? value : value?.toString();
    }

    final value = localContent[propertyName];
    return value is String ? value : value?.toString();
  }

  Future<List<int>> _loadTextureImage(String path) async {
    debugPrint('Âä†ËΩΩÁ∫πÁêÜÂõæÁâá: $path');

    // Ê£ÄÊü•ÂÜÖÂ≠òÁºìÂ≠ò
    final cacheKey = path.split('/').last;
    if (_textureCache.containsKey(cacheKey)) {
      debugPrint(
          '‚úÖ ‰ªéÂÜÖÂ≠òÁºìÂ≠òÂä†ËΩΩÁ∫πÁêÜ: $cacheKey, Â§ßÂ∞è: ${_textureCache[cacheKey]!.length} Â≠óËäÇ');
      return _textureCache[cacheKey]!;
    }

    try {
      final storage = ref.read(initializedStorageProvider);

      // Êõ¥ËØ¶ÁªÜÁöÑÊó•Âøó‰ø°ÊÅØÂ∏ÆÂä©Ë∞ÉËØï
      debugPrint('Â≠òÂÇ®ÊúçÂä°: ${storage.runtimeType}');
      debugPrint('Â∫îÁî®Êï∞ÊçÆË∑ØÂæÑ: ${storage.getAppDataPath()}');

      // Áõ¥Êé•Â∞ùËØïÂÆåÊï¥Ë∑ØÂæÑ - ËøôÊòØÊó•Âøó‰∏≠ÊòæÁ§∫ÁöÑË∑ØÂæÑ
      if (path.contains('C:\\Users')) {
        final exists = await storage.fileExists(path);
        if (exists) {
          final imageBytes = await storage.readFile(path);
          debugPrint('‚úÖ ÊàêÂäü‰ªéÂÆåÊï¥Ë∑ØÂæÑÂä†ËΩΩÁ∫πÁêÜ: $path, Â§ßÂ∞è: ${imageBytes.length} Â≠óËäÇ');
          _textureCache[cacheKey] = imageBytes; // ÁºìÂ≠òÁªìÊûú
          return imageBytes;
        }
      }

      // Â∞ùËØïÂ§öÁßçË∑ØÂæÑÊ†ºÂºè
      final List<String> pathsToTry = [
        path, // ÂéüÂßãË∑ØÂæÑ
        path.startsWith('/') ? path : '/$path', // ÁªùÂØπË∑ØÂæÑ
        !path.startsWith('/')
            ? '${storage.getAppDataPath()}/$path'
            : path, // Â∏¶Â∫îÁî®Êï∞ÊçÆË∑ØÂæÑ
        '${storage.getAppDataPath()}/library/${path.split('/').last}', // Â∫ìÁõÆÂΩïË∑ØÂæÑ
      ];

      // ËÆ∞ÂΩïÊâÄÊúâÂ∞ùËØïÁöÑË∑ØÂæÑ
      debugPrint('Â∞ÜÂ∞ùËØï‰ª•‰∏ãË∑ØÂæÑ: $pathsToTry');

      // Â∞ùËØïÊâÄÊúâÂèØËÉΩÁöÑË∑ØÂæÑ
      for (final tryPath in pathsToTry) {
        final exists = await storage.fileExists(tryPath);
        debugPrint('Â∞ùËØïË∑ØÂæÑ: $tryPath, Â≠òÂú®: $exists');

        if (exists) {
          final imageBytes = await storage.readFile(tryPath);
          debugPrint('‚úÖ ÊàêÂäü‰ªé $tryPath Âä†ËΩΩÁ∫πÁêÜ, Â§ßÂ∞è: ${imageBytes.length} Â≠óËäÇ');
          _textureCache[cacheKey] = imageBytes; // ÁºìÂ≠òÁªìÊûú
          return imageBytes;
        }
      }

      // Â¶ÇÊûúÊâÄÊúâÁõ¥Êé•Ë∑ØÂæÑÈÉΩÂ§±Ë¥•ÔºåÂ∞ùËØïÂú®Â∫ìÁõÆÂΩï‰∏≠Êü•ÊâæÊñá‰ª∂ÂêçÁõ∏‰ººÁöÑÊñá‰ª∂
      try {
        final libraryDir = '${storage.getAppDataPath()}/library';
        final dirContents = await storage.listDirectoryFiles(libraryDir);
        debugPrint('Â∫ìÁõÆÂΩïÂÜÖÂÆπ: $libraryDir - $dirContents');

        final fileName = path.split('/').last.toLowerCase();
        final fileId = path.split('/').last.split('.').first.toLowerCase();

        // ÈÅçÂéÜÂ∫ìÁõÆÂΩï‰∏≠ÁöÑÊñá‰ª∂ÔºåÊü•ÊâæÊñá‰ª∂ÂêçÁõ∏‰ººÁöÑ
        for (final file in dirContents) {
          final fileBaseName = file.split('/').last.toLowerCase();
          if (fileBaseName.contains(fileName) ||
              fileName.contains(fileBaseName) ||
              fileBaseName.contains(fileId) ||
              fileId.contains(fileBaseName)) {
            debugPrint('ÊâæÂà∞ÂèØËÉΩÂåπÈÖçÁöÑÊñá‰ª∂: $file');
            try {
              final fullPath = '$libraryDir/${file.split('/').last}';
              final imageBytes = await storage.readFile(fullPath);
              debugPrint('‚úÖ ‰ΩøÁî®ÂåπÈÖçÊñá‰ª∂ÊàêÂäüÂä†ËΩΩÁ∫πÁêÜ, Â§ßÂ∞è: ${imageBytes.length} Â≠óËäÇ');
              _textureCache[cacheKey] = imageBytes; // ÁºìÂ≠òÁªìÊûú
              return imageBytes;
            } catch (fileError) {
              debugPrint('Â∞ùËØïÂä†ËΩΩÂåπÈÖçÊñá‰ª∂Â§±Ë¥•: $fileError');
            }
          }
        }
      } catch (dirError) {
        debugPrint('Êó†Ê≥ïÂàóÂá∫ÁõÆÂΩïÂÜÖÂÆπ: $dirError');
      }

      // Â¶ÇÊûúÊ≠§Êó∂‰ªçÊú™ÊâæÂà∞Êñá‰ª∂ÔºåÊäõÂá∫ÂºÇÂ∏∏
      throw Exception('Êâæ‰∏çÂà∞Á∫πÁêÜÂõæÁâáÊñá‰ª∂: Â∑≤Â∞ùËØïÂ§öÁßçË∑ØÂæÑ‰ΩÜÂùáÂ§±Ë¥•');
    } catch (e, stackTrace) {
      debugPrint('‚ùå Âä†ËΩΩÁ∫πÁêÜÂõæÁâáÂ§±Ë¥•: $e');
      debugPrint('Â†ÜÊ†àË∑üË∏™: $stackTrace');
      rethrow;
    }
  }

  // ÂÆåÂÖ®ÈáçÂÜôÁöÑÈÄâÊã©Á∫πÁêÜÊñπÊ≥ï - Èò≤Ê≠¢ÂµåÂ•óÈóÆÈ¢ò
  Future<void> _selectTexture(
    BuildContext context,
    Map<String, dynamic> content,
    Function(String, dynamic) onContentPropertyChanged,
  ) async {
    final l10n = AppLocalizations.of(context);
    debugPrint('‚ú® ÊâìÂºÄÁ∫πÁêÜÈÄâÊã©ÂØπËØùÊ°Ü');

    // ÊâìÂºÄÈÄâÊã©ÂØπËØùÊ°Ü
    final selectedTexture = await M3LibraryPickerDialog.show(
      context,
      title: l10n.textureSelectFromLibrary,
    );

    // Â¶ÇÊûúÁî®Êà∑ÂèñÊ∂à‰∫ÜÈÄâÊã©ÔºåÁõ¥Êé•ËøîÂõû
    if (selectedTexture == null) {
      debugPrint('‚ùå Áî®Êà∑ÂèñÊ∂à‰∫ÜÁ∫πÁêÜÈÄâÊã©');
      return;
    }

    debugPrint(
        '‚úÖ Áî®Êà∑ÈÄâÊã©‰∫ÜÁ∫πÁêÜ: ID=${selectedTexture.id}, Ë∑ØÂæÑ=${selectedTexture.path}');

    try {
      // ÂàõÂª∫Á∫πÁêÜÊï∞ÊçÆÂØπË±°
      final textureData = {
        'id': selectedTexture.id,
        'path': selectedTexture.path,
        'width': selectedTexture.width,
        'height': selectedTexture.height,
        'type': selectedTexture.type,
        'format': selectedTexture.format,
        'timestamp': DateTime.now().millisecondsSinceEpoch,
      };

      // Ëé∑ÂèñÂÖÉÁ¥†ÁöÑÂÆåÊï¥ÂÜÖÂÆπ
      final elementContent = widget.element['content'] as Map<String, dynamic>?;
      if (elementContent == null) {
        debugPrint('‚ùå ÂÖÉÁ¥†ÂÜÖÂÆπ‰∏∫Á©∫ÔºåÊó†Ê≥ïÂ∫îÁî®Á∫πÁêÜ');
        return;
      } // Â§çÂà∂Áé∞ÊúâÂÜÖÂÆπÔºåÊ∑ªÂä†Á∫πÁêÜÊï∞ÊçÆ
      final newContent = Map<String, dynamic>.from(elementContent);
      newContent['backgroundTexture'] = textureData;

      // ËÆæÁΩÆÁ∫πÁêÜÁõ∏ÂÖ≥Â±ûÊÄß - Âè™ÊîØÊåÅbackgroundÊ®°ÂºèÔºåÁßªÈô§textureApplicationRange
      newContent['textureFillMode'] =
          elementContent['textureFillMode'] ?? 'repeat'; // Default to repeat
      newContent['textureFitMode'] = elementContent['textureFitMode'] ??
          'scaleToFill'; // Default to scaleToFill
      newContent['textureOpacity'] = elementContent['textureOpacity'] ?? 1.0;

      // Set default texture size to actual image pixel values
      newContent['textureWidth'] =
          elementContent['textureWidth'] ?? selectedTexture.width.toDouble();
      newContent['textureHeight'] =
          elementContent['textureHeight'] ?? selectedTexture.height.toDouble();

      // Êõ¥Êñ∞ÂÜÖÂÆπ
      widget.onContentPropertyChanged('content', newContent);

      // Âº∫Âà∂Âà∑Êñ∞UI
      setState(() {});

      debugPrint('‚úÖ Á∫πÁêÜÂ∫îÁî®ÊàêÂäü');
    } catch (e) {
      debugPrint('‚ùå Â∫îÁî®Á∫πÁêÜÊó∂Âá∫Èîô: $e');
    }
  }
}
