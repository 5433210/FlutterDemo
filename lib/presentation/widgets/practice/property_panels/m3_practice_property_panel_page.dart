import 'package:flutter/material.dart';

import '../../../../infrastructure/logging/edit_page_logger_extension.dart';
import '../../../../l10n/app_localizations.dart';
import '../../../../utils/config/edit_page_logging_config.dart';
import '../../common/editable_number_field.dart';
import '../../common/m3_color_picker.dart';
import '../practice_edit_controller.dart';
import 'm3_panel_styles.dart';

/// Material 3 È°µÈù¢Â±ûÊÄßÈù¢Êùø
class M3PagePropertyPanel extends StatefulWidget {
  final Map<String, dynamic>? page;
  final Function(Map<String, dynamic>) onPagePropertiesChanged;
  final PracticeEditController controller;

  const M3PagePropertyPanel({
    super.key,
    required this.controller,
    required this.page,
    required this.onPagePropertiesChanged,
  });

  @override
  State<M3PagePropertyPanel> createState() => _M3PagePropertyPanelState();
}

class _M3PagePropertyPanelState extends State<M3PagePropertyPanel> {
  // ÂÆΩÂ∫¶„ÄÅÈ´òÂ∫¶ÂíåDPIËæìÂÖ•ÊéßÂà∂Âô®
  late TextEditingController _widthController;
  late TextEditingController _heightController;
  late TextEditingController _dpiController;
  late TextEditingController _backgroundColorController;
  late FocusNode _widthFocusNode;
  late FocusNode _heightFocusNode;
  late FocusNode _dpiFocusNode;
  
  // ÊªëÂùóÊãñÂä®Êó∂ÁöÑÂéüÂßãDPIÂÄº
  int? _originalDpiValue;
  // üöÄ ÊñπÊ°àBÔºöÁΩëÊ†ºÂ§ßÂ∞èÂéüÂßãÂÄºËøΩË∏™
  double? _originalGridSize;

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final colorScheme = Theme.of(context).colorScheme;
    final textTheme = Theme.of(context).textTheme;

    if (widget.page == null) {
      return Center(child: Text(l10n.noPageSelected));
    }

    final width = (widget.page!['width'] as num?)?.toDouble() ?? 595.0;
    final height = (widget.page!['height'] as num?)?.toDouble() ?? 842.0;
    final orientation = widget.page!['orientation'] as String? ?? 'portrait';
    final dpi = (widget.page!['dpi'] as num?)?.toInt() ?? 300;

    return ListView(
      padding: const EdgeInsets.symmetric(vertical: 8.0),
      children: [
        // È°µÈù¢Ê†áÈ¢ò
        Padding(
          padding: const EdgeInsets.all(16.0),
          child: Row(
            children: [
              Icon(
                Icons.description,
                color: colorScheme.primary,
                size: 24,
              ),
              const SizedBox(width: 8),
              Text(
                l10n.pageProperties,
                style: textTheme.titleLarge?.copyWith(
                  fontWeight: FontWeight.bold,
                  color: colorScheme.onSurface,
                ),
              ),
            ],
          ),
        ),

        // È°µÈù¢Â∞∫ÂØ∏ËÆæÁΩÆ
        M3PanelStyles.buildPersistentPanelCard(
          context: context,
          panelId: 'page_size_settings',
          title: l10n.pageSize,
          defaultExpanded: true,
          children: [
            Padding(
              padding:
                  const EdgeInsets.symmetric(horizontal: 16.0, vertical: 8.0),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // È¢ÑËÆæÂ∞∫ÂØ∏ÈÄâÊã©
                  Text('${l10n.presetSize}:',
                      style: const TextStyle(fontWeight: FontWeight.bold)),
                  const SizedBox(height: 8.0),
                  Card(
                    elevation: 0,
                    color: colorScheme.surfaceContainerHighest,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12.0),
                    ),
                    child: Padding(
                      padding: const EdgeInsets.all(8.0),
                      child: DropdownButtonFormField<String>(
                        value: _getPageSizePreset(width, height),
                        isExpanded: true,
                        decoration: InputDecoration(
                          border: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(8.0),
                            borderSide: BorderSide(
                              color: colorScheme.outline,
                            ),
                          ),
                          contentPadding: const EdgeInsets.symmetric(
                            horizontal: 16.0,
                            vertical: 12.0,
                          ),
                          filled: true,
                          fillColor: colorScheme.surface,
                        ),
                        items: [
                          DropdownMenuItem(
                            value: 'A4',
                            child: Text(l10n.a4Size),
                          ),
                          DropdownMenuItem(
                            value: 'A5',
                            child: Text(l10n.a5Size),
                          ),
                          // Êñ∞Â¢ûÂ∏∏Áî®Â∞∫ÂØ∏ÔºàÊöÇÊú™Êú¨Âú∞ÂåñÔºåÂêéÁª≠ÂèØÂä†ÂÖ• l10nÔºâ
                          const DropdownMenuItem(
                            value: 'A3',
                            child: Text('A3 (297√ó420mm)'),
                          ),
                          const DropdownMenuItem(
                            value: 'A3_PLUS',
                            child: Text('A3+ (329√ó483mm)'), // Â∏∏ËßÅ A3+ Â∞∫ÂØ∏
                          ),
                          const DropdownMenuItem(
                            value: 'B3',
                            child: Text('B3 (353√ó500mm)'),
                          ),
                          const DropdownMenuItem(
                            value: 'B4',
                            child: Text('B4 (250√ó353mm)'),
                          ),
                          const DropdownMenuItem(
                            value: 'B5',
                            child: Text('B5 (176√ó250mm)'),
                          ),
                          const DropdownMenuItem(
                            value: 'B6',
                            child: Text('B6 (125√ó176mm)'),
                          ),
                          const DropdownMenuItem(
                            value: 'C6',
                            child: Text('C6 (114√ó162mm)'),
                          ),
                          const DropdownMenuItem(
                            value: 'K_16',
                            child: Text('16ÂºÄ (185√ó260mm)'),
                          ),
                          const DropdownMenuItem(
                            value: 'K_32',
                            child: Text('32ÂºÄ (130√ó185mm)'),
                          ),
                          const DropdownMenuItem(
                            value: 'K_32_LARGE',
                            child: Text('Â§ß32ÂºÄ (140√ó203mm)'),
                          ),
                          const DropdownMenuItem(
                            value: 'K_8K',
                            child: Text('8K (260√ó370mm)'),
                          ),
                          const DropdownMenuItem(
                            value: 'K_16K',
                            child: Text('16K (195√ó270mm)'),
                          ),
                          DropdownMenuItem(
                            value: 'custom',
                            child: Text(l10n.customSize),
                          ),
                        ],
                        onChanged: (value) {
                          if (value != null) {
                            _handlePageSizePresetChange(value, orientation);
                          }
                        },
                      ),
                    ),
                  ),
                  const SizedBox(height: 16.0),

                  // È°µÈù¢ÊñπÂêëËÆæÁΩÆ
                  Text('${l10n.pageOrientation}:',
                      style: const TextStyle(fontWeight: FontWeight.bold)),
                  const SizedBox(height: 8.0),
                  Card(
                    elevation: 0,
                    color: colorScheme.surfaceContainerHighest,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12.0),
                    ),
                    child: Padding(
                      padding: const EdgeInsets.all(4.0),
                      child: Row(
                        children: [
                          Expanded(
                            child: RadioListTile<String>(
                              title: Text(l10n.portrait),
                              value: 'portrait',
                              groupValue: orientation,
                              activeColor: colorScheme.primary,
                              onChanged: (value) {
                                if (value != null && value != orientation) {
                                  final Map<String, dynamic> updates = {
                                    'orientation': value
                                  };
                                  // Â¶ÇÊûúÂΩìÂâçÂÆΩÂ∫¶Â§ß‰∫éÈ´òÂ∫¶Ôºå‰∫§Êç¢ÂÆΩÈ´ò
                                  if (width > height) {
                                    updates['width'] = height;
                                    updates['height'] = width;

                                    // Êõ¥Êñ∞ÊéßÂà∂Âô®ÁöÑÂÄº
                                    _widthController.text = height.toString();
                                    _heightController.text = width.toString();
                                  }
                                  widget.onPagePropertiesChanged(updates);
                                }
                              },
                            ),
                          ),
                          Expanded(
                            child: RadioListTile<String>(
                              title: Text(l10n.landscape),
                              value: 'landscape',
                              groupValue: orientation,
                              activeColor: colorScheme.primary,
                              onChanged: (value) {
                                if (value != null && value != orientation) {
                                  final Map<String, dynamic> updates = {
                                    'orientation': value
                                  };
                                  // Â¶ÇÊûúÂΩìÂâçÂÆΩÂ∫¶Â∞è‰∫éÈ´òÂ∫¶Ôºå‰∫§Êç¢ÂÆΩÈ´ò
                                  if (width < height) {
                                    updates['width'] = height;
                                    updates['height'] = width;

                                    // Êõ¥Êñ∞ÊéßÂà∂Âô®ÁöÑÂÄº
                                    _widthController.text = height.toString();
                                    _heightController.text = width.toString();
                                  }
                                  widget.onPagePropertiesChanged(updates);
                                }
                              },
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                  const SizedBox(height: 16.0),

                  // Â∞∫ÂØ∏ËæìÂÖ•
                  Text('${l10n.dimensions}:',
                      style: const TextStyle(fontWeight: FontWeight.bold)),
                  const SizedBox(height: 8.0),
                  Row(
                    children: [
                      Expanded(
                        child: EditableNumberField(
                          label: l10n.width,
                          value: width,
                          suffix: 'mm',
                          min: 10,
                          max: 1000,
                          onChanged: (value) => _updateWidth(value.toString()),
                        ),
                      ),
                      const SizedBox(width: 8.0),
                      Expanded(
                        child: EditableNumberField(
                          label: l10n.height,
                          value: height,
                          suffix: 'mm',
                          min: 10,
                          max: 1000,
                          onChanged: (value) => _updateHeight(value.toString()),
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 16.0),

                  // DPIËÆæÁΩÆ
                  Text('${l10n.ppiSetting}:',
                      style: const TextStyle(fontWeight: FontWeight.bold)),
                  const SizedBox(height: 8.0),
                  Row(
                    children: [
                      Expanded(
                        flex: 3,
                        child: Slider(
                          value: dpi.toDouble(),
                          min: 72,
                          max: 600,
                          divisions: 528, // 600-72 divisions
                          label: '${dpi.toString()} DPI',
                          activeColor: colorScheme.primary,
                          thumbColor: colorScheme.primary,
                          onChangeStart: (value) {
                            // ÊãñÂä®ÂºÄÂßãÊó∂‰øùÂ≠òÂéüÂßãÂÄº
                            _originalDpiValue = dpi;
                          },
                          onChanged: (value) {
                            // ÊãñÂä®ËøáÁ®ã‰∏≠Âè™Êõ¥Êñ∞UIÈ¢ÑËßàÔºå‰∏çËÆ∞ÂΩïundo
                            _updateDpiPreview(value.toInt().toString());
                          },
                          onChangeEnd: (value) {
                            // ÊãñÂä®ÁªìÊùüÊó∂Âü∫‰∫éÂéüÂßãÂÄºËÆ∞ÂΩïundo
                            _updateDpiWithUndo(value.toInt());
                          },
                        ),
                      ),
                      const SizedBox(width: 8.0),
                      Expanded(
                        flex: 2,
                        child: EditableNumberField(
                          label: 'PPI',
                          value: dpi.toDouble(),
                          suffix: '',
                          min: 72,
                          max: 600,
                          decimalPlaces: 0,
                          onChanged: (value) =>
                              _updateDpi(value.toInt().toString()),
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 8.0),

                  // ÂÉèÁ¥†Â∞∫ÂØ∏ÊòæÁ§∫
                  Container(
                    padding: const EdgeInsets.all(12.0),
                    decoration: BoxDecoration(
                      color:
                          colorScheme.tertiaryContainer.withValues(alpha: 0.3),
                      borderRadius: BorderRadius.circular(8.0),
                    ),
                    child: Row(
                      children: [
                        Icon(Icons.info_outline,
                            color: colorScheme.tertiary, size: 20),
                        const SizedBox(width: 8),
                        Expanded(
                          child: Text(
                            '${l10n.canvasPixelSize}: ${_calculatePixelSize(width, height, dpi)}',
                            style: TextStyle(
                                fontSize: 14, color: colorScheme.tertiary),
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),

        // ËÉåÊôØÈ¢úËâ≤ËÆæÁΩÆ
        M3PanelStyles.buildPersistentPanelCard(
          context: context,
          panelId: 'page_background_color',
          title: l10n.backgroundColor,
          defaultExpanded: true,
          children: [
            Padding(
              padding:
                  const EdgeInsets.symmetric(horizontal: 16.0, vertical: 8.0),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    children: [
                      InkWell(
                        onTap: () async {
                          final color = await M3ColorPicker.show(
                            context,
                            initialColor: _getBackgroundColor(),
                            enableAlpha: false,
                          );
                          if (color != null) {
                            _updateBackgroundColor(color);
                          }
                        },
                        child: Container(
                          width: 40,
                          height: 40,
                          decoration: BoxDecoration(
                            color: _getBackgroundColor(),
                            border: Border.all(color: colorScheme.outline),
                            borderRadius: BorderRadius.circular(8),
                          ),
                        ),
                      ),
                      const SizedBox(width: 16),
                      Text(
                        l10n.backgroundColor,
                        style: TextStyle(
                          color: colorScheme.onSurface,
                        ),
                      ),
                    ],
                  ),
                ],
              ),
            ),
          ],
        ),

        // ÁΩëÊ†ºËÆæÁΩÆ
        M3PanelStyles.buildPersistentPanelCard(
          context: context,
          panelId: 'page_grid_settings',
          title: l10n.gridSettings,
          defaultExpanded: true,
          children: [
            Padding(
              padding:
                  const EdgeInsets.symmetric(horizontal: 16.0, vertical: 8.0),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // ÊòæÁ§∫ÁΩëÊ†ºÈÄâÈ°π
                  Card(
                    elevation: 0,
                    color: colorScheme.surfaceContainerHighest,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12.0),
                    ),
                    child: SwitchListTile(
                      title: Text(l10n.showGrid),
                      value: widget.controller.state.gridVisible,
                      activeColor: colorScheme.primary,
                      onChanged: (value) {
                        // Êõ¥Êñ∞È°µÈù¢Â±ûÊÄß
                        widget.onPagePropertiesChanged({'gridVisible': value});
                        // ÂêåÊ≠•Êõ¥Êñ∞ÊéßÂà∂Âô®ÁöÑÁΩëÊ†ºÊòæÁ§∫Áä∂ÊÄÅ
                        widget.controller.state.gridVisible = value;
                        // ‰∏çÁõ¥Êé•Ë∞ÉÁî® notifyListenersÔºåËÄåÊòØÈÄöËøáÂ±ûÊÄßÊõ¥Êñ∞Ëß¶ÂèëÊéßÂà∂Âô®ÁöÑÊõ¥Êñ∞
                        setState(() {});
                      },
                    ),
                  ),
                  const SizedBox(height: 16.0),

                  // ÁΩëÊ†ºÂ§ßÂ∞èËÆæÁΩÆ
                  Text('${l10n.gridSize}:',
                      style: const TextStyle(fontWeight: FontWeight.bold)),
                  const SizedBox(height: 8.0),
                  Row(
                    children: [
                      Expanded(
                        flex: 3,
                        child: Slider(
                          value: widget.controller.state.gridSize,
                          min: 5.0,
                          max: 500.0,
                          divisions: 99,
                          label: widget.controller.state.gridSize
                              .toStringAsFixed(0),
                          activeColor: colorScheme.primary,
                          thumbColor: colorScheme.primary,
                          onChangeStart: (value) {
                            // üöÄ ÊñπÊ°àBÔºöÊãñÂä®ÂºÄÂßãÊó∂‰øùÂ≠òÂéüÂßãÂÄº
                            _originalGridSize = widget.controller.state.gridSize;
                            EditPageLogger.propertyPanelDebug(
                              'ÁΩëÊ†ºÂ§ßÂ∞èÊãñÂä®ÂºÄÂßã',
                              tag: EditPageLoggingConfig.tagEditPage,
                              data: {
                                'originalGridSize': _originalGridSize,
                                'operation': 'grid_size_drag_start',
                              },
                            );
                          },
                          onChanged: (value) {
                            // üöÄ ÊñπÊ°àBÔºöÈ¢ÑËßàÊõ¥Êñ∞Ôºå‰∏çËÆ∞ÂΩïundo
                            setState(() {
                              // Êõ¥Êñ∞È°µÈù¢Â±ûÊÄß
                              widget
                                  .onPagePropertiesChanged({'gridSize': value});
                              // ÂêåÊ≠•Êõ¥Êñ∞ÊéßÂà∂Âô®ÁöÑÁΩëÊ†ºÂ§ßÂ∞è
                              widget.controller.state.gridSize = value;
                              // ‰∏çÁõ¥Êé•Ë∞ÉÁî® notifyListenersÔºåËÄåÊòØÈÄöËøáÂ±ûÊÄßÊõ¥Êñ∞Ëß¶ÂèëÊéßÂà∂Âô®ÁöÑÊõ¥Êñ∞
                            });
                          },
                          onChangeEnd: (value) {
                            // üöÄ ÊñπÊ°àBÔºöÊãñÂä®ÁªìÊùüÊó∂Âü∫‰∫éÂéüÂßãÂÄºËÆ∞ÂΩïundo
                            if (_originalGridSize != null && _originalGridSize != value) {
                              EditPageLogger.propertyPanelDebug(
                                'ÁΩëÊ†ºÂ§ßÂ∞èundo‰ºòÂåñÊõ¥Êñ∞',
                                tag: EditPageLoggingConfig.tagEditPage,
                                data: {
                                  'originalValue': _originalGridSize,
                                  'newValue': value,
                                  'operation': 'grid_size_undo_optimized_update',
                                },
                              );
                              // Â∑≤ÁªèÂú®onChanged‰∏≠Êõ¥Êñ∞‰∫ÜÔºåËøôÈáåÂè™ËÆ∞ÂΩïÊó•ÂøóÂç≥ÂèØ
                            }
                            // Ê∏ÖÁ©∫ÂéüÂßãÂÄº
                            _originalGridSize = null;
                          },
                        ),
                      ),
                      const SizedBox(width: 8.0),
                      Expanded(
                        flex: 1,
                        child: Text(
                          '${widget.controller.state.gridSize.toStringAsFixed(0)} ${l10n.pixels}',
                          style: TextStyle(
                            fontWeight: FontWeight.bold,
                            color: colorScheme.onSurface,
                          ),
                          textAlign: TextAlign.center,
                        ),
                      ),
                    ],
                  ),
                ],
              ),
            ),
          ],
        ),
      ],
    );
  }

  @override
  void didUpdateWidget(M3PagePropertyPanel oldWidget) {
    super.didUpdateWidget(oldWidget);
    // ÂΩìÈ°µÈù¢Â±ûÊÄßÊõ¥Êñ∞Êó∂ÔºåÊõ¥Êñ∞ËæìÂÖ•Ê°ÜÁöÑÂÄº
    if (widget.page != null && oldWidget.page != widget.page) {
      _widthController.text =
          ((widget.page!['width'] as num?)?.toDouble() ?? 210.0).toString();
      _heightController.text =
          ((widget.page!['height'] as num?)?.toDouble() ?? 297.0).toString();
      _dpiController.text =
          ((widget.page!['dpi'] as num?)?.toInt() ?? 300).toString();

      // Êõ¥Êñ∞ËÉåÊôØÈ¢úËâ≤ÊéßÂà∂Âô® - ‰ΩøÁî®Êñ∞Ê†ºÂºè
      String backgroundColor = '#FFFFFF';
      if (widget.page!.containsKey('background') &&
          (widget.page!['background'] as Map<String, dynamic>)
              .containsKey('value')) {
        backgroundColor = (widget.page!['background']
            as Map<String, dynamic>)['value'] as String;
      }
      _backgroundColorController.text = backgroundColor.startsWith('#')
          ? backgroundColor.substring(1)
          : backgroundColor;
    }
  }

  @override
  void dispose() {
    // ÁßªÈô§ÁÑ¶ÁÇπÁõëÂê¨Âô®
    _widthFocusNode.removeListener(_handleWidthFocusChange);
    _heightFocusNode.removeListener(_handleHeightFocusChange);
    _dpiFocusNode.removeListener(_handleDpiFocusChange);

    // ÁßªÈô§ÊéßÂà∂Âô®ÁõëÂê¨Âô®
    widget.controller.removeListener(_handleControllerChange);

    // ÈáäÊîæÊéßÂà∂Âô®
    _widthController.dispose();
    _heightController.dispose();
    _dpiController.dispose();
    _backgroundColorController.dispose();

    // ÈáäÊîæÁÑ¶ÁÇπËäÇÁÇπ
    _widthFocusNode.dispose();
    _heightFocusNode.dispose();
    _dpiFocusNode.dispose();

    super.dispose();
  }

  @override
  void initState() {
    super.initState();
    // ÂàùÂßãÂåñÊéßÂà∂Âô®
    _widthController = TextEditingController();
    _heightController = TextEditingController();
    _dpiController = TextEditingController();
    _backgroundColorController = TextEditingController();

    // ÂàùÂßãÂåñÁÑ¶ÁÇπËäÇÁÇπ
    _widthFocusNode = FocusNode();
    _heightFocusNode = FocusNode();
    _dpiFocusNode = FocusNode();

    // ËÆæÁΩÆÂàùÂßãÂÄº
    if (widget.page != null) {
      _widthController.text =
          ((widget.page!['width'] as num?)?.toDouble() ?? 210.0).toString();
      _heightController.text =
          ((widget.page!['height'] as num?)?.toDouble() ?? 297.0).toString();

      // ËÆæÁΩÆDPIÂàùÂßãÂÄº - 300 DPIÊòØÂç∞Âà∑ÂìÅÁöÑË°å‰∏öÊ†áÂáÜÔºåÈÄÇÂêàÂ§ßÂ§öÊï∞È´òË¥®ÈáèÊâìÂç∞ÈúÄÊ±Ç
      _dpiController.text =
          ((widget.page!['dpi'] as num?)?.toInt() ?? 300).toString();

      // ËÆæÁΩÆËÉåÊôØÈ¢úËâ≤ÂàùÂßãÂÄº - ‰ΩøÁî®Êñ∞Ê†ºÂºè
      String backgroundColor = '#FFFFFF';
      if (widget.page!.containsKey('background') &&
          (widget.page!['background'] as Map<String, dynamic>)
              .containsKey('value')) {
        backgroundColor = (widget.page!['background']
            as Map<String, dynamic>)['value'] as String;
      }
      _backgroundColorController.text = backgroundColor.startsWith('#')
          ? backgroundColor.substring(1)
          : backgroundColor;
    }

    // Ê∑ªÂä†ÁÑ¶ÁÇπÁõëÂê¨Âô®
    _widthFocusNode.addListener(_handleWidthFocusChange);
    _heightFocusNode.addListener(_handleHeightFocusChange);
    _dpiFocusNode.addListener(_handleDpiFocusChange);

    // ÁõëÂê¨ÊéßÂà∂Âô®Áä∂ÊÄÅÂèòÂåñÔºåÁî®‰∫éÂêåÊ≠•ÁΩëÊ†ºÁä∂ÊÄÅ
    widget.controller.addListener(_handleControllerChange);
  }

  /// ËÆ°ÁÆóÂÉèÁ¥†Â∞∫ÂØ∏
  String _calculatePixelSize(double width, double height, int dpi) {
    // ÊØ´Á±≥ËΩ¨Ëã±ÂØ∏Ôºå1Ëã±ÂØ∏ = 25.4ÊØ´Á±≥
    final widthInches = width / 25.4;
    final heightInches = height / 25.4;

    // ËÆ°ÁÆóÂÉèÁ¥†Â∞∫ÂØ∏
    final widthPixels = (widthInches * dpi).round();
    final heightPixels = (heightInches * dpi).round();

    return '$widthPixels √ó $heightPixels ${AppLocalizations.of(context).pixels}';
  }

  /// Ëé∑ÂèñËÉåÊôØÈ¢úËâ≤
  Color _getBackgroundColor() {
    if (widget.page == null) {
      return Colors.white;
    }

    // ‰ΩøÁî®Êñ∞Ê†ºÂºè
    if (widget.page!.containsKey('background') &&
        (widget.page!['background'] as Map<String, dynamic>)
            .containsKey('value')) {
      final background = widget.page!['background'] as Map<String, dynamic>;
      final colorStr = background['value'] as String;

      final color =
          Color(int.parse(colorStr.substring(1), radix: 16) | 0xFF000000);

      return color;
    }

    // ÈªòËÆ§ÁôΩËâ≤

    return Colors.white;
  }

  /// Ëé∑ÂèñÈ°µÈù¢Â∞∫ÂØ∏È¢ÑËÆæ
  String _getPageSizePreset(double width, double height) {
    double portraitWidth = width;
    double portraitHeight = height;

    // Á°Æ‰øùÊØîËæÉÊó∂‰ΩøÁî®Á∫µÂêëÂ∞∫ÂØ∏
    if (width > height) {
      portraitWidth = height;
      portraitHeight = width;
    }

    // ‰ΩøÁî®ÊØ´Á±≥Âçï‰ΩçËøõË°åÊØîËæÉ
    if ((portraitWidth - 210.0).abs() < 1 &&
        (portraitHeight - 297.0).abs() < 1) {
      return 'A4';
    } else if ((portraitWidth - 148.0).abs() < 1 &&
        (portraitHeight - 210.0).abs() < 1) {
      return 'A5';
    } else if ((portraitWidth - 297.0).abs() < 1 &&
        (portraitHeight - 420.0).abs() < 1) {
      return 'A3';
    } else if ((portraitWidth - 329.0).abs() < 2 &&
        (portraitHeight - 483.0).abs() < 2) {
      // A3+ ÂÖÅËÆ∏Êõ¥Â§ßËØØÂ∑Æ
      return 'A3_PLUS';
    } else if ((portraitWidth - 353.0).abs() < 1 &&
        (portraitHeight - 500.0).abs() < 1) {
      return 'B3';
    } else if ((portraitWidth - 250.0).abs() < 1 &&
        (portraitHeight - 353.0).abs() < 1) {
      return 'B4';
    } else if ((portraitWidth - 176.0).abs() < 1 &&
        (portraitHeight - 250.0).abs() < 1) {
      return 'B5';
    } else if ((portraitWidth - 125.0).abs() < 1 &&
        (portraitHeight - 176.0).abs() < 1) {
      return 'B6';
    } else if ((portraitWidth - 114.0).abs() < 1 &&
        (portraitHeight - 162.0).abs() < 1) {
      return 'C6';
    } else if ((portraitWidth - 185.0).abs() < 2 &&
        (portraitHeight - 260.0).abs() < 2) {
      return 'K_16';
    } else if ((portraitWidth - 130.0).abs() < 2 &&
        (portraitHeight - 185.0).abs() < 2) {
      return 'K_32';
    } else if ((portraitWidth - 140.0).abs() < 2 &&
        (portraitHeight - 203.0).abs() < 2) {
      return 'K_32_LARGE';
    } else if ((portraitWidth - 260.0).abs() < 3 &&
        (portraitHeight - 370.0).abs() < 3) {
      return 'K_8K';
    } else if ((portraitWidth - 195.0).abs() < 2 &&
        (portraitHeight - 270.0).abs() < 2) {
      return 'K_16K';
    } else {
      return 'custom';
    }
  }

  // Â§ÑÁêÜÊéßÂà∂Âô®Áä∂ÊÄÅÂèòÂåñ
  void _handleControllerChange() {
    // Âè™Âú®ÊéßÂà∂Âô®ÁöÑÁΩëÊ†ºÁä∂ÊÄÅÂèòÂåñÊó∂ÈáçÂª∫UI
    setState(() {});
  }

  /// Â§ÑÁêÜDPIÁÑ¶ÁÇπÂèòÂåñ
  void _handleDpiFocusChange() {
    if (!_dpiFocusNode.hasFocus) {
      _updateDpi(_dpiController.text);
    }
  }

  /// Â§ÑÁêÜÈ´òÂ∫¶ÁÑ¶ÁÇπÂèòÂåñ
  void _handleHeightFocusChange() {
    if (!_heightFocusNode.hasFocus) {
      _updateHeight(_heightController.text);
    }
  }

  /// Â§ÑÁêÜÈ°µÈù¢Â∞∫ÂØ∏È¢ÑËÆæÂèòÊõ¥
  void _handlePageSizePresetChange(String preset, String orientation) {
    double width, height;

    switch (preset) {
      case 'A4':
        width = 210.0; // A4 width in mm
        height = 297.0; // A4 height in mm
        break;
      case 'A5':
        width = 148.0; // A5 width in mm
        height = 210.0; // A5 height in mm
        break;
      case 'A3':
        width = 297.0;
        height = 420.0;
        break;
      case 'A3_PLUS':
        width = 329.0; // Â∏∏ËßÅ A3+ Â∞∫ÂØ∏ (13x19 Ëã±ÂØ∏ ‚âà 329√ó483mm)
        height = 483.0;
        break;
      case 'B3':
        width = 353.0;
        height = 500.0;
        break;
      case 'B4':
        width = 250.0;
        height = 353.0;
        break;
      case 'B5':
        width = 176.0;
        height = 250.0;
        break;
      case 'B6':
        width = 125.0;
        height = 176.0;
        break;
      case 'C6':
        width = 114.0;
        height = 162.0;
        break;
      case 'K_16':
        width = 185.0; // 16ÂºÄÔºàËøë‰ººÂÄºÔºâ
        height = 260.0;
        break;
      case 'K_32':
        width = 130.0; // 32ÂºÄÔºàËøë‰ººÂÄºÔºâ
        height = 185.0;
        break;
      case 'K_32_LARGE':
        width = 140.0; // Â§ß32ÂºÄÔºàËøë‰ººÂÄºÔºâ
        height = 203.0;
        break;
      case 'K_8K':
        width = 260.0; // 8KÔºàËøë‰ººÂÄºÔºâ
        height = 370.0;
        break;
      case 'K_16K':
        width = 195.0; // 16KÔºàËøë‰ººÂÄºÔºâ
        height = 270.0;
        break;
      case 'custom':
        // ‰∏çÂÅö‰ªª‰ΩïÊìç‰ΩúÔºåËÆ©Áî®Êà∑Ëá™Ë°åËæìÂÖ•
        return;
      default:
        return;
    }

    // Ê†πÊçÆÊñπÂêëË∞ÉÊï¥ÂÆΩÈ´ò
    if (orientation == 'landscape') {
      // Ê®™ÂêëÊó∂‰∫§Êç¢ÂÆΩÈ´ò
      final temp = width;
      width = height;
      height = temp;
    }

    // Êõ¥Êñ∞ÊéßÂà∂Âô®ÁöÑÂÄº
    _widthController.text = width.toString();
    _heightController.text = height.toString();

    // ‰∏ÄÊ¨°ÊÄßÊõ¥Êñ∞ÊâÄÊúâÂ±ûÊÄß
    widget.onPagePropertiesChanged({
      'width': width,
      'height': height,
    });
  }

  /// Â§ÑÁêÜÂÆΩÂ∫¶ÁÑ¶ÁÇπÂèòÂåñ
  void _handleWidthFocusChange() {
    if (!_widthFocusNode.hasFocus) {
      _updateWidth(_widthController.text);
    }
  }

  /// Êõ¥Êñ∞ËÉåÊôØÈ¢úËâ≤
  void _updateBackgroundColor(Color color) {
    // üîß ‰øÆÂ§çÔºö‰ΩøÁî®Ê≠£Á°ÆÁöÑRGBÂ±ûÊÄßÔºà0-255Êï¥Êï∞Ôºâ
    final colorHex =
        '#${(color.r * 255).round().toRadixString(16).padLeft(2, '0')}${(color.g * 255).round().toRadixString(16).padLeft(2, '0')}${(color.b * 255).round().toRadixString(16).padLeft(2, '0')}';

    EditPageLogger.propertyPanelDebug(
      'Êõ¥Êñ∞È°µÈù¢ËÉåÊôØÈ¢úËâ≤',
      tag: EditPageLoggingConfig.tagTextPanel,
      data: {
        'inputColor': color.toString(),
        'outputColorHex': colorHex,
        'red': (color.r * 255).round(),
        'green': (color.g * 255).round(),
        'blue': (color.b * 255).round(),
        'operation': 'update_background_color',
      },
    );

    // ‰ΩøÁî®Êñ∞Ê†ºÂºè
    final background = {
      'type': 'color',
      'value': colorHex,
      'opacity': 1.0,
    };

    widget.onPagePropertiesChanged({'background': background});
  }

  /// Êõ¥Êñ∞DPI
  void _updateDpi(String value) {
    final newValue = int.tryParse(value);
    if (newValue != null && newValue > 0) {
      widget.onPagePropertiesChanged({'dpi': newValue});
    } else {
      // Â¶ÇÊûúËæìÂÖ•Êó†ÊïàÔºåÊÅ¢Â§çÂéüÊù•ÁöÑÂÄº
      if (widget.page != null) {
        _dpiController.text =
            ((widget.page!['dpi'] as num?)?.toInt() ?? 300).toString();
      }
    }
  }

  // Êõ¥Êñ∞È´òÂ∫¶ÔºàÊØ´Á±≥Ôºâ
  void _updateHeight(String value) {
    final newValue = double.tryParse(value);
    if (newValue != null && newValue > 0) {
      widget.onPagePropertiesChanged({'height': newValue});
    } else {
      // Â¶ÇÊûúËæìÂÖ•Êó†ÊïàÔºåÊÅ¢Â§çÂéüÊù•ÁöÑÂÄº
      if (widget.page != null) {
        _heightController.text =
            ((widget.page!['height'] as num?)?.toDouble() ?? 297.0).toString();
      }
    }
  }

  // Êõ¥Êñ∞ÂÆΩÂ∫¶ÔºàÊØ´Á±≥Ôºâ
  void _updateWidth(String value) {
    final newValue = double.tryParse(value);
    if (newValue != null && newValue > 0) {
      widget.onPagePropertiesChanged({'width': newValue});
    } else {
      // Â¶ÇÊûúËæìÂÖ•Êó†ÊïàÔºåÊÅ¢Â§çÂéüÊù•ÁöÑÂÄº
      if (widget.page != null) {
        _widthController.text =
            ((widget.page!['width'] as num?)?.toDouble() ?? 210.0).toString();
      }
    }
  }

  /// ‰ªÖÈ¢ÑËßàÊõ¥Êñ∞DPIÔºå‰∏çËÆ∞ÂΩïundoÔºàÁî®‰∫éÊªëÂùóÊãñÂä®ËøáÁ®ã‰∏≠ÁöÑÂÆûÊó∂È¢ÑËßàÔºâ
  void _updateDpiPreview(String value) {
    final newValue = int.tryParse(value);
    if (newValue != null && newValue >= 72 && newValue <= 600) {
      // ‰∏¥Êó∂Á¶ÅÁî®undoËÆ∞ÂΩï
      widget.controller.undoRedoManager.undoEnabled = false;
      
      // ÂÆûÈôÖÊõ¥Êñ∞È°µÈù¢Â±ûÊÄß‰ª•ÂÆûÁé∞ÂÆûÊó∂È¢ÑËßà
      widget.onPagePropertiesChanged({'dpi': newValue});
      
      // ÈáçÊñ∞ÂêØÁî®undoËÆ∞ÂΩï
      widget.controller.undoRedoManager.undoEnabled = true;
    }
  }

  /// Âü∫‰∫éÂéüÂßãÂÄºÊõ¥Êñ∞DPIÂπ∂ËÆ∞ÂΩïundoÊìç‰ΩúÔºàÁî®‰∫éÊªëÂùóÊãñÂä®ÁªìÊùüÔºâ
  void _updateDpiWithUndo(int newValue) {
    if (_originalDpiValue != null && _originalDpiValue != newValue) {
      // ‰∏¥Êó∂Á¶ÅÁî®undoÔºåÂÖàÊÅ¢Â§çÂà∞ÂéüÂßãÂÄº
      widget.controller.undoRedoManager.undoEnabled = false;
      widget.onPagePropertiesChanged({'dpi': _originalDpiValue!});
      
      // ÈáçÊñ∞ÂêØÁî®undoÔºåÁÑ∂ÂêéÊõ¥Êñ∞Âà∞Êñ∞ÂÄºÔºàËøô‰ºöËÆ∞ÂΩï‰∏ÄÊ¨°‰ªéÂéüÂßãÂÄºÂà∞Êñ∞ÂÄºÁöÑundoÔºâ
      widget.controller.undoRedoManager.undoEnabled = true;
      widget.onPagePropertiesChanged({'dpi': newValue});
    }
    
    // Ê∏ÖÈô§‰øùÂ≠òÁöÑÂéüÂßãÂÄº
    _originalDpiValue = null;
  }
}
