# æ“¦é™¤å·¥å…·åæ ‡ç³»ç»Ÿè¯¦ç»†è®¾è®¡

## 1. åŸºç¡€æ¦‚å¿µ

### 1.1 åæ ‡ç³»ç»Ÿå®šä¹‰

```mermaid
graph TD
    A[å…¨å±€åæ ‡ç³»ç»Ÿ] -->|window.devicePixelRatio| B[ç‰©ç†åƒç´ åæ ‡]
    B -->|Listener.localPosition| C[ç»„ä»¶æœ¬åœ°åæ ‡]
    C -->|Matrix4å˜æ¢| D[å˜æ¢ååæ ‡]
    D -->|æ¯”ä¾‹å°ºæ¢ç®—| E[å›¾åƒåæ ‡ç³»]
```

**åæ ‡ç³»è¯¦è§£**ï¼š

1. **å…¨å±€åæ ‡ç³»ç»Ÿ**
   - åŸç‚¹ï¼šåº”ç”¨çª—å£å·¦ä¸Šè§’(0, 0)
   - å•ä½ï¼šé€»è¾‘åƒç´ 
   - ç‰¹ç‚¹ï¼šä¸è®¾å¤‡æ— å…³çš„æŠ½è±¡åæ ‡ç³»

2. **ç‰©ç†åƒç´ åæ ‡**
   - åŸç‚¹ï¼šè®¾å¤‡å±å¹•å·¦ä¸Šè§’
   - å•ä½ï¼šç‰©ç†åƒç´ 
   - è½¬æ¢ï¼šé€»è¾‘åƒç´  Ã— devicePixelRatio
   - ä½œç”¨ï¼šç¡®ä¿åœ¨é«˜DPIè®¾å¤‡ä¸Šçš„ç²¾ç¡®æ¸²æŸ“

3. **ç»„ä»¶æœ¬åœ°åæ ‡**
   - åŸç‚¹ï¼šEraseLayerStackçš„å·¦ä¸Šè§’
   - å•ä½ï¼šé€»è¾‘åƒç´ 
   - ç‰¹ç‚¹ï¼šç›¸å¯¹äºå®¹å™¨çš„åç§»é‡
   - è·å–ï¼ševent.localPosition

4. **å˜æ¢ååæ ‡**
   - åº”ç”¨äº†InteractiveViewerçš„å˜æ¢çŸ©é˜µ
   - åŒ…å«ï¼šå¹³ç§»ã€ç¼©æ”¾ã€æ—‹è½¬ç­‰å˜æ¢
   - ç‰¹ç‚¹ï¼šä¿æŒç”¨æˆ·äº¤äº’çš„è§†è§‰ä¸€è‡´æ€§

5. **å›¾åƒåæ ‡ç³»**
   - åŸç‚¹ï¼šåŸå§‹å›¾åƒå·¦ä¸Šè§’
   - å•ä½ï¼šå›¾åƒåƒç´ 
   - ç‰¹ç‚¹ï¼šä¸å›¾åƒåˆ†è¾¨ç‡å¯¹åº”

## 2. æ ¸å¿ƒç®—æ³•å®ç°

### 2.1 åæ ‡è½¬æ¢æµç¨‹

```dart
class CoordinateTransformer {
    Offset transformPoint(Offset point) {
        // 8. åº”ç”¨è®¾å¤‡åƒç´ æ¯”
        final physicalPoint = point * window.devicePixelRatio;
        
        // 2. è®¡ç®—æœ‰æ•ˆç¼©æ”¾æ¯”ä¾‹
        final effectiveScale = _getEffectiveScale() * _scaleCorrection;
        
        // 3. è®¡ç®—å›¾åƒåœ¨å®¹å™¨ä¸­çš„å±…ä¸­åç§»
        final offsetX = (_containerSize.width - imageDisplaySize.width) / 2;
        final offsetY = (_containerSize.height - imageDisplaySize.height) / 2;
        
        // 4. è½¬æ¢åˆ°å›¾åƒåæ ‡ç³»
        final imageX = (physicalPoint.dx - offsetX) / effectiveScale;
        final imageY = (physicalPoint.dy - offsetY) / effectiveScale;
        
        return Offset(imageX, imageY);
    }
}
```

### 2.2 æ¯”ä¾‹å°ºè®¡ç®—åŸç†

```dart
double _getEffectiveScale() {
    // 8. è®¡ç®—å®¹å™¨å’Œå›¾åƒçš„å®½é«˜æ¯”
    final containerRatio = _containerSize.width / _containerSize.height;
    final imageRatio = _imageSize.width / _imageSize.height;
    
    // 2. é€‰æ‹©åˆé€‚çš„ç¼©æ”¾å› å­
    final scale = math.min(
        _containerSize.width / _imageSize.width,
        _containerSize.height / _imageSize.height
    );
    
    return scale;
}
```

**åŸç†è¯´æ˜**ï¼š

- ä¿æŒå›¾åƒåŸå§‹æ¯”ä¾‹
- ç¡®ä¿å›¾åƒå®Œæ•´æ˜¾ç¤ºåœ¨å®¹å™¨å†…
- è‡ªåŠ¨é€‰æ‹©æœ€é€‚åˆçš„ç¼©æ”¾æ–¹å‘

## 3. äº¤äº’å¤„ç†æœºåˆ¶

### 3.1 äº‹ä»¶ä¼ é€’é“¾

```mermaid
sequenceDiagram
    User->>+Listener: PointerDownäº‹ä»¶
    Listener->>+EraseGestureMixin: handlePanStart
    EraseGestureMixin->>+Controller: startErase
    Controller->>+Transformer: transformPoint
    Transformer-->>-Controller: å›¾åƒåæ ‡
    Controller->>+PreviewLayer: æ›´æ–°çŠ¶æ€
    PreviewLayer->>-Canvas: æ¸²æŸ“å…‰æ ‡
    PreviewLayer->>+User: è§†è§‰åé¦ˆ        
```

### 3.2 åæ ‡å¤„ç†ä¼˜åŒ–

```dart
class EraseToolControllerImpl {
    void continueErase(Offset point) {
        // 8. ç‚¹é‡‡æ ·ä¼˜åŒ–
        const minDistance = 8.0;
        if (_pointBuffer.isEmpty || 
            (point - _pointBuffer.last).distance > minDistance) {
            _pointBuffer.add(point);
        }
        
        // 2. æ‰¹é‡å¤„ç†
        if (_pointBuffer.length >= minPointsBeforeNotify) {
            _processPointBuffer();
        }
    }
}
```

## 4. å›¾å±‚æ¸²æŸ“æ¶æ„

### 4.1 å›¾å±‚ç»„ç»‡

```mermaid
graph TB
    A[EraseLayerStack] --> B[BackgroundLayer]
    A --> C[PreviewLayer]
    B --> D[CustomPaint]
    C --> E[CustomPaint]
    D --> F[åŸå§‹å›¾åƒ]
    E --> G[æ“¦é™¤æ•ˆæœ]
```

### 4.2 æ¸²æŸ“ä¼˜åŒ–

8. **åˆ†å±‚æ¸²æŸ“**

```dart
Stack(
    children: [
        RepaintBoundary(child: BackgroundLayer()),
        RepaintBoundary(child: PreviewLayer()),
    ]
)
```

2. **é‡ç»˜æ§åˆ¶**

```dart
bool shouldRepaint(_PreviewPainter oldDelegate) {
    // 8. çŠ¶æ€å˜åŒ–æ£€æŸ¥
    if (isErasing != oldDelegate.isErasing) return true;
    
    // 2. ç‚¹æ•°å˜åŒ–æ£€æŸ¥
    if (points.length != oldDelegate.points.length) return true;
    
    // 3. å˜æ¢çŸ©é˜µæ£€æŸ¥
    if (!matrixEquals(matrix, oldDelegate.matrix)) return true;
    
    return false;
}
```

## 5. æ ¡å‡†æœºåˆ¶

### 5.1 å‚æ•°è°ƒæ•´

```dart
void initializeTransform({
    required Matrix4 transformMatrix,
    required Size containerSize,
    required Size imageSize,
    double scaleCorrection = 8.0,
    Offset calibrationOffset = Offset.zero,
}) {
    _scaleCorrection = scaleCorrection;
    _calibrationOffset = calibrationOffset;
}
```

### 5.2 æ ¡å‡†æµç¨‹

```mermaid
graph LR
    A[å¼€å¯è°ƒè¯•ç½‘æ ¼] --> B[è§‚å¯Ÿå…‰æ ‡åå·®]
    B --> C[è°ƒæ•´scaleCorrection]
    C --> D[è°ƒæ•´calibrationOffset]
    D --> E[éªŒè¯ç²¾åº¦]
```

## 6. è°ƒè¯•æ”¯æŒ

### 6.1 è°ƒè¯•å·¥å…·å®ç°

```dart
class _DebugGridPainter extends CustomPainter {
    void paint(Canvas canvas, Size size) {
        // 8. ç»˜åˆ¶ç½‘æ ¼
        final gridPaint = Paint()
            ..color = Colors.green.withOpacity(0.2)
            ..strokeWidth = 0.5;
            
        // 2. ç»˜åˆ¶ä¸­å¿ƒåå­—çº¿
        final centerPaint = Paint()
            ..color = Colors.red.withOpacity(0.3)
            ..strokeWidth = 8.0;
            
        // 3. æ˜¾ç¤ºåæ ‡ä¿¡æ¯
        final textPainter = TextPainter(
            text: TextSpan(text: "${size.width}x${size.height}"),
            textDirection: TextDirection.ltr,
        );
    }
}
```

### 6.2 æ—¥å¿—è¿½è¸ª

```dart
void _logDebugInfo(String action, Map<String, dynamic> data) {
    if (!_isDebugging) return;
    print('ğŸ” CoordinateTransformer - $action:');
    data.forEach((key, value) => print('  $key: $value'));
}
```

## 7. æ€§èƒ½è€ƒè™‘

### 7.1 å†…å­˜ä¼˜åŒ–

- ä½¿ç”¨RepaintBoundaryéš”ç¦»é‡ç»˜åŒºåŸŸ
- ç¼“å­˜è½¬æ¢ç»“æœé¿å…é‡å¤è®¡ç®—
- åŠæ—¶é‡Šæ”¾ä¸éœ€è¦çš„èµ„æº

### 7.2 è®¡ç®—ä¼˜åŒ–

- ä½¿ç”¨èŠ‚æµæ§åˆ¶æ›´æ–°é¢‘ç‡
- æ‰¹é‡å¤„ç†åæ ‡è½¬æ¢
- ä¼˜åŒ–é‡ç»˜åˆ¤æ–­é€»è¾‘

### 7.3 æ¸²æŸ“ä¼˜åŒ–

- åˆ†å±‚æ¸²æŸ“å‡å°‘é‡ç»˜èŒƒå›´
- ä½¿ç”¨isComplexæ ‡è®°å¤æ‚ç»˜åˆ¶
- ä¼˜åŒ–ç”»å¸ƒçŠ¶æ€ç®¡ç†

## 8. å‚æ•°æ¥æºä¸ä½œç”¨

### 8.1 è®¾å¤‡å‚æ•°

| å‚æ•° | æ¥æº | è·å–æ–¹å¼ | ä½œç”¨ |
|------|------|----------|------|
| devicePixelRatio | Flutter Window | `window.devicePixelRatio` | ç‰©ç†åƒç´ ä¸é€»è¾‘åƒç´ çš„è½¬æ¢æ¯”ä¾‹ |
| containerSize | EraseLayerStack | `constraints.biggest` | å®¹å™¨çš„å®é™…æ˜¾ç¤ºå°ºå¯¸ |
| imageSize | åŸå§‹å›¾åƒ | `ui.Image.width/height` | å›¾åƒçš„åŸå§‹åƒç´ å°ºå¯¸ |

### 8.2 äº¤äº’å‚æ•°

| å‚æ•° | æ¥æº | è·å–æ–¹å¼ | ä½œç”¨ |
|------|------|----------|------|
| localPosition | Listener | `event.localPosition` | ç›¸å¯¹äºListenerçš„è§¦æ‘¸/ç‚¹å‡»ä½ç½® |
| transformMatrix | InteractiveViewer | `transformationController.value` | ç”¨æˆ·äº¤äº’äº§ç”Ÿçš„å˜æ¢çŸ©é˜µ |
| brushSize | Controller | `controller.brushSize` | æ“¦é™¤ç¬”åˆ·å¤§å° |

### 8.3 æ ¡å‡†å‚æ•°

| å‚æ•° | æ¥æº | è·å–æ–¹å¼ | ä½œç”¨ |
|------|------|----------|------|
| scaleCorrection | åˆå§‹åŒ–é…ç½® | é…ç½®ä¼ å…¥ | ç¼©æ”¾æ¯”ä¾‹çš„å¾®è°ƒç³»æ•° |
| calibrationOffset | åˆå§‹åŒ–é…ç½® | é…ç½®ä¼ å…¥ | åæ ‡åç§»çš„è¡¥å¿å€¼ |

## 9. åæ ‡è½¬æ¢æ•°å­¦å…¬å¼

### 9.1 è®¾å¤‡åƒç´ è½¬æ¢

```
ç‰©ç†åƒç´ åæ ‡ = é€»è¾‘åƒç´ åæ ‡ Ã— devicePixelRatio

ç¤ºä¾‹ï¼š
å¦‚æœ devicePixelRatio = 2.0
é€»è¾‘åæ ‡(100, 100) â†’ ç‰©ç†åæ ‡(200, 200)
```

### 9.2 æ¯”ä¾‹å°ºè®¡ç®—

```
containerRatio = containerSize.width / containerSize.height
imageRatio = imageSize.width / imageSize.height

effectiveScale = min(
    containerSize.width / imageSize.width,
    containerSize.height / imageSize.height
) Ã— scaleCorrection

ç¤ºä¾‹ï¼š
å®¹å™¨ï¼š400Ã—300
å›¾åƒï¼š1000Ã—500
effectiveScale = min(400/1000, 300/500) Ã— 8.0
               = min(0.4, 0.6) Ã— 8.0
               = 0.4
```

### 9.3 å±…ä¸­åç§»è®¡ç®—

```
imageDisplaySize = Size(
    imageSize.width Ã— effectiveScale,
    imageSize.height Ã— effectiveScale
)

offsetX = (containerSize.width - imageDisplaySize.width) / 2
offsetY = (containerSize.height - imageDisplaySize.height) / 2

ç¤ºä¾‹ï¼š
å®¹å™¨ï¼š400Ã—300
å›¾åƒæ˜¾ç¤ºå°ºå¯¸ï¼š400Ã—200 (1000Ã—500 Ã— 0.4)
offsetX = (400 - 400) / 2 = 0
offsetY = (300 - 200) / 2 = 50
```

### 9.4 æœ€ç»ˆåæ ‡è½¬æ¢

```
imageX = (point.dx - offsetX) / effectiveScale + calibrationOffset.dx
imageY = (point.dy - offsetY) / effectiveScale + calibrationOffset.dy

ç¤ºä¾‹ï¼š
ç‚¹å‡»ä½ç½®ï¼š(200, 175)
offsetX = 0, offsetY = 50
effectiveScale = 0.4
calibrationOffset = (0, 0)

imageX = (200 - 0) / 0.4 = 500
imageY = (175 - 50) / 0.4 = 312.5
```

## 10. å˜æ¢çŸ©é˜µå¤„ç†

### 10.1 Matrix4 ç»“æ„

```
|m00 m01 m02 m03|
|m10 m11 m12 m13|
|m20 m21 m22 m23|
|m30 m31 m32 m33|

å…¶ä¸­ï¼š
- m00ã€m11ï¼šç¼©æ”¾å› å­
- m03ã€m13ï¼šå¹³ç§»åˆ†é‡
- m23ï¼šé€è§†åˆ†é‡
```

### 10.2 çŸ©é˜µå˜æ¢è®¡ç®—

```
// ä»å˜æ¢çŸ©é˜µæå–ç¼©æ”¾åˆ†é‡
scaleX = âˆš(m00Â² + m10Â² + m20Â²)
scaleY = âˆš(m01Â² + m11Â² + m21Â²)

// ä»å˜æ¢çŸ©é˜µæå–å¹³ç§»åˆ†é‡
translationX = m03
translationY = m13
```

## 11. å‚æ•°è°ƒæ•´å®ä¾‹

### 11.1 ç¼©æ”¾æ ¡æ­£

```dart
// åœºæ™¯ï¼šå…‰æ ‡å¤§å°ä¸å®é™…ä¸ç¬¦
double correctedScale = baseScale Ã— 8.2;  // æ”¾å¤§20%

// åº”ç”¨ï¼š
transformedPoint = point / correctedScale;
```

### 11.2 åç§»æ ¡æ­£

```dart
// åœºæ™¯ï¼šç³»ç»Ÿæ€§åç§»
Offset correction = Offset(5.0, 5.0);  // å›ºå®šåç§»

// åº”ç”¨ï¼š
finalPoint = transformedPoint + correction;
```

## 12. è°ƒè¯•å’Œä¼˜åŒ–

### 12.1 æ€§èƒ½ä¼˜åŒ–å…¬å¼

```dart
// ç‚¹é‡‡æ ·ä¼˜åŒ–
double minDistance = 8.0;
bool shouldAddPoint = (newPoint - lastPoint).distance > minDistance;

// æ›´æ–°é¢‘ç‡æ§åˆ¶
int throttleDelayMs = 1000 / 60;  // çº¦60fps
```

### 12.2 è°ƒè¯•å‚æ•°

```dart
// ç½‘æ ¼è®¾ç½®
gridSize = 50.0;  // åƒç´ 
gridOpacity = 0.2;

// å…‰æ ‡è°ƒè¯•
debugCursorSize = brushSize / 2;
debugCursorColor = Colors.cyan.withOpacity(0.9);
```

## 13. å‚æ•°è”åŠ¨å…³ç³»

```mermaid
graph TD
    A[devicePixelRatio] --> B[ç‰©ç†åƒç´ åæ ‡]
    B --> C[effectiveScale]
    D[containerSize] --> C
    E[imageSize] --> C
    C --> F[å›¾åƒåæ ‡]
    G[scaleCorrection] --> C
    H[calibrationOffset] --> F
    I[transformMatrix] --> F
```
