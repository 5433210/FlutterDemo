# 字符匹配功能调试日志增强报告

## 概述
为了彻底解决 Flutter 集字功能在字符匹配模式下的 segments 分段与候选集字同步问题，我们在关键代码路径中增加了详细的调试日志追踪。这些日志将帮助我们：

1. 追踪每个字符的精确匹配过程
2. 验证中文字符和非中文字符的处理差异
3. 确认占位符设置的时机和条件
4. 监控候选字符选择的完整流程

## 增强的调试日志追踪点

### 1. 搜索查询生成追踪 (`[SEARCH_QUERY_DEBUG]`)

**位置**: `m3_collection_property_panel.dart` -> `_getSearchQuery()`

**追踪内容**:
- 当前选中字符的索引和内容
- 字符的 Unicode 编码和类型判断
- 词匹配/字符匹配模式的查询策略
- Segments 分段匹配情况

**关键数据**:
```dart
{
  'selectedCharIndex': _selectedCharIndex,
  'selectedChar': char,
  'isChineseChar': _isChineseCharacter(char),
  'matchingMode': 'word/character',
  'segmentText': text,  // 仅词匹配模式
}
```

### 2. 字符精确匹配追踪 (`[CHARACTER_EXACT_MATCH]`)

**位置**: `character_service.dart` -> `_searchByCharacters()`

**追踪内容**:
- 单个字符的精确匹配查询
- 字符的 Unicode 编码和中文字符判断
- 数据库查询结果详情
- 匹配到的实体信息

**关键数据**:
```dart
{
  'char': char,
  'charCode': char.codeUnitAt(0),
  'isChineseChar': char.codeUnitAt(0) >= 0x4E00 && char.codeUnitAt(0) <= 0x9FFF,
  'resultCount': results.length,
  'results': [
    {
      'id': entity.id,
      'character': entity.character,
      'pageId': entity.pageId,
    }
  ]
}
```

### 3. 字符匹配模式处理追踪 (`[CHARACTER_MATCHING_DEBUG]`)

**位置**: `m3_collection_property_panel.dart` -> `_handleCharacterMatchingMode()`

**追踪内容**:
- 候选字符的总数和精确匹配数量
- 精确匹配检查的详细过程
- 占位符设置的原因和条件
- 自动选择的决策过程

**关键数据**:
```dart
{
  'searchQuery': searchQuery,
  'isChineseChar': _isChineseCharacter(searchQuery),
  'candidateCount': entities.length,
  'exactMatches': exactMatches.length,
  'allCandidates': entities.take(5).map(...),
  'reasonForPlaceholder': 'no_exact_match_found' | 'no_candidates_found',
}
```

### 4. 候选字符选择追踪 (`[SELECT_CANDIDATE_DEBUG]`)

**位置**: `m3_collection_property_panel.dart` -> `_selectCandidateCharacter()`

**追踪内容**:
- 选择候选字符的完整过程
- 当前字符和候选字符的对比
- 图像格式获取和处理
- 选择操作的成功/失败状态

**关键数据**:
```dart
{
  'selectedCharIndex': _selectedCharIndex,
  'currentChar': currentChar,
  'isChineseChar': _isChineseCharacter(currentChar),
  'candidateId': entity.id,
  'candidateCharacter': entity.character,
  'matchingMode': _matchingMode.toString(),
  'format': format,
}
```

## 测试重点字符类型

我们特别关注以下类型字符的处理：

| 字符 | Unicode | 类型 | 期望行为 |
|------|---------|------|----------|
| "测" | 27979 | 中文 | 精确匹配集字 |
| "试" | 35797 | 中文 | 精确匹配集字 |
| "A" | 65 | 英文 | 无匹配显示占位符 |
| "B" | 66 | 英文 | 无匹配显示占位符 |
| "1" | 49 | 数字 | 无匹配显示占位符 |
| "!" | 33 | 符号 | 无匹配显示占位符 |
| "，" | 65292 | 中文符号 | 无匹配显示占位符 |

## 日志筛选和分析建议

### 1. 查看精确匹配过程
```
搜索: "[CHARACTER_EXACT_MATCH]"
关注: resultCount、isChineseChar、results 字段
```

### 2. 查看匹配模式处理
```
搜索: "[CHARACTER_MATCHING_DEBUG]"
关注: exactMatches、reasonForPlaceholder 字段
```

### 3. 查看选择过程
```
搜索: "[SELECT_CANDIDATE_DEBUG]"
关注: candidateCharacter、format 字段
```

### 4. 查看占位符设置
```
搜索: "无精确匹配" 或 "无候选字符"
关注: 占位符设置的触发条件
```

## 调试验证流程

### 步骤1: 启动应用并准备测试
```bash
flutter run
```

### 步骤2: 创建测试内容
- 创建或打开一个集字元素
- 输入包含多种字符类型的文本: "测试ABC123!"

### 步骤3: 切换到字符匹配模式
- 在属性面板中关闭"词匹配优先"
- 验证界面显示"字符匹配模式"

### 步骤4: 逐字符测试
- 依次点击每个字符
- 观察调试日志输出
- 验证中文字符的精确匹配
- 验证非中文字符的占位符设置

### 步骤5: 切换模式验证
- 切换回词匹配模式
- 验证 segments 重新生成
- 验证数据同步一致性

## 期望的正确日志流程

### 中文字符处理流程
1. `[SEARCH_QUERY_DEBUG]` - 确认字符和模式
2. `[CHARACTER_EXACT_MATCH]` - 查询结果 > 0
3. `[CHARACTER_MATCHING_DEBUG]` - 找到精确匹配
4. `[SELECT_CANDIDATE_DEBUG]` - 自动选择成功

### 非中文字符处理流程
1. `[SEARCH_QUERY_DEBUG]` - 确认字符和模式
2. `[CHARACTER_EXACT_MATCH]` - 查询结果 = 0
3. `[CHARACTER_MATCHING_DEBUG]` - 无精确匹配，设置占位符

## 故障排查指南

### 问题1: 中文字符无法匹配
**检查点**:
- `[CHARACTER_EXACT_MATCH]` 中的 `isChineseChar` 是否为 true
- `resultCount` 是否为 0
- 数据库中是否存在对应字符的记录

### 问题2: 英文字符未设置占位符
**检查点**:
- `[CHARACTER_MATCHING_DEBUG]` 中的 `reasonForPlaceholder`
- 是否正确进入占位符设置分支

### 问题3: 精确匹配检查失败
**检查点**:
- `exactMatches` 数量是否与 `candidateCount` 一致
- 候选字符的 `character` 字段是否与查询字符完全匹配

## 不再使用的测试方式

为了遵循"不在测试脚本中直接操作数据库"的原则，我们：

❌ **不再做的事情**:
- 在测试脚本中直接查询数据库
- 在测试代码中修改数据库记录
- 使用独立的数据库操作脚本

✅ **现在做的事情**:
- 通过应用内日志追踪问题
- 在正常的用户交互中验证功能
- 使用调试日志分析根本原因
- 通过 UI 界面验证数据一致性

## 总结

通过这些增强的调试日志，我们现在可以：

1. **精确定位问题**: 每个字符的处理都有详细的日志追踪
2. **验证修复效果**: 通过日志确认精确匹配和占位符设置的正确性
3. **避免数据库操作**: 所有验证都通过应用界面和日志进行
4. **持续监控**: 后续开发中可以继续使用这些日志追踪功能

这种基于应用内日志的调试方式更加安全可靠，符合生产环境的最佳实践。
