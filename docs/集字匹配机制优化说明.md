# 集字元素匹配机制优化说明

## 概述

本次优化将集字元素的匹配机制从仅支持字符匹配，升级为词匹配优先的智能匹配系统，并提供用户可调节的匹配模式开关。

## 主要改进

### 1. 智能匹配模式

#### 词匹配优先模式（默认）
- **第一步**：尝试精确匹配整个输入文本
- **第二步**：如果无精确匹配，进行智能分词
- **第三步**：分别对每个词段进行精确匹配
- **第四步**：如果词匹配失败，回退到字符匹配

#### 字符匹配模式
- 直接按单个字符进行匹配
- 适合需要精确控制每个字符位置的场景

### 2. 智能分词算法

#### 空格分隔处理
```
输入: "nature 秋"
分词: ["nature", "秋"]
处理: 分别搜索 "nature" 和 "秋" 的精确匹配
```

#### 中英文混合处理
```
输入: "hello世界"
分词: ["hello", "世界"]
处理: 分别处理英文词和中文词
```

#### 复杂文本处理
```
输入: "你好 world 再见"
分词: ["你好", "world", "再见"]
处理: 按词边界智能分段
```

### 3. 字符分配策略

#### 词匹配模式下的分配逻辑

**场景1：完整词匹配**
```
输入: "春风"
找到: 字符实体 {id: "xxx", character: "春风"}
分配: position[0] → "春风"实体, position[1] → 不分配
结果: 第一个位置显示"春风"图像，第二个位置显示原文字
```

**场景2：分词后匹配**
```
输入: "nature 秋"
分词: ["nature", "秋"]
找到: {id: "aaa", character: "nature"}, {id: "bbb", character: "秋"}
分配: position[0] → "nature"实体, position[7] → "秋"实体
结果: 第一个位置显示nature图像，第八个位置显示秋图像
```

**场景3：回退到字符匹配**
```
输入: "你好"
无词匹配，回退到字符匹配
找到: {id: "ccc", character: "你"}, {id: "ddd", character: "好"}
分配: position[0] → "你"实体, position[1] → "好"实体
```

#### 字符匹配模式下的分配逻辑
```
输入: "nature 秋"
逐字符处理: ['n','a','t','u','r','e',' ','秋']
分配: 每个位置分配对应字符的字符实体
```

## 用户界面改进

### 匹配模式开关
- **位置**：内容设置子面板，集字录入区的标题旁边
- **样式**：FilterChip 样式，带有图标提示
- **功能**：实时切换匹配模式，立即重新加载候选字符

### 提示信息
- **词匹配优先**：优先匹配整词，无匹配时回退到字符匹配
- **仅字符匹配**：仅按单个字符进行匹配

## 技术实现

### 1. CharacterService 增强

#### 新增方法
```dart
/// 智能分词搜索 - 处理混合词语的情况
Future<List<CharacterEntity>> _searchWithSmartSegmentation(String query)

/// 分割中英文混合文本
List<String> _segmentMixedText(String text)
```

#### 优化方法
```dart
/// 智能搜索字符 - 词匹配优先，字符匹配回退
Future<List<CharacterViewModel>> searchCharactersWithMode(
  String query, {
  bool wordMatchingPriority = true,
})
```

### 2. 属性面板增强

#### 新增类型
```dart
/// 字符分配信息
class CharacterAssignment

/// 文本分段信息  
class TextSegment
```

#### 新增方法
```dart
/// 应用词匹配模式的字符选择逻辑
Future<void> _applyWordMatchingSelection(CharacterEntity, Map<String, dynamic>)

/// 计算每个字符位置的字符实体分配
Future<List<CharacterAssignment>> _calculateCharacterAssignments(String, CharacterEntity)

/// 分割文本为词段
List<TextSegment> _segmentText(String text)
```

## 使用场景示例

### 场景1：诗词集字
```
输入: "春风十里"
模式: 词匹配优先
结果: 寻找包含"春风十里"的完整字符实体，如果没有则分字处理
效果: 保持诗词的完整性和艺术性
```

### 场景2：中英混合
```
输入: "Happy 新年"
模式: 词匹配优先  
结果: "Happy"作为一个词，"新年"作为一个词
效果: 合适的字体风格匹配
```

### 场景3：精确控制
```
输入: "龙"
模式: 仅字符匹配
结果: 仅搜索单个"龙"字的候选
效果: 用户可以精确选择特定的字体风格
```

## 性能优化

### 1. 缓存机制
- 搜索结果缓存
- 分词结果缓存
- 字符实体格式缓存

### 2. 智能搜索
- 避免重复搜索相同的词段
- 优先使用精确匹配减少模糊搜索
- 按需加载字符图像格式

### 3. 日志记录
- 详细的匹配过程日志
- 性能指标记录
- 错误诊断信息

## 向后兼容性

### 1. 默认行为
- 新功能默认启用词匹配优先模式
- 保持现有API的兼容性
- 渐进式增强用户体验

### 2. 数据迁移
- 现有的集字数据无需迁移
- 自动适配新的匹配逻辑
- 保持数据结构稳定性

## 测试策略

### 1. 单元测试
- 分词算法测试
- 字符分配逻辑测试
- 边界条件测试

### 2. 集成测试
- 端到端匹配流程测试
- UI交互测试
- 性能基准测试

### 3. 用户体验测试
- 不同输入场景测试
- 匹配准确性验证
- 响应速度测试

## 后续优化计划

### 1. 智能推荐
- 基于历史使用记录的智能推荐
- 字体风格一致性建议
- 布局优化建议

### 2. 自定义分词
- 用户自定义词典
- 专业领域词汇支持
- 个性化分词规则

### 3. 高级匹配
- 语义相似度匹配
- 字体风格匹配
- 艺术效果匹配
