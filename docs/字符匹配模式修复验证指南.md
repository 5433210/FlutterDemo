# 字符匹配模式修复验证指南

## 测试步骤

### 1. 准备测试环境

1. 启动应用：`flutter run -d windows --verbose`
2. 进入字帖编辑页面
3. 创建一个包含英文和中文的集字元素，例如："nature好"

### 2. 验证修复前的问题重现

**预期旧问题**（已修复）：
1. 在词匹配模式下，"nature" 被作为整体匹配
2. 切换到字符匹配模式后，UI仍显示词匹配的结果
3. 英文字符 "n"、"a"、"t" 等显示错误的字符图像

### 3. 验证修复后的正确行为

#### 步骤A：词匹配模式测试
1. 在元素中输入文本："nature好"
2. 选择**词匹配模式**
3. 点击预览面板中的字符，查看候选字符

**预期结果**：
- "nature" 作为整体词被搜索
- 如果有匹配，显示对应的字符图像
- 日志显示：`[WORD_MATCHING_DEBUG] 使用词匹配模式`

#### 步骤B：字符匹配模式切换测试
1. 切换到**字符匹配模式**
2. 观察预览面板的变化
3. 点击英文字符（如 "n"）查看候选字符

**预期结果**：
- 预览面板立即刷新，清除词匹配的结果
- 英文字符显示占位符或搜索结果（如果数据库中有）
- 中文字符"好"显示精确匹配结果或占位符

#### 步骤C：日志验证
在切换到字符匹配模式时，应该看到以下关键日志：

```
[CHARACTER_MATCHING_DEBUG] 切换到字符匹配模式，清空现有绑定
[WORD_MATCHING_DEBUG] 匹配模式切换并更新content - characterImagesCleared: true
[CHARACTER_MATCHING_DEBUG] 初始化字符匹配模式
[CHARACTER_MATCHING_DEBUG] 处理字符位置 - hasExistingBinding: false
[CHARACTER_EXACT_MATCH] 单个字符精确搜索结果 - searchChar: n, resultCount: 0
[CHARACTER_MATCHING_DEBUG] 占位符设置完成
```

## 关键验证点

### 1. 状态清理验证

**测试**：在词匹配模式下有绑定，切换到字符匹配模式
**验证**：日志显示 `characterImagesCleared: true`
**确认**：预览面板立即清空之前的词匹配结果

### 2. 字符独立处理验证

**测试**：字符匹配模式下，点击不同位置的字符
**验证**：每个字符独立搜索和显示
**确认**：英文字符没有搜索结果时显示占位符

### 3. UI同步验证

**测试**：快速在两种模式间切换
**验证**：UI立即响应模式变化
**确认**：characterImages 与当前模式保持一致

## 日志筛选技巧

使用以下关键字筛选相关日志：

```bash
# 模式切换相关
grep "CHARACTER_MATCHING_DEBUG\|WORD_MATCHING_DEBUG" logs

# 搜索结果相关  
grep "CHARACTER_EXACT_MATCH\|CHARACTER_SEARCH_DEBUG" logs

# 占位符设置相关
grep "占位符设置\|placeholder" logs

# 状态同步相关
grep "characterImagesCleared\|清空现有绑定" logs
```

## 常见问题排查

### 问题1：切换模式后UI没有变化
**检查**：日志中是否有 `characterImagesCleared: true`
**原因**：可能 setState() 没有被调用
**解决**：检查 _onWordMatchingModeChanged 方法的调用

### 问题2：英文字符仍显示词匹配结果
**检查**：日志中是否有 `清空现有绑定`
**原因**：characterImages 没有被正确清空
**解决**：检查 content['characterImages'] = <String, dynamic>{}; 是否执行

### 问题3：字符匹配模式下没有占位符
**检查**：日志中是否有 `占位符设置完成`
**原因**：_setPlaceholderForCharacter 方法可能失败
**解决**：检查占位符设置的异常日志

## 性能验证

### 切换响应时间
- 模式切换应在 100ms 内完成
- UI 刷新应该流畅，无明显延迟

### 内存使用
- 切换模式时旧的 characterImages 应被正确释放
- 无内存泄漏问题

## 回归测试

确保修复没有影响其他功能：

1. **词匹配模式**：正常工作，分词和搜索无异常
2. **字符选择**：候选字符显示和选择正常
3. **属性面板**：颜色反转、缩放等属性正常
4. **撤销重做**：状态管理无异常
5. **保存加载**：字帖保存和加载无问题

## 验证完成标准

✅ 模式切换时 characterImages 被完全清空  
✅ 字符匹配模式下每个字符独立处理  
✅ 英文字符正确显示占位符（如无匹配）  
✅ 中文字符正确显示匹配结果或占位符  
✅ UI 状态与匹配模式保持同步  
✅ 日志输出正确且便于调试  
✅ 无性能回归和功能异常  

完成以上验证后，字符匹配模式的状态同步修复即为成功。
