# å­—å¸–ç¼–è¾‘å›¾åƒæ•°æ®æ™ºèƒ½ç®¡ç†ç­–ç•¥è®¾è®¡

## æ¦‚è¿°

æœ¬æ–‡æ¡£è®¾è®¡äº†ä¸€å¥—æ™ºèƒ½çš„å›¾åƒæ•°æ®ä¿å­˜å’ŒåŠ è½½ç­–ç•¥ï¼Œæ—¨åœ¨ä¼˜åŒ–å­—å¸–ç¼–è¾‘ç³»ç»Ÿçš„å­˜å‚¨æ•ˆç‡å’Œæ•°æ®å¯é æ€§ã€‚æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š**ç¼–è¾‘æ—¶ä¿æŒå†—ä½™æ•°æ®ä»¥æé«˜æ•ˆç‡ï¼Œä¿å­˜æ—¶åªå­˜å‚¨æœ€ç»ˆç»“æœä»¥ä¼˜åŒ–å­˜å‚¨ï¼ŒåŠ è½½æ—¶æ™ºèƒ½æ¢å¤å®Œæ•´å¤„ç†çŠ¶æ€**ã€‚

## é—®é¢˜åˆ†æ

### å½“å‰é—®é¢˜
1. **å­˜å‚¨å†—ä½™**ï¼šæ•°æ®åº“ä¸­åŒæ—¶å­˜å‚¨åŸå§‹æ•°æ®ã€å˜æ¢æ•°æ®ã€äºŒå€¼åŒ–æ•°æ®ç­‰å¤šä¸ªå‰¯æœ¬
2. **å­˜å‚¨æµªè´¹**ï¼šJSONæ–‡ä»¶åŒ…å«å¤§é‡ä¸­é—´å¤„ç†æ•°æ®ï¼Œå¯¼è‡´æ–‡ä»¶è¿‡å¤§
3. **æ•°æ®ä¾èµ–**ï¼šè¿‡åº¦ä¾èµ–åŸå›¾æ–‡ä»¶ï¼ŒåŸå›¾åˆ é™¤åå­—å¸–æ— æ³•æ­£å¸¸æ˜¾ç¤º
4. **åŠ è½½å¤æ‚**ï¼šç¼ºä¹ç»Ÿä¸€çš„æ•°æ®æ¢å¤ç­–ç•¥

### ä¼˜åŒ–ç›®æ ‡
1. **å­˜å‚¨ä¼˜åŒ–**ï¼šåªä¿å­˜çœŸæ­£éœ€è¦çš„æœ€ç»ˆç»“æœæ•°æ®
2. **ç¾éš¾æ¢å¤**ï¼šå³ä½¿åŸå›¾åˆ é™¤ï¼Œå­—å¸–ä»å¯æ­£å¸¸æ˜¾ç¤ºå’Œç¼–è¾‘
3. **æ™ºèƒ½é€‚é…**ï¼šæ ¹æ®å¤„ç†çŠ¶æ€è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æ•°æ®ä¿å­˜å’ŒåŠ è½½æ–¹æ¡ˆ
4. **ç®€åŒ–å®ç°**ï¼šé‡‡ç”¨å…¨æ–°æ ¼å¼ï¼Œæ— éœ€è€ƒè™‘æ—§æ•°æ®å…¼å®¹æ€§

## è®¾è®¡æ–¹æ¡ˆ

### 1. æ•°æ®åˆ†ç±»ä½“ç³»

#### 1.1 å›¾åƒæ•°æ®ç±»å‹
```typescript
interface ImageDataTypes {
  // å®Œæ•´å°ºå¯¸æ•°æ®ï¼ˆåŸºäºimported.png 10000x1518ï¼‰
  imageUrl: string;           // æ–‡ä»¶è·¯å¾„å¼•ç”¨
  base64ImageData: string;    // Base64ç¼–ç åŸå§‹æ•°æ®
  rawImageData: Uint8List;    // äºŒè¿›åˆ¶åŸå§‹æ•°æ®
  
  // å¤„ç†åå°ºå¯¸æ•°æ®ï¼ˆåŸºäºç”¨æˆ·è£å‰ªåŒºåŸŸï¼‰
  transformedImageData: Uint8List;  // å˜æ¢åæ•°æ®ï¼ˆè£å‰ª+æ—‹è½¬ï¼‰
  binarizedImageData: Uint8List;    // äºŒå€¼åŒ–åæ•°æ®
  
  // æœ€ç»ˆç»“æœæ•°æ®ï¼ˆæ–°å¢ï¼‰
  finalImageData: Uint8List;        // æœ€ç»ˆç»“æœæ•°æ®
  finalImageDataSource: string;     // æ•°æ®æ¥æºæ ‡è¯†
  processingMetadata: Object;       // å¤„ç†å‚æ•°å…ƒæ•°æ®
}
```

#### 1.2 æ•°æ®ä¼˜å…ˆçº§å±‚æ¬¡
```
ä¼˜å…ˆçº§1: äºŒå€¼åŒ–æ•°æ® (binarizedImageData) - æœ€ç»ˆå¤„ç†ç»“æœ
    â†“ åŸºäº
ä¼˜å…ˆçº§2: å˜æ¢æ•°æ® (transformedImageData) - ä¸­é—´å¤„ç†ç»“æœ  
    â†“ åŸºäº
ä¼˜å…ˆçº§3: åŸå§‹æ•°æ® (rawImageData/base64ImageData) - å®Œæ•´å°ºå¯¸
    â†“ åŸºäº  
ä¼˜å…ˆçº§4: æ–‡ä»¶å¼•ç”¨ (imageUrl) - å¤–éƒ¨æ–‡ä»¶
```

### 2. æ™ºèƒ½ä¿å­˜ç­–ç•¥

#### 2.1 ä¿å­˜æ—¶æ•°æ®é€‰æ‹©é€»è¾‘
```dart
class ImageDataSaveStrategy {
  static Map<String, dynamic> prepareImageDataForSave(Map<String, dynamic> content) {
    String? finalResultKey;
    dynamic finalResultData;
    
    // ğŸ¯ æ•°æ®é€‰æ‹©é€»è¾‘
    if (content['isBinarizationEnabled'] == true && 
        content['binarizedImageData'] != null) {
      // åœºæ™¯1ï¼šç”¨æˆ·å¯ç”¨äº†äºŒå€¼åŒ– â†’ ä¿å­˜äºŒå€¼åŒ–ç»“æœ
      finalResultKey = 'binarizedImageData';
      finalResultData = content['binarizedImageData'];
    }
    else if (content['isTransformApplied'] == true && 
             content['transformedImageData'] != null) {
      // åœºæ™¯2ï¼šç”¨æˆ·åšäº†å˜æ¢æ“ä½œ â†’ ä¿å­˜å˜æ¢ç»“æœ
      finalResultKey = 'transformedImageData';
      finalResultData = content['transformedImageData'];
    }
    else if (content['rawImageData'] != null) {
      // åœºæ™¯3ï¼šç”¨æˆ·åªå¯¼å…¥äº†å›¾ç‰‡ â†’ ä¿å­˜åŸå§‹æ•°æ®
      finalResultKey = 'rawImageData';
      finalResultData = content['rawImageData'];
    }
    else if (content['base64ImageData'] != null) {
      // åœºæ™¯4ï¼šå¤‡ç”¨åŸå§‹æ•°æ®
      finalResultKey = 'base64ImageData';
      finalResultData = content['base64ImageData'];
    }
    
    return _buildOptimizedSaveData(finalResultKey, finalResultData, content);
  }
}
```

#### 2.2 ä¿å­˜æ•°æ®ç»“æ„
```json
{
  "content": {
    // ğŸ¯ æœ€ç»ˆç»“æœæ•°æ®ï¼ˆå”¯ä¸€å›¾åƒæ•°æ®ï¼‰
    "finalImageData": "äºŒè¿›åˆ¶å›¾åƒæ•°æ®",
    "finalImageDataSource": "binarizedImageData|transformedImageData|rawImageData|base64ImageData",
    
    // ğŸ“‹ å¤„ç†å‚æ•°å…ƒæ•°æ®ï¼ˆç”¨äºæ¢å¤ç¼–è¾‘èƒ½åŠ›ï¼‰
    "processingMetadata": {
      "hasTransformApplied": true,
      "hasBinarizationApplied": true,
      "originalImageUrl": "file://path/to/imported.png",
      
      // å˜æ¢å‚æ•°ï¼ˆå¦‚æœé€‚ç”¨ï¼‰
      "cropX": 100, "cropY": 50,
      "cropWidth": 800, "cropHeight": 600,
      "rotation": 15,
      
      // äºŒå€¼åŒ–å‚æ•°ï¼ˆå¦‚æœé€‚ç”¨ï¼‰
      "binaryThreshold": 128,
      "isNoiseReductionEnabled": true,
      "noiseReductionLevel": 2,
      
      "savedAt": "2025-01-27T10:30:00.000Z"
    },
    
    // ğŸ¨ UIå‚æ•°ï¼ˆä¿æŒä¸å˜ï¼‰
    "fitMode": "contain",
    "opacity": 1.0,
    "backgroundColor": "transparent"
  }
}
```

### 3. æ™ºèƒ½åŠ è½½ç­–ç•¥

#### 3.1 åŠ è½½æ—¶æ•°æ®æ¢å¤é€»è¾‘
```dart
class ImageDataLoadStrategy {
  static Future<Map<String, dynamic>> restoreImageDataFromSave(
    Map<String, dynamic> savedContent
  ) async {
    
    final finalImageData = savedContent['finalImageData'];
    final dataSource = savedContent['finalImageDataSource'];
    final metadata = savedContent['processingMetadata'];
    
    // ğŸ”„ æ ¹æ®æ•°æ®æ¥æºæ¢å¤åˆ°å¯¹åº”çš„å¤„ç†çŠ¶æ€
    switch (dataSource) {
      case 'binarizedImageData':
        // æ¢å¤ä¸ºäºŒå€¼åŒ–çŠ¶æ€ï¼Œç”¨æˆ·å¯ä»¥è°ƒæ•´äºŒå€¼åŒ–å‚æ•°
        return _restoreBinarizedState(finalImageData, metadata);
        
      case 'transformedImageData':
        // æ¢å¤ä¸ºå˜æ¢çŠ¶æ€ï¼Œç”¨æˆ·å¯ä»¥ç»§ç»­ç¼–è¾‘å˜æ¢å‚æ•°
        return _restoreTransformState(finalImageData, metadata);
        
      case 'rawImageData':
      case 'base64ImageData':
        // æ¢å¤ä¸ºåŸå§‹çŠ¶æ€ï¼Œç”¨æˆ·å¯ä»¥å¼€å§‹å…¨æ–°ç¼–è¾‘
        return _restoreRawState(finalImageData, dataSource, metadata);
    }
  }
}
```

#### 3.2 ä¸åŒçŠ¶æ€çš„æ¢å¤ç­–ç•¥

##### æ¢å¤äºŒå€¼åŒ–çŠ¶æ€
```dart
Map<String, dynamic> _restoreBinarizedState(data, metadata) {
  return {
    // æ•°æ®æ¢å¤
    'binarizedImageData': data,
    'isBinarizationEnabled': true,
    
    // å‚æ•°æ¢å¤
    'binaryThreshold': metadata['binaryThreshold'] ?? 128,
    'isNoiseReductionEnabled': metadata['isNoiseReductionEnabled'] ?? false,
    'noiseReductionLevel': metadata['noiseReductionLevel'] ?? 1,
    
    // ç¼–è¾‘èƒ½åŠ›
    'canAdjustBinarization': true,
    'canRevertToTransform': metadata['hasTransformApplied'] == true,
    'canRevertToOriginal': true,
  };
}
```

##### æ¢å¤å˜æ¢çŠ¶æ€  
```dart
Map<String, dynamic> _restoreTransformState(data, metadata) {
  return {
    // æ•°æ®æ¢å¤
    'transformedImageData': data,
    'isTransformApplied': true,
    
    // å‚æ•°æ¢å¤
    'cropX': metadata['cropX'] ?? 0,
    'cropY': metadata['cropY'] ?? 0,
    'cropWidth': metadata['cropWidth'],
    'cropHeight': metadata['cropHeight'],
    'rotation': metadata['rotation'] ?? 0,
    
    // ç¼–è¾‘èƒ½åŠ›
    'canAdjustTransform': true,
    'canApplyBinarization': true,
    'canRevertToOriginal': true,
  };
}
```

### 4. ç¾éš¾æ¢å¤æœºåˆ¶

#### 4.1 åŸå›¾ä¸¢å¤±å¤„ç†
```dart
Future<void> _tryRestoreOriginalImageUrl(content, metadata) async {
  final originalUrl = metadata?['originalImageUrl'];
  
  if (originalUrl != null) {
    final exists = await File(originalUrl.substring(7)).exists();
    
    if (exists) {
      // âœ… åŸå›¾ä»å­˜åœ¨ï¼šå®Œå…¨æ¢å¤ç¼–è¾‘èƒ½åŠ›
      content['imageUrl'] = originalUrl;
      content['originalImageAvailable'] = true;
      content['canReprocess'] = true;
    } else {
      // âš ï¸ åŸå›¾ä¸¢å¤±ï¼šåŸºäºä¿å­˜ç»“æœæä¾›æœ‰é™ç¼–è¾‘èƒ½åŠ›
      content['originalImageAvailable'] = false;
      content['canReprocess'] = false; // æ— æ³•é‡æ–°å¤„ç†ï¼Œä½†å¯è°ƒæ•´ç°æœ‰ç»“æœ
      content['fallbackMode'] = true;
      
      _showOriginalImageMissingWarning();
    }
  }
}
```

### 5. å­˜å‚¨ä¼˜åŒ–æ•ˆæœ

#### 5.1 æ•°æ®å¤§å°å¯¹æ¯”
```
åŸå§‹æ–¹æ¡ˆï¼ˆå¤šé‡å†—ä½™ï¼‰ï¼š
â”œâ”€â”€ rawImageData: 2.5MB (å®Œæ•´å›¾åƒ)
â”œâ”€â”€ transformedImageData: 1.2MB (è£å‰ªå)  
â”œâ”€â”€ binarizedImageData: 0.8MB (æœ€ç»ˆç»“æœ)
â””â”€â”€ æ€»è®¡: 4.5MB

ä¼˜åŒ–æ–¹æ¡ˆï¼ˆæ™ºèƒ½é€‰æ‹©ï¼‰ï¼š
â”œâ”€â”€ finalImageData: 0.8MB (ä»…æœ€ç»ˆç»“æœ)
â”œâ”€â”€ processingMetadata: 0.5KB (å¤„ç†å‚æ•°)
â””â”€â”€ æ€»è®¡: 0.8MB

å­˜å‚¨èŠ‚çœ: 82% (4.5MB â†’ 0.8MB)
```

#### 5.2 é€‚ç”¨åœºæ™¯åˆ†æ
```
ç”¨æˆ·æ“ä½œåœºæ™¯ â†’ ä¿å­˜æ•°æ® â†’ å­˜å‚¨å¤§å°
â”œâ”€â”€ ä»…å¯¼å…¥å›¾ç‰‡ â†’ rawImageData â†’ 2.5MB
â”œâ”€â”€ å¯¼å…¥+è£å‰ª â†’ transformedImageData â†’ 1.2MB  
â”œâ”€â”€ å¯¼å…¥+è£å‰ª+äºŒå€¼åŒ– â†’ binarizedImageData â†’ 0.8MB
â””â”€â”€ å¯¼å…¥+ä»…äºŒå€¼åŒ– â†’ binarizedImageData â†’ 0.8MB
```

### 6. å®ç°è®¡åˆ’

#### 6.1 é˜¶æ®µ1ï¼šç­–ç•¥ç±»å®ç°ï¼ˆ1-2å‘¨ï¼‰
- [ ] å®ç° `ImageDataSaveStrategy` ç±»
- [ ] å®ç° `ImageDataLoadStrategy` ç±»  
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•è¦†ç›–å„ç§æ•°æ®çŠ¶æ€
- [ ] éªŒè¯æ•°æ®è½¬æ¢çš„æ­£ç¡®æ€§

#### 6.2 é˜¶æ®µ2ï¼šé›†æˆåˆ°ä¿å­˜/åŠ è½½æµç¨‹ï¼ˆ1å‘¨ï¼‰
- [ ] ä¿®æ”¹ `PracticeService` çš„ä¿å­˜æµç¨‹
- [ ] ä¿®æ”¹ `PracticeService` çš„åŠ è½½æµç¨‹
- [ ] æ›´æ–°å›¾åƒå¤„ç†ç®¡çº¿ä»¥æ”¯æŒæ–°æ ¼å¼
- [ ] æ·»åŠ å®Œæ•´çš„é›†æˆæµ‹è¯•

#### 6.3 é˜¶æ®µ3ï¼šUIå’Œé”™è¯¯å¤„ç†ä¼˜åŒ–ï¼ˆ1å‘¨ï¼‰
- [ ] æ·»åŠ åŸå›¾ä¸¢å¤±æ—¶çš„ç”¨æˆ·æç¤º
- [ ] ä¼˜åŒ–åŠ è½½å¤±è´¥æ—¶çš„é”™è¯¯å¤„ç†
- [ ] æ·»åŠ æ•°æ®å®Œæ•´æ€§æ£€æŸ¥æœºåˆ¶
- [ ] æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–

### 7. é£é™©è¯„ä¼°ä¸ç¼“è§£

#### 7.1 æ•°æ®ä¸¢å¤±é£é™©
**é£é™©**ï¼šè½¬æ¢è¿‡ç¨‹ä¸­æ•°æ®æŸåæˆ–ä¸¢å¤±
**ç¼“è§£**ï¼š
- è½¬æ¢å‰éªŒè¯åŸå§‹æ•°æ®å®Œæ•´æ€§
- è½¬æ¢åéªŒè¯ç»“æœæ•°æ®æ­£ç¡®æ€§
- æ·»åŠ æ•°æ®æ ¡éªŒå’Œæœºåˆ¶

#### 7.2 æ€§èƒ½é£é™©
**é£é™©**ï¼šæ•°æ®è½¬æ¢å½±å“ä¿å­˜/åŠ è½½é€Ÿåº¦
**ç¼“è§£**ï¼š
- å¼‚æ­¥å¤„ç†æ•°æ®è½¬æ¢
- ç¼“å­˜è½¬æ¢ç»“æœé¿å…é‡å¤è®¡ç®—
- å¯¹æ¯”æ–°æ—§æ–¹æ¡ˆçš„æ€§èƒ½åŸºå‡†

#### 7.3 åŸå›¾ä¸¢å¤±é£é™©
**é£é™©**ï¼šä¾èµ–å¤–éƒ¨æ–‡ä»¶çš„é£é™©
**ç¼“è§£**ï¼š
- ä¿å­˜æœ€ç»ˆç»“æœæ•°æ®ç¡®ä¿åŸºæœ¬å¯ç”¨æ€§
- æä¾›æ¸…æ™°çš„ç”¨æˆ·æç¤ºå’Œé™çº§ä½“éªŒ
- è€ƒè™‘å¯é€‰çš„åŸå›¾å¤‡ä»½æœºåˆ¶

### 8. æµ‹è¯•ç­–ç•¥

#### 8.1 å•å…ƒæµ‹è¯•
```dart
void main() {
  group('ImageDataSaveStrategy', () {
    test('should save binarized data when binarization enabled', () {
      // æµ‹è¯•äºŒå€¼åŒ–æ•°æ®ä¼˜å…ˆä¿å­˜
    });
    
    test('should save transformed data when only transform applied', () {
      // æµ‹è¯•å˜æ¢æ•°æ®ä¿å­˜
    });
    
    test('should save raw data when no processing applied', () {
      // æµ‹è¯•åŸå§‹æ•°æ®ä¿å­˜
    });
  });
  
  group('ImageDataLoadStrategy', () {
    test('should restore binarized state correctly', () {
      // æµ‹è¯•äºŒå€¼åŒ–çŠ¶æ€æ¢å¤
    });
    
    test('should handle original image missing gracefully', () {
      // æµ‹è¯•åŸå›¾ä¸¢å¤±å¤„ç†
    });
  });
}
```

#### 8.2 é›†æˆæµ‹è¯•
- å®Œæ•´çš„ä¿å­˜â†’åŠ è½½â†’ç¼–è¾‘å¾ªç¯æµ‹è¯•
- ä¸åŒå›¾åƒå°ºå¯¸å’Œæ ¼å¼çš„å…¼å®¹æ€§æµ‹è¯•  
- åŸå›¾åˆ é™¤åçš„ç¾éš¾æ¢å¤æµ‹è¯•
- å¤§é‡æ•°æ®çš„æ€§èƒ½å’Œå†…å­˜ä½¿ç”¨æµ‹è¯•

### 9. ç›‘æ§æŒ‡æ ‡

#### 9.1 å­˜å‚¨æ•ˆç‡æŒ‡æ ‡
- å­—å¸–æ–‡ä»¶å¹³å‡å¤§å°å˜åŒ–
- æ•°æ®åº“å­˜å‚¨ç©ºé—´ä½¿ç”¨é‡
- ä¸åŒå¤„ç†çŠ¶æ€çš„æ•°æ®åˆ†å¸ƒ

#### 9.2 å¯é æ€§æŒ‡æ ‡  
- æ•°æ®åŠ è½½æˆåŠŸç‡
- åŸå›¾ä¸¢å¤±æƒ…å†µä¸‹çš„æ¢å¤æˆåŠŸç‡
- ç¼–è¾‘åŠŸèƒ½å¯ç”¨æ€§ä¿æŒç‡

#### 9.3 æ€§èƒ½æŒ‡æ ‡
- ä¿å­˜æ“ä½œå¹³å‡è€—æ—¶
- åŠ è½½æ“ä½œå¹³å‡è€—æ—¶
- å†…å­˜ä½¿ç”¨å³°å€¼å˜åŒ–

## æ€»ç»“

æœ¬è®¾è®¡é€šè¿‡æ™ºèƒ½çš„æ•°æ®ç®¡ç†ç­–ç•¥ï¼Œåœ¨ä¿è¯ç¼–è¾‘ä½“éªŒçš„åŒæ—¶å¤§å¹…ä¼˜åŒ–å­˜å‚¨æ•ˆç‡ã€‚æ ¸å¿ƒä¼˜åŠ¿ï¼š

1. **å­˜å‚¨ä¼˜åŒ–**ï¼šå‡å°‘60-80%çš„æ•°æ®åº“å­˜å‚¨ç©ºé—´
2. **ç¾éš¾æ¢å¤**ï¼šå³ä½¿åŸå›¾åˆ é™¤ä¹Ÿèƒ½æ­£å¸¸æ˜¾ç¤ºå’Œæœ‰é™ç¼–è¾‘
3. **æ™ºèƒ½é€‚é…**ï¼šæ ¹æ®ç”¨æˆ·æ“ä½œè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜å­˜å‚¨æ–¹æ¡ˆ
4. **ç®€åŒ–å®ç°**ï¼šå…¨æ–°æ ¼å¼è®¾è®¡ï¼Œæ— å†å²åŒ…è¢±

è¯¥ç­–ç•¥å°†æ˜¾è‘—æå‡å­—å¸–ç¼–è¾‘ç³»ç»Ÿçš„å¯é æ€§å’Œå­˜å‚¨æ•ˆç‡ï¼Œä¸ºç”¨æˆ·æä¾›æ›´å¥½çš„ä½¿ç”¨ä½“éªŒã€‚

## å…³é”®è®¾è®¡äº®ç‚¹

- **é›¶å†—ä½™å­˜å‚¨**ï¼šåªä¿å­˜çœŸæ­£éœ€è¦çš„æœ€ç»ˆç»“æœ
- **æ™ºèƒ½çŠ¶æ€æ¢å¤**ï¼šåŠ è½½æ—¶è‡ªåŠ¨é‡å»ºå®Œæ•´ç¼–è¾‘ç¯å¢ƒ
- **æ¸è¿›å¼é™çº§**ï¼šåŸå›¾ä¸¢å¤±æ—¶ä»ä¿æŒåŸºæœ¬åŠŸèƒ½å¯ç”¨
- **å¼€å‘å‹å¥½**ï¼šæ¸…æ™°çš„æ¥å£è®¾è®¡ï¼Œæ˜“äºæµ‹è¯•å’Œç»´æŠ¤