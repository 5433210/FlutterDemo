# 导出对话框自动方向适配功能

## 功能概述

导出对话框现在支持自动检测和适配页面方向，解决了之前固定使用纵向设置导致横向页面导出不当的问题。

## 主要改进

### 1. 自动方向检测

- **智能检测**: 根据页面的 `orientation` 属性或 `width`/`height` 比例自动检测页面方向
- **即时适配**: 在页面切换、范围模式变更时自动更新方向设置
- **用户可控**: 提供开关选项，用户可以选择启用或禁用自动检测

### 2. 增强的用户界面

- **自动检测选项**: 新增复选框控制自动检测功能
- **视觉反馈**: 显示当前检测到的方向信息
- **条件禁用**: 启用自动检测时，手动方向选择被禁用，避免冲突

### 3. 检测逻辑

```dart
// 检测优先级：
// 1. 首先检查页面的 orientation 属性
// 2. 如果没有，通过 width 和 height 比较判断
// 3. 默认为纵向 (portrait)

bool _detectPageOrientation(int pageIndex) {
  final page = pages[pageIndex];
  
  // 检查 orientation 属性
  if (page.containsKey('orientation')) {
    return page['orientation'] == 'landscape';
  }
  
  // 根据尺寸判断
  final width = page['width'] ?? 210.0;
  final height = page['height'] ?? 297.0;
  return width > height;
}
```

## 使用场景

### 1. 混合方向页面导出

- 当字帖包含不同方向的页面时，自动适配每个页面的方向
- 无需手动调整，提高导出效率

### 2. 批量导出优化

- 全部页面模式下，根据当前预览页面自动调整方向
- 确保预览效果与最终导出一致

### 3. 单页精确导出

- 当前页模式下，精确检测目标页面方向
- 保证单页导出的最佳效果

## 技术实现

### 1. 核心方法

- `_detectPageOrientation(int pageIndex)`: 检测指定页面的方向
- `_updateOrientation()`: 自动更新方向设置
- `_buildOrientationSelector()`: 构建增强的方向选择器UI

### 2. 触发时机

- 初始化时进行方向检测
- 页面切换时重新检测
- 页面范围类型变更时检测
- 用户手动启用自动检测时立即检测

### 3. 错误处理

- 使用 `EditPageLogger` 记录检测过程中的错误
- 提供降级方案，检测失败时默认为纵向

## 配置选项

### 默认设置

- `_autoDetectOrientation = true`: 默认启用自动检测
- 自动检测失败时使用纵向 (portrait) 作为后备

### 用户控制

- 复选框控制自动检测开关
- 禁用自动检测后可手动选择方向
- 实时显示检测结果

## 兼容性

### 向后兼容

- 保持原有的手动方向选择功能
- 不影响现有的导出流程
- 支持没有方向信息的旧版页面数据

### 数据格式支持

- 支持 `orientation` 字段为 'portrait'/'landscape'
- 支持通过 `width`/`height` 推断方向
- 兼容缺少方向信息的页面数据

## 未来扩展

### 可能的改进

1. **智能预测**: 根据页面内容自动建议最佳方向
2. **批量处理**: 支持为不同页面设置不同的方向策略
3. **用户偏好**: 记住用户的方向偏好设置
4. **预览优化**: 在预览中更直观地显示方向效果

### 性能优化

- 缓存方向检测结果，避免重复计算
- 异步检测，避免阻塞UI
- 优化大量页面时的检测性能
