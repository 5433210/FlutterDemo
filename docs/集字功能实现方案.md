# é›†å­—åŠŸèƒ½å®ç°æ–¹æ¡ˆï¼ˆä¿®è®¢ç‰ˆï¼‰

æ ¹æ®éœ€æ±‚å’Œç°æœ‰æ–‡æ¡£ï¼Œæˆ‘è®¾è®¡äº†ä»¥ä¸‹é›†å­—åŠŸèƒ½çš„å®ç°æ–¹æ¡ˆï¼š

## ä¸€ã€ç•Œé¢è®¾è®¡

### ä¸»ç•Œé¢å¸ƒå±€

```text
+--------------------------------------------------------------+
| å¯¼èˆªæ  [è¿”å›] [é›†å­—åŠŸèƒ½] [å¸®åŠ©]          [æœ€å°åŒ–] [å…³é—­]    |
+--------------------------------------------------------------+
|                          |                                    |
|      å›¾ç‰‡é¢„è§ˆåŒº          |         å³ä¾§é¢æ¿ï¼ˆæ ‡ç­¾é¡µï¼‰         |
|                          |  [é›†å­—æ•ˆæœé¢„è§ˆ] [ä½œå“é›†å­—ç»“æœ]     |
| [âœ‹] [â–¡] [â–£] [ğŸ—‘ï¸]       | +--------------------------------+ |
| +----------------------+ | |                                | |
| |                      | | |        å†…å®¹åŒºåŸŸ                | |
| |      åŸå§‹å›¾ç‰‡        | | |                                | |
| |                      | | |  * æ ‡ç­¾é¡µ1: é›†å­—æ•ˆæœé¢„è§ˆ       | |
| |    * å·²ä¿å­˜æ¡†çº¿      | | |    - äºŒå€¼åŒ–æ˜¾ç¤º                | |
| |    * å½“å‰é€‰æ‹©æ¡†      | | |    - æ“¦é™¤åŒºåŸŸ                  | |
| |    * ç¼©æ”¾/å¹³ç§»       | | |    - è½®å»“çº¿æ˜¾ç¤º                | |
| |                      | | |    - [å·¥å…·æ ]                  | |
| +----------------------+ | |  * æ ‡ç­¾é¡µ2: ä½œå“é›†å­—ç»“æœ       | |
|                          | |    - ç½‘æ ¼å±•ç¤ºé›†å­—å›¾ç‰‡          | |
| ç¼©ç•¥å›¾åŒºåŸŸ:              | |    - ç‚¹å‡»è·³è½¬åˆ°å¯¹åº”å­—          | |
| [ç¼©ç•¥å›¾1][ç¼©ç•¥å›¾2]...    | |                                | |
|                          | +--------------------------------+ |
+--------------------------------------------------------------+
```

### å¯¼èˆªæ è®¾è®¡

å¯¼èˆªæ åŒ…å«ä»¥ä¸‹å…ƒç´ ï¼š

- **è¿”å›æŒ‰é’®**ï¼šç‚¹å‡»è¿”å›ä¸Šä¸€é¡µé¢ï¼ˆä½œå“è¯¦æƒ…é¡µï¼‰
- **é¡µé¢æ ‡é¢˜**ï¼šæ˜¾ç¤º"é›†å­—åŠŸèƒ½"æ ‡é¢˜
- **å¸®åŠ©æŒ‰é’®**ï¼šç‚¹å‡»æ˜¾ç¤ºé›†å­—åŠŸèƒ½æ“ä½œæŒ‡å—å¼¹çª—
- **æ‰©å±•èœå•**ï¼ˆå¯é€‰ï¼‰ï¼šåŒ…å«é«˜çº§é€‰é¡¹å¦‚å¯¼å‡ºã€é‡ç½®ç­‰

å¯¼èˆªæ åœ¨ä¸åŒçŠ¶æ€ä¸‹çš„å˜åŒ–ï¼š

- **æœªä¿å­˜çŠ¶æ€**ï¼šæ˜¾ç¤ºé€€å‡ºç¡®è®¤æç¤º
- **æ‰¹é‡æ“ä½œçŠ¶æ€**ï¼šæ˜¾ç¤ºé€‰ä¸­æ•°é‡å’Œæ‰¹é‡æ“ä½œæŒ‰é’®
- **å¤„ç†ä¸­çŠ¶æ€**ï¼šæ˜¾ç¤ºè¿›åº¦æŒ‡ç¤ºå™¨
  
### æ ‡ç­¾é¡µè®¾è®¡

å³ä¾§é¢æ¿åˆ†ä¸ºä¸¤ä¸ªæ ‡ç­¾é¡µï¼š

1. **é›†å­—æ•ˆæœé¢„è§ˆæ ‡ç­¾é¡µ**
   - é¡¶éƒ¨å·¥å…·æ ï¼š[â—åè½¬] [â˜†è½®å»“] [âœæ“¦é™¤] [æ’¤é”€] [é‡åš]
   - ä¸­éƒ¨é¢„è§ˆåŒºï¼šæ˜¾ç¤ºå½“å‰å¤„ç†çš„å­—ç¬¦æ•ˆæœ
   - åº•éƒ¨ä¿¡æ¯åŒºï¼šå½“å‰å°ºå¯¸ã€å­—ç¬¦è¾“å…¥ã€æ“ä½œæŒ‰é’®

2. **ä½œå“é›†å­—ç»“æœæ ‡ç­¾é¡µ**

- ä»¥ç½‘æ ¼æ–¹å¼å±•ç¤ºå½“å‰ä½œå“çš„æ‰€æœ‰é›†å­—å›¾ç‰‡
- æ¯ä¸ªé›†å­—å›¾ç‰‡ä¸‹æ–¹æ˜¾ç¤ºå¯¹åº”çš„æ±‰å­—
- æä¾›æœç´¢ã€ç­›é€‰åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
- æ”¯æŒæ‰¹é‡æ“ä½œï¼ˆå¯é€‰ï¼‰

### çŠ¶æ€å˜åŒ–ç¤ºæ„

1. **é»˜è®¤çŠ¶æ€**
   - é¢„è§ˆåŒºæ˜¾ç¤ºåŸå›¾ï¼Œå·²æ”¶é›†å­—æ˜¾ç¤ºç»¿è‰²æ¡†çº¿
   - å·¥å…·æ å¾…é€‰çŠ¶æ€ï¼Œæ‹–æ‹½å·¥å…·æ¿€æ´»
   - å¯¼èˆªæ æ˜¾ç¤ºåŸºæœ¬å¯¼èˆªå…ƒç´ 

2. **æ¡†é€‰çŠ¶æ€**
   - æ¡†é€‰å·¥å…·æ¿€æ´»ï¼ˆè“è‰²é«˜äº®ï¼‰
   - é¼ æ ‡æ˜¾ç¤ºä¸ºåå­—å…‰æ ‡
   - æ‹–åŠ¨æ—¶æ˜¾ç¤ºè“è‰²é€‰æ¡†
   - å³ä¾§å®æ—¶æ˜¾ç¤ºå¤„ç†æ•ˆæœ
   - å¯¼èˆªæ æ˜¾ç¤º"æ¡†é€‰æ¨¡å¼"çŠ¶æ€æç¤º

3. **ç¼–è¾‘å·²ä¿å­˜å­—çŠ¶æ€**
   - é€‰ä¸­çš„ç»¿è‰²æ¡†å˜ä¸ºè“è‰²
   - å³ä¾§æ˜¾ç¤ºè¯¥å­—çš„å¤„ç†æ•ˆæœ
   - å¯è°ƒæ•´æ¡†å¤§å°å’Œä½ç½®
   - å¯¼èˆªæ æ˜¾ç¤º"ç¼–è¾‘æ¨¡å¼"å’Œå­—ç¬¦ä¿¡æ¯

4. **å¤šé€‰çŠ¶æ€**
   - å¤šé€‰å·¥å…·æ¿€æ´»
   - ç‚¹å‡»é€‰ä¸­çš„æ¡†çº¿å˜ä¸ºè“è‰²
   - å³ä¾§æ˜¾ç¤ºæœ€åé€‰ä¸­å­—çš„æ•ˆæœ
   - å¯¼èˆªæ æ˜¾ç¤ºå·²é€‰ä¸­çš„å­—ç¬¦æ•°é‡

5. **æ“¦é™¤çŠ¶æ€**
   - æ“¦é™¤å·¥å…·æ¿€æ´»
   - å³ä¾§é¢„è§ˆåŒºå¯è¿›è¡Œæ“¦é™¤æ“ä½œ
   - æ˜¾ç¤ºæ“¦é™¤è½¨è¿¹ï¼Œå®æ—¶æ›´æ–°æ•ˆæœ
   - å¯¼èˆªæ æ˜¾ç¤º"æ“¦é™¤æ¨¡å¼"çŠ¶æ€æç¤º

6. **é›†å­—ç»“æœæµè§ˆçŠ¶æ€**
   - å³ä¾§æ ‡ç­¾é¡µåˆ‡æ¢åˆ°"ä½œå“é›†å­—ç»“æœ"
   - ç½‘æ ¼å±•ç¤ºæ‰€æœ‰å·²é›†å­—å›¾ç‰‡
   - ç‚¹å‡»æŸä¸ªé›†å­—å›¾ç‰‡æ—¶ï¼š

   - å·¦ä¾§é¢„è§ˆåŒºè‡ªåŠ¨èšç„¦åˆ°è¯¥å­—æ‰€åœ¨ä½ç½®
   - è¯¥å­—åŒºåŸŸçº¿æ¡†å˜ä¸ºé€‰ä¸­çŠ¶æ€ï¼ˆè“è‰²ï¼‰
   - å³ä¾§æ ‡ç­¾é¡µè‡ªåŠ¨åˆ‡æ¢å›"é›†å­—æ•ˆæœé¢„è§ˆ"æ˜¾ç¤ºè¯¥å­—

## äºŒã€ç»„ä»¶ç»“æ„

```dart
CharacterCollectionPage
â”œâ”€â”€ NavigationBar                 // å¯¼èˆªæ ï¼ˆæ›¿æ¢åŸAppBarï¼‰
â”‚   â”œâ”€â”€ BackButton                // è¿”å›æŒ‰é’®
â”‚   â”œâ”€â”€ PageTitle                 // é¡µé¢æ ‡é¢˜
â”‚   â”œâ”€â”€ HelpButton                // å¸®åŠ©æŒ‰é’®
â”‚   â””â”€â”€ ContextActions            // ä¸Šä¸‹æ–‡æ“ä½œæŒ‰é’®
â”‚
â”œâ”€â”€ Row
â”‚   â”œâ”€â”€ ImagePreviewPanel          // å·¦ä¾§å›¾ç‰‡é¢„è§ˆåŒº
â”‚   â”‚   â”œâ”€â”€ PreviewToolbar         // å·¥å…·æ 
â”‚   â”‚   â”œâ”€â”€ ImageView              // å›¾ç‰‡æ˜¾ç¤º
â”‚   â”‚   â”‚   â””â”€â”€ SelectionOverlay   // é€‰æ¡†å±‚
â”‚   â”‚   â””â”€â”€ ThumbnailList          // ç¼©ç•¥å›¾åˆ—è¡¨ï¼ˆè€ƒè™‘å¤ç”¨EnhancedWorkPreviewç»„ä»¶ï¼‰
â”‚   â”‚
â”‚   â””â”€â”€ RightPanel                 // å³ä¾§é¢æ¿ï¼ˆä½¿ç”¨TabBarViewï¼‰
â”‚       â”œâ”€â”€ TabBar                 // æ ‡ç­¾æ 
â”‚       â”‚   â”œâ”€â”€ Tab("é›†å­—æ•ˆæœé¢„è§ˆ")
â”‚       â”‚   â””â”€â”€ Tab("ä½œå“é›†å­—ç»“æœ")
â”‚       â”‚
â”‚       â””â”€â”€ TabBarView             // æ ‡ç­¾å†…å®¹
â”‚           â”œâ”€â”€ CharacterEditPanel // æ ‡ç­¾1: é›†å­—æ•ˆæœé¢„è§ˆ
â”‚           â”‚   â”œâ”€â”€ EditToolbar    // ç¼–è¾‘å·¥å…·æ 
â”‚           â”‚   â”œâ”€â”€ PreviewCanvas  // é¢„è§ˆç”»å¸ƒ
â”‚           â”‚   â”‚   â”œâ”€â”€ BinaryImage // äºŒå€¼åŒ–å›¾åƒ
â”‚           â”‚   â”‚   â”œâ”€â”€ OutlineLayer // è½®å»“å±‚
â”‚           â”‚   â”‚   â””â”€â”€ EraseLayer // æ“¦é™¤å±‚
â”‚           â”‚   â”œâ”€â”€ SizeIndicator  // å°ºå¯¸æŒ‡ç¤ºå™¨
â”‚           â”‚   â”œâ”€â”€ CharacterInput // å­—ç¬¦è¾“å…¥
â”‚           â”‚   â””â”€â”€ ActionButtons  // æ“ä½œæŒ‰é’®
â”‚           â”‚
â”‚           â””â”€â”€ CharacterGridView  // æ ‡ç­¾2: ä½œå“é›†å­—ç»“æœ
â”‚               â”œâ”€â”€ SearchBar      // æœç´¢æ ï¼ˆå¯é€‰ï¼‰
â”‚               â”œâ”€â”€ FilterOptions  // ç­›é€‰é€‰é¡¹ï¼ˆå¯é€‰ï¼‰
â”‚               â””â”€â”€ CharacterGrid  // é›†å­—ç½‘æ ¼
â”‚                   â””â”€â”€ CharacterTile // é›†å­—å›¾ç‰‡é¡¹
```

## ä¸‰ã€äº¤äº’æµç¨‹

### 1. æ¡†é€‰æ–°å­—æµç¨‹

```mermaid
sequenceDiagram
    Actor User
    participant IP as å›¾ç‰‡é¢„è§ˆåŒº
    participant Tool as å·¥å…·æ 
    participant EP as æ•ˆæœé¢„è§ˆåŒº
    participant Proc as å¤„ç†å™¨
    
    User->>Tool: ç‚¹å‡»æ¡†é€‰å·¥å…·
    Tool->>IP: æ¿€æ´»æ¡†é€‰æ¨¡å¼
    Note over IP: å…‰æ ‡å˜ä¸ºåå­—
    
    User->>IP: ç»˜åˆ¶é€‰æ¡†
    IP->>IP: æ˜¾ç¤ºè“è‰²é€‰æ¡†
    IP->>Proc: æäº¤å›¾åƒåŒºåŸŸ
    Proc->>Proc: äºŒå€¼åŒ–å¤„ç†
    Proc->>Proc: ç”Ÿæˆè½®å»“
    Proc->>Proc: è°ƒæ•´å°ºå¯¸
    Proc-->>EP: è¿”å›å¤„ç†åå›¾åƒ
    
    opt è°ƒæ•´é€‰æ¡†
        User->>IP: æ‹–åŠ¨/è°ƒæ•´é€‰æ¡†
        IP->>Proc: é‡æ–°æäº¤åŒºåŸŸ
        Proc-->>EP: æ›´æ–°é¢„è§ˆ
    end
    
    opt ç¼–è¾‘æ•ˆæœ
        User->>EP: ä½¿ç”¨æ“¦é™¤å·¥å…·
        EP->>Proc: æäº¤æ“¦é™¤ç‚¹
        Proc->>Proc: åº”ç”¨æ“¦é™¤
        Proc-->>EP: æ›´æ–°æ•ˆæœ
    end
    
    User->>EP: è¾“å…¥ç®€ä½“å­—
    User->>EP: ç‚¹å‡»ä¿å­˜
    EP->>Proc: ä¿å­˜å¤„ç†ç»“æœ
    Proc->>IP: æ›´æ–°é€‰æ¡†(ç»¿è‰²)
```

### 2. ç¼–è¾‘å·²ä¿å­˜å­—æµç¨‹

```mermaid
sequenceDiagram
    Actor User
    participant Tool as å·¥å…·æ 
    participant IP as å›¾ç‰‡é¢„è§ˆåŒº
    participant EP as æ•ˆæœé¢„è§ˆåŒº
    participant DB as æ•°æ®å­˜å‚¨
    
    User->>Tool: ç‚¹å‡»å¤šé€‰å·¥å…·
    Tool->>IP: æ¿€æ´»å¤šé€‰æ¨¡å¼
    User->>IP: ç‚¹å‡»å·²ä¿å­˜å­—(ç»¿è‰²æ¡†)
    IP->>IP: é€‰ä¸­çŠ¶æ€(è“è‰²æ¡†)
    IP->>DB: è·å–å­—ç¬¦æ•°æ®
    DB-->>EP: è¿”å›å¤„ç†ä¿¡æ¯
    EP->>EP: æ˜¾ç¤ºä¿å­˜çš„æ•ˆæœ
    
    opt ç¼–è¾‘åŒºåŸŸ
        User->>IP: è°ƒæ•´æ¡†é€‰åŒºåŸŸ
        IP->>EP: é‡æ–°å¤„ç†é¢„è§ˆ
    end
    
    opt ç¼–è¾‘æ•ˆæœ
        User->>EP: ä½¿ç”¨å·¥å…·ä¿®æ”¹
        EP->>EP: æ›´æ–°é¢„è§ˆæ•ˆæœ
    end
    
    alt ä¿å­˜ä¿®æ”¹
        User->>EP: ç‚¹å‡»ä¿å­˜
        EP->>DB: æ›´æ–°å­—ç¬¦æ•°æ®
        DB-->>IP: ç¡®è®¤æ›´æ–°
    else å–æ¶ˆä¿®æ”¹
        User->>EP: ç‚¹å‡»å–æ¶ˆ
        EP->>EP: æ¢å¤åŸå§‹çŠ¶æ€
        IP->>IP: æ¢å¤ç»¿è‰²æ¡†
    end
```

### 3. åˆ é™¤æ“ä½œæµç¨‹

```mermaid
sequenceDiagram
    Actor User
    participant Tool as å·¥å…·æ 
    participant IP as å›¾ç‰‡é¢„è§ˆåŒº
    participant DB as æ•°æ®å­˜å‚¨
    
    alt å•ä¸ªåˆ é™¤
        User->>Tool: ç‚¹å‡»å¤šé€‰å·¥å…·
        Tool->>IP: æ¿€æ´»å¤šé€‰æ¨¡å¼
        User->>IP: é€‰ä¸­å·²ä¿å­˜å­—
        IP->>IP: æ˜¾ç¤ºè“è‰²é€‰ä¸­æ¡†
        User->>Tool: ç‚¹å‡»åˆ é™¤æŒ‰é’®
        Tool->>IP: æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        User->>IP: ç¡®è®¤åˆ é™¤
        IP->>DB: åˆ é™¤å­—ç¬¦æ•°æ®
        DB-->>IP: ç¡®è®¤åˆ é™¤
        IP->>IP: ç§»é™¤é€‰ä¸­æ¡†
    else å¤šé€‰åˆ é™¤
        User->>Tool: ç‚¹å‡»å¤šé€‰å·¥å…·
        Tool->>IP: æ¿€æ´»å¤šé€‰æ¨¡å¼
        User->>IP: é€‰ä¸­å¤šä¸ªå­—(è“è‰²æ¡†)
        User->>Tool: ç‚¹å‡»åˆ é™¤æŒ‰é’®
        Tool->>IP: æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        User->>IP: ç¡®è®¤åˆ é™¤
        IP->>DB: æ‰¹é‡åˆ é™¤æ•°æ®
        DB-->>IP: ç¡®è®¤åˆ é™¤
        IP->>IP: ç§»é™¤æ‰€æœ‰é€‰ä¸­æ¡†
    end
```

### 4. é›†å­—ç»“æœæµè§ˆæµç¨‹

```mermaid
sequenceDiagram
    Actor User
    participant Grid as é›†å­—ç»“æœç½‘æ ¼
    participant IP as å›¾ç‰‡é¢„è§ˆåŒº
    participant Tab as æ ‡ç­¾æ§åˆ¶å™¨
    participant EP as æ•ˆæœé¢„è§ˆåŒº
    participant DB as æ•°æ®å­˜å‚¨
    
    User->>Tab: åˆ‡æ¢åˆ°"ä½œå“é›†å­—ç»“æœ"
    Tab->>Grid: æ˜¾ç¤ºç½‘æ ¼è§†å›¾
    Grid->>DB: è·å–æ‰€æœ‰é›†å­—æ•°æ®
    DB-->>Grid: è¿”å›é›†å­—åˆ—è¡¨
    Grid->>Grid: æ¸²æŸ“ç½‘æ ¼å¸ƒå±€
    
    User->>Grid: ç‚¹å‡»é›†å­—å›¾ç‰‡
    Grid->>IP: è¯·æ±‚èšç„¦åˆ°å¯¹åº”åŒºåŸŸ
    Grid->>Tab: åˆ‡æ¢åˆ°"é›†å­—æ•ˆæœé¢„è§ˆ"
    Grid->>DB: è·å–å­—ç¬¦è¯¦æƒ…
    
    IP->>IP: å®šä½å¹¶ç¼©æ”¾åˆ°å­—ç¬¦ä½ç½®
    IP->>IP: è®¾ç½®é€‰ä¸­çŠ¶æ€(è“è‰²æ¡†)
    
    DB-->>EP: è¿”å›å¤„ç†ä¿¡æ¯
    EP->>EP: æ˜¾ç¤ºé€‰ä¸­å­—ç¬¦çš„æ•ˆæœ
    
    opt ç¼–è¾‘é€‰ä¸­å­—ç¬¦
        User->>EP: ä¿®æ”¹æ•ˆæœ
        User->>EP: ä¿å­˜ä¿®æ”¹
        EP->>DB: æ›´æ–°æ•°æ®
        DB-->>Grid: åŒæ­¥æ›´æ–°ç½‘æ ¼é¡¹
    end
```

## å››ã€æ•°æ®å¤„ç†æµç¨‹

### 1. å›¾åƒå¤„ç†æµç¨‹

```text
åŸå›¾åŒºåŸŸ â†’ è£å‰ª â†’ äºŒå€¼åŒ– â†’ å»å™ª â†’ è½®å»“æ£€æµ‹ â†’ å°ºå¯¸è°ƒæ•´ â†’ æ•ˆæœé¢„è§ˆ
```

å¤„ç†æ­¥éª¤è¯¦è§£ï¼š

1. **è£å‰ª**ï¼šä»åŸå›¾æ¡†é€‰åŒºåŸŸè£å‰ªå›¾åƒ
2. **äºŒå€¼åŒ–**ï¼šå°†å›¾åƒè½¬æ¢ä¸ºé»‘ç™½äºŒå€¼å›¾åƒ
   - ä½¿ç”¨è‡ªé€‚åº”é˜ˆå€¼æˆ–Otsuç®—æ³•
   - æ”¯æŒåè½¬åŠŸèƒ½å¤„ç†é»‘åº•ç™½å­—
3. **å»å™ªå¤„ç†**ï¼š
   - å»é™¤å°å‹å™ªç‚¹
   - å½¢æ€å­¦æ“ä½œï¼ˆè…èš€/è†¨èƒ€ï¼‰æ¸…ç†è¾¹ç¼˜
4. **è½®å»“æ£€æµ‹**ï¼š
   - æ£€æµ‹æ–‡å­—ä¸»è¦è½®å»“
   - ç”ŸæˆåŒ…å›´æ–‡å­—çš„æœ€å°çŸ©å½¢
5. **å°ºå¯¸è°ƒæ•´**ï¼š
   - ç­‰æ¯”ä¾‹ç¼©æ”¾è‡³300x300
   - ä¸è¶³éƒ¨åˆ†å¡«å……é€æ˜èƒŒæ™¯

### 2. æ“¦é™¤å¤„ç†

```text
ç”¨æˆ·æ“¦é™¤æ“ä½œ â†’ æ”¶é›†æ“¦é™¤ç‚¹ â†’ åº”ç”¨Alphaè’™ç‰ˆ â†’ æ›´æ–°è½®å»“ â†’ æ›´æ–°é¢„è§ˆ
```

- ä½¿ç”¨è·¯å¾„è®°å½•æ“¦é™¤è½¨è¿¹
- åº”ç”¨å¯é…ç½®å®½åº¦çš„æ“¦é™¤ç¬”åˆ·
- æ”¯æŒæ’¤é”€/é‡åšæ“ä½œå†å²è®°å½•

### 3é›†å­—ç»“æœå±•ç¤ºå¤„ç†æµç¨‹

```text
è·å–é›†å­—åˆ—è¡¨ â†’ åŠ è½½ç¼©ç•¥å›¾ â†’ æ¸²æŸ“ç½‘æ ¼ â†’ å“åº”é€‰æ‹© â†’ åŒæ­¥åˆ°é¢„è§ˆåŒº
```

å¤„ç†æ­¥éª¤è¯¦è§£ï¼š

1. **è·å–é›†å­—åˆ—è¡¨**ï¼š
    - ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰ä¸å½“å‰ä½œå“ç›¸å…³çš„é›†å­—è®°å½•
    - æ”¯æŒæŒ‰å­—ç¬¦ã€æ”¶è—çŠ¶æ€ç­‰ç­›é€‰
2. **åŠ è½½é›†å­—ç¼©ç•¥å›¾**ï¼š
   - å¼‚æ­¥åŠ è½½æ‰€æœ‰ç¼©ç•¥å›¾
   - ä½¿ç”¨å ä½ç¬¦æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
   - é‡‡ç”¨å»¶è¿ŸåŠ è½½ç­–ç•¥å‡è½»åˆå§‹åŠ è½½è´Ÿæ‹…
3. **æ¸²æŸ“ç½‘æ ¼è§†å›¾**ï¼š
   - é‡‡ç”¨GridViewå®ç°ç½‘æ ¼å¸ƒå±€
   - æ”¯æŒå“åº”å¼å¸ƒå±€è°ƒæ•´åˆ—æ•°
   - æ˜¾ç¤ºå­—ç¬¦ä¿¡æ¯å’Œå¿«æ·æ“ä½œæŒ‰é’®
4. **å“åº”é€‰æ‹©æ“ä½œ**ï¼š
   - è®°å½•å½“å‰é€‰ä¸­çš„å­—ç¬¦ID
   - è§¦å‘æ ‡ç­¾é¡µåˆ‡æ¢
   - å‘é€èšç„¦è¯·æ±‚åˆ°å›¾ç‰‡é¢„è§ˆåŒº
5. **åŒæ­¥æ›´æ–°**ï¼š
   - é›†å­—ä¿®æ”¹åè‡ªåŠ¨æ›´æ–°ç½‘æ ¼è§†å›¾
   - ä¿æŒæ•°æ®ä¸€è‡´æ€§

## äº”ã€æ•°æ®æ¨¡å‹

```dart
// é›†å­—åŒºåŸŸæ¨¡å‹
class CharacterRegion {
  final String id;
  final String pageId;
  final Rect rect;           // é€‰æ¡†ä½ç½®å’Œå¤§å°
  final double rotation;     // æ—‹è½¬è§’åº¦
  final String character;    // å¯¹åº”çš„æ±‰å­—
  final DateTime createdAt;
  final DateTime updatedAt;
  
  // å¤„ç†ç›¸å…³å‚æ•°
  final ProcessingOptions options;
  final List<Offset>? erasePoints;  // æ“¦é™¤ç‚¹
}

// å¤„ç†é€‰é¡¹
class ProcessingOptions {
  final bool inverted;       // æ˜¯å¦åè½¬
  final bool showContour;    // æ˜¯å¦æ˜¾ç¤ºè½®å»“
  final double threshold;    // äºŒå€¼åŒ–é˜ˆå€¼
  final double noiseReduction; // é™å™ªç¨‹åº¦
}

// é›†å­—å›¾ç‰‡ç±»
class CharacterImage {
  final String id;
  final String originalPath;    // åŸå§‹è£å‰ªå›¾è·¯å¾„
  final String binaryPath;      // äºŒå€¼åŒ–å›¾è·¯å¾„
  final String thumbnailPath;   // ç¼©ç•¥å›¾è·¯å¾„
  final String svgPath;         // SVGè½®å»“è·¯å¾„
  final Size originalSize;      // åŸå§‹å°ºå¯¸
  final ProcessingOptions options;
}
```

## å…­ã€æ–‡ä»¶å­˜å‚¨ç»“æ„

```text
storage/
â”œâ”€â”€ characters/
â”‚   â””â”€â”€ {charId}/
â”‚       â”œâ”€â”€ original.png     # åŸå›¾è£å‰ª (å®é™…å°ºå¯¸)
â”‚       â”œâ”€â”€ binary.png       # äºŒå€¼åŒ–å›¾åƒ (300x300)
â”‚       â”œâ”€â”€ thumbnail.jpg    # ç¼©ç•¥å›¾ (50x50)
â”‚       â””â”€â”€ outline.svg      # SVGè½®å»“
â””â”€â”€ cache/
    â””â”€â”€ processing/          # å¤„ç†ç¼“å­˜
        â””â”€â”€ temp/            # ä¸´æ—¶æ–‡ä»¶
```

## ä¸ƒã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. å›¾åƒå¤„ç†ä¼˜åŒ–

- **å¢é‡å¤„ç†**ï¼šåªå¤„ç†å˜åŒ–çš„éƒ¨åˆ†
- **åå°å¤„ç†**ï¼šä½¿ç”¨Isolateåœ¨åå°çº¿ç¨‹å¤„ç†å›¾åƒ
- **ç¼“å­˜æœºåˆ¶**ï¼šç¼“å­˜å¤„ç†ç»“æœé¿å…é‡å¤è®¡ç®—
- **å»¶è¿ŸåŠ è½½**ï¼šä»…åœ¨éœ€è¦æ—¶åŠ è½½é«˜åˆ†è¾¨ç‡å›¾åƒ

### 2. UIæ¸²æŸ“ä¼˜åŒ–

- **è‡ªå®šä¹‰ç»˜åˆ¶**ï¼šä½¿ç”¨CustomPainteré«˜æ•ˆç»˜åˆ¶é€‰æ¡†å’Œè½®å»“
- **å±€éƒ¨åˆ·æ–°**ï¼šä½¿ç”¨RepaintBoundaryéš”ç¦»é¢‘ç¹åˆ·æ–°åŒºåŸŸ
- **æ˜¾ç¤ºä¼˜åŒ–**ï¼šå›¾ç‰‡å¤„ç†è¿‡ç¨‹ä¸­æ˜¾ç¤ºä½åˆ†è¾¨ç‡é¢„è§ˆ

### 3. å†…å­˜ç®¡ç†

```dart
// ç¼“å­˜ç®¡ç†ç¤ºä¾‹
class ImageCacheManager {
  // é™åˆ¶ç¼“å­˜å¤§å°
  final int maxCacheSize = 50 * 1024 * 1024; // 50MB
  int currentSize = 0;
  
  // LRUç¼“å­˜ç­–ç•¥
  final Map<String, CacheEntry> _cache = LinkedHashMap<String, CacheEntry>();
  
  // ç¼“å­˜æ¸…ç†
  void _trimCache() {
    if (currentSize > maxCacheSize) {
      // ç§»é™¤æœ€æ—©ä½¿ç”¨çš„é¡¹ç›®ç›´åˆ°ç¼“å­˜å¤§å°åˆé€‚
    }
  }
  
  // èµ„æºç›‘æ§
  void monitorMemory() {
    // å®šæœŸæ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µ
    // åœ¨å†…å­˜å‹åŠ›å¤§æ—¶ä¸»åŠ¨æ¸…ç†ç¼“å­˜
  }
}
```

## å…«ã€ä»£ç å®ç°ç¤ºä¾‹

### 1. æ¡†é€‰å·¥å…·å®ç°

```dart
class SelectionTool extends StatefulWidget {
  final Function(Rect) onSelectionChanged;
  
  const SelectionTool({Key? key, required this.onSelectionChanged}) : super(key: key);
  
  @override
  _SelectionToolState createState() => _SelectionToolState();
}

class _SelectionToolState extends State<SelectionTool> {
  Offset? _startPoint;
  Rect? _currentRect;
  
  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onPanStart: (details) {
        setState(() {
          _startPoint = details.localPosition;
          _currentRect = Rect.fromPoints(_startPoint!, _startPoint!);
        });
      },
      onPanUpdate: (details) {
        if (_startPoint != null) {
          setState(() {
            _currentRect = Rect.fromPoints(_startPoint!, details.localPosition);
          });
          widget.onSelectionChanged(_currentRect!);
        }
      },
      onPanEnd: (_) {
        // å®Œæˆé€‰æ‹©
        _startPoint = null;
      },
      child: CustomPaint(
        painter: SelectionPainter(_currentRect),
        child: Container(
          color: Colors.transparent,
          width: double.infinity,
          height: double.infinity,
        ),
      ),
    );
  }
}

class SelectionPainter extends CustomPainter {
  final Rect? rect;
  
  SelectionPainter(this.rect);
  
  @override
  void paint(Canvas canvas, Size size) {
    if (rect == null) return;
    
    final paint = Paint()
      ..color = Colors.blue
      ..style = PaintingStyle.stroke
      ..strokeWidth = 2.0;
      
    canvas.drawRect(rect!, paint);
  }
  
  @override
  bool shouldRepaint(SelectionPainter oldDelegate) => rect != oldDelegate.rect;
}
```

### 2. å¤„ç†æœåŠ¡å®ç°

```dart
class ProcessingService {
  final CacheManager _cacheManager;
  
  ProcessingService(this._cacheManager);
  
  Future<ProcessingResult> processCharacterRegion(
    Uint8List imageData, 
    Rect region, 
    ProcessingOptions options
  ) async {
    // ç”Ÿæˆç¼“å­˜é”®
    final cacheKey = _generateCacheKey(imageData, region, options);
    
    // æ£€æŸ¥ç¼“å­˜
    final cachedResult = await _cacheManager.get(cacheKey);
    if (cachedResult != null) {
      return cachedResult;
    }
    
    // åœ¨Isolateä¸­å¤„ç†å›¾åƒ
    final result = await compute(_processImage, {
      'imageData': imageData,
      'region': region,
      'options': options,
    });
    
    // ç¼“å­˜ç»“æœ
    await _cacheManager.put(cacheKey, result);
    
    return result;
  }
  
  // åœ¨éš”ç¦»çš„çº¿ç¨‹ä¸­å¤„ç†å›¾åƒ
  static Future<ProcessingResult> _processImage(Map<String, dynamic> params) async {
    final imageData = params['imageData'] as Uint8List;
    final region = params['region'] as Rect;
    final options = params['options'] as ProcessingOptions;
    
    // 1. è£å‰ªåŒºåŸŸ
    final croppedImage = await _cropImage(imageData, region);
    
    // 2. äºŒå€¼åŒ–å¤„ç†
    final binaryImage = await _binarize(croppedImage, options.threshold, options.inverted);
    
    // 3. å»å™ªå¤„ç†
    final denoisedImage = await _denoise(binaryImage, options.noiseReduction);
    
    // 4. æ£€æµ‹è½®å»“
    final outline = await _detectOutline(denoisedImage);
    
    // 5. å°ºå¯¸è°ƒæ•´
    final resizedImage = await _resizeToTarget(denoisedImage, 300, 300);
    
    // 6. ç”ŸæˆSVGè½®å»“
    final svgPath = await _generateSvgPath(outline);
    
    // 7. ç”Ÿæˆç¼©ç•¥å›¾
    final thumbnail = await _createThumbnail(resizedImage, 50, 50);
    
    return ProcessingResult(
      originalCrop: croppedImage,
      binaryImage: resizedImage,
      thumbnail: thumbnail,
      svgOutline: svgPath,
      boundingBox: outline
    );
  }
  
  // å…¶ä»–å¤„ç†æ–¹æ³•...
}
```

### 3. çŠ¶æ€ç®¡ç†

```dart
@riverpod
class CharacterCollectionNotifier extends _$CharacterCollectionNotifier {
  late final CharacterService _service = ref.read(characterServiceProvider);
  
  @override
  FutureOr<CharacterCollectionState> build() async {
    return const CharacterCollectionState(
      regions: [],
      selectedIds: {},
      currentTool: Tool.pan,
      options: ProcessingOptions(
        inverted: false,
        showContour: false,
        threshold: 128,
        noiseReduction: 1.0,
      ),
      undoStack: [],
      processing: false,
    );
  }
  
  // åˆ‡æ¢å·¥å…·
  void setTool(Tool tool) {
    state = AsyncData(state.value!.copyWith(currentTool: tool));
  }
  
  // åˆ›å»ºæ–°åŒºåŸŸ
  Future<void> createRegion(Rect rect) async {
    state = AsyncData(state.value!.copyWith(processing: true));
    
    try {
      final region = await _service.createRegion(rect);
      
      state = AsyncData(state.value!.copyWith(
        regions: [...state.value!.regions, region],
        currentId: region.id,
        processing: false,
      ));
    } catch (e) {
      state = AsyncData(state.value!.copyWith(
        error: e.toString(),
        processing: false,
      ));
    }
  }
  
  // ä¿å­˜å­—ç¬¦
  Future<void> saveCharacter(String character) async {
    final currentId = state.value!.currentId;
    if (currentId == null) return;
    
    state = AsyncData(state.value!.copyWith(processing: true));
    
    try {
      await _service.saveCharacter(currentId, character);
      
      // æ›´æ–°åŒºåŸŸåˆ—è¡¨
      final updatedRegions = state.value!.regions.map((region) {
        if (region.id == currentId) {
          return region.copyWith(character: character);
        }
        return region;
      }).toList();
      
      state = AsyncData(state.value!.copyWith(
        regions: updatedRegions,
        processing: false,
      ));
    } catch (e) {
      state = AsyncData(state.value!.copyWith(
        error: e.toString(),
        processing: false,
      ));
    }
  }
  
  // æ›´å¤šæ–¹æ³•...
}
```

### 4. é›†å­—ç»“æœç½‘æ ¼è§†å›¾å®ç°

```dart

class CharacterGridView extends StatelessWidget {
  final List<CharacterViewModel> characters;
  final Function(String id) onCharacterSelected;
  
  const CharacterGridView({
    Key? key,
    required this.characters,
    required this.onCharacterSelected,
  }) : super(key: key);
  
  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        // å¯é€‰çš„æœç´¢å’Œç­›é€‰UI
        Padding(
          padding: const EdgeInsets.all(8.0),
          child: TextField(
            decoration: InputDecoration(
              hintText: 'æœç´¢å­—ç¬¦...',
              prefixIcon: Icon(Icons.search),
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(8.0),
              ),
            ),
            // æœç´¢é€»è¾‘
          ),
        ),
        
        // ç½‘æ ¼è§†å›¾
        Expanded(
          child: GridView.builder(
            padding: const EdgeInsets.all(8.0),
            gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
              crossAxisCount: 4, // å¯æ ¹æ®å±å¹•å®½åº¦åŠ¨æ€è°ƒæ•´
              childAspectRatio: 1.0,
              crossAxisSpacing: 8.0,
              mainAxisSpacing: 8.0,
            ),
            itemCount: characters.length,
            itemBuilder: (context, index) {
              final char = characters[index];
              return CharacterTile(
                character: char,
                onTap: () => onCharacterSelected(char.id),
              );
            },
          ),
        ),
      ],
    );
  }
}

class CharacterTile extends StatelessWidget {
  final CharacterViewModel character;
  final VoidCallback onTap;
  
  const CharacterTile({
    Key? key,
    required this.character,
    required this.onTap,
  }) : super(key: key);
  
  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(8.0),
      child: Container(
        decoration: BoxDecoration(
          border: Border.all(color: theme.dividerColor),
          borderRadius: BorderRadius.circular(8.0),
        ),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            // é›†å­—å›¾ç‰‡
            Expanded(
              child: Padding(
                padding: const EdgeInsets.all(4.0),
                child: Image.file(
                  File(character.thumbnailPath),
                  fit: BoxFit.contain,
                ),
              ),
            ),
            
            // å­—ç¬¦ä¿¡æ¯
            Container(
              width: double.infinity,
              padding: const EdgeInsets.symmetric(vertical: 4.0),
              color: theme.colorScheme.surfaceVariant,
              child: Text(
                character.character,
                textAlign: TextAlign.center,
                style: theme.textTheme.bodyMedium,
              ),
            ),
          ],
        ),
      ),
    );
  }
}
```

### 5. æ ‡ç­¾é¡µæ§åˆ¶å™¨å®ç°

```dart
class RightPanelTabController extends StatefulWidget {
  final Widget editPanel;
  final Widget gridPanel;
  final int initialIndex;
  final Function(int) onTabChanged;
  
  const RightPanelTabController({
    Key? key,
    required this.editPanel,
    required this.gridPanel,
    this.initialIndex = 0,
    required this.onTabChanged,
  }) : super(key: key);
  
  @override
  _RightPanelTabControllerState createState() => _RightPanelTabControllerState();
}

class _RightPanelTabControllerState extends State<RightPanelTabController> with SingleTickerProviderStateMixin {
  late TabController _tabController;
  
  @override
  void initState() {
    super.initState();
    _tabController = TabController(
      length: 2,
      vsync: this,
      initialIndex: widget.initialIndex,
    );
    
    _tabController.addListener(() {
      if (!_tabController.indexIsChanging) {
        widget.onTabChanged(_tabController.index);
      }
    });
  }
  
  @override
  void dispose() {
    _tabController.dispose();
    super.dispose();
  }
  
  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    
    return Column(
      children: [
        // æ ‡ç­¾æ 
        TabBar(
          controller: _tabController,
          tabs: [
            Tab(text: 'é›†å­—æ•ˆæœé¢„è§ˆ'),
            Tab(text: 'ä½œå“é›†å­—ç»“æœ'),
          ],
          labelColor: theme.colorScheme.primary,
          unselectedLabelColor: theme.colorScheme.onSurface,
          indicatorColor: theme.colorScheme.primary,
        ),
        
        // æ ‡ç­¾å†…å®¹
        Expanded(
          child: TabBarView(
            controller: _tabController,
            children: [
              widget.editPanel,
              widget.gridPanel,
            ],
          ),
        ),
      ],
    );
  }
}

```

## ä¹ã€æ³¨æ„äº‹é¡¹ä¸æŒ‘æˆ˜

1. **æ€§èƒ½æŒ‘æˆ˜**
   - å›¾åƒå¤„ç†æ“ä½œè®¡ç®—é‡å¤§ï¼Œéœ€åšå¥½å¼‚æ­¥å’Œç¼“å­˜
   - å®æ—¶é¢„è§ˆè¦ä¿è¯ä½å»¶è¿Ÿåé¦ˆ
   - å¤§å›¾åŠ è½½å’Œå¤„ç†éœ€è€ƒè™‘å†…å­˜é™åˆ¶

2. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**
   - æä¾›åŠ è½½çŠ¶æ€åé¦ˆ
   - é‡æ“ä½œéœ€è¦ç¡®è®¤å¯¹è¯æ¡†
   - æ“ä½œé”™è¯¯æä¾›æ’¤é”€æœºåˆ¶

3. **è¾¹ç•Œæƒ…å†µå¤„ç†**
   - å›¾åƒè´¨é‡ä¸ä½³æ—¶æä¾›æ‰‹åŠ¨è°ƒæ•´é€‰é¡¹
   - å¤„ç†å¤±è´¥æ—¶çš„æ¢å¤æœºåˆ¶
   - å¤§ä½“é‡æ•°æ®çš„æ€§èƒ½é€€åŒ–å¤„ç†

é€šè¿‡ä»¥ä¸Šè®¾è®¡å’Œå®ç°ï¼Œå¯ä»¥å®ç°ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡ã€æ€§èƒ½è‰¯å¥½çš„é›†å­—åŠŸèƒ½æ¨¡å—ï¼Œæ»¡è¶³ç”¨æˆ·ä»å›¾ç‰‡ä¸­æå–å’Œç®¡ç†æ±‰å­—çš„éœ€æ±‚ã€‚
