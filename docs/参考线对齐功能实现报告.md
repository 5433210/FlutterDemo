# å‚è€ƒçº¿å¯¹é½ç³»ç»Ÿå®ç°å®ŒæˆæŠ¥å‘Š

## ğŸ¯ å®ç°ç›®æ ‡

å®ç°å®Œæ•´çš„å‚è€ƒçº¿å¯¹é½åŠŸèƒ½ï¼ŒåŒ…å«ï¼š
1. **åŠ¨æ€å‚è€ƒçº¿**ï¼šæ¥è‡ªè¢«æ‹–æ‹½ï¼ˆå¹³ç§»æˆ–Resizeï¼‰çš„å…ƒç´ ï¼Œä¼šéšç€å…ƒç´ å˜åŒ–è€Œå˜åŒ–
2. **é™æ€å‚è€ƒçº¿**ï¼šæ¥è‡ªå…¶ä»–å›ºå®šå…ƒç´ ï¼Œä¿æŒä¸å˜
3. **å¯¹é½é€»è¾‘**ï¼šåŠ¨æ€å‚è€ƒçº¿åº”è¯¥å¯¹é½åˆ°é™æ€å‚è€ƒçº¿ï¼Œè€Œä¸æ˜¯è‡ªå·±å¯¹é½è‡ªå·±
4. **è§†è§‰æç¤º**ï¼šå½“ä¸åŠ¨æ€å‚è€ƒçº¿çš„è·ç¦»åœ¨é˜ˆå€¼å†…æ—¶ï¼Œé™æ€å‚è€ƒçº¿æ‰æ˜¾ç¤ºï¼Œå¯ä»¥æ˜¾ç¤ºå¤šæ¡ï¼Œå…¶ä¸­ä¸åŠ¨æ€å‚è€ƒçº¿è·ç¦»æœ€è¿‘çš„ä¸€æ¡é™æ€å‚è€ƒçº¿é«˜äº®æ˜¾ç¤º
5. **å¸é™„å¯¹é½**ï¼šåªåœ¨é¼ æ ‡é‡Šæ”¾æ—¶æ‰§è¡Œï¼ŒåŠ¨æ€å‚è€ƒçº¿å¯¹é½åˆ°æœ€è¿‘çš„ï¼ˆé«˜äº®çš„ï¼‰é™æ€å‚è€ƒçº¿ï¼Œç›¸åº”çš„äº§ç”Ÿå¸é™„

## âœ… å·²å®Œæˆçš„å®ç°

### 1. GuidelineManager é‡æ„
- **æ–‡ä»¶**: `lib/presentation/widgets/practice/guideline_alignment/guideline_manager.dart`
- **é‡è¦å˜æ›´**:
  - å®Œå…¨é‡æ„äº† GuidelineManager ç±»ï¼Œç§»é™¤äº†æ—§çš„ `_activeGuidelines` ç»“æ„
  - æ–°å¢ä¸‰ä¸ªç‹¬ç«‹çš„å‚è€ƒçº¿åˆ—è¡¨ï¼š
    - `_dynamicGuidelines`: åŠ¨æ€å‚è€ƒçº¿ï¼ˆæ¥è‡ªæ‹–æ‹½ä¸­çš„å…ƒç´ ï¼‰
    - `_staticGuidelines`: é™æ€å‚è€ƒçº¿ï¼ˆæ¥è‡ªå…¶ä»–å›ºå®šå…ƒç´ ï¼‰
    - `_highlightedGuidelines`: é«˜äº®å‚è€ƒçº¿ï¼ˆè·ç¦»åŠ¨æ€å‚è€ƒçº¿æœ€è¿‘çš„é™æ€å‚è€ƒçº¿ï¼‰

### 2. æ ¸å¿ƒæ–¹æ³•å®ç°

#### updateGuidelinesLive()
- **åŠŸèƒ½**: å®æ—¶æ›´æ–°å‚è€ƒçº¿ç³»ç»Ÿ
- **æµç¨‹**:
  1. ç”ŸæˆåŠ¨æ€å‚è€ƒçº¿ï¼ˆæ¥è‡ªæ‹–æ‹½ä¸­çš„å…ƒç´ ï¼‰
  2. ç”Ÿæˆé™æ€å‚è€ƒçº¿ï¼ˆæ¥è‡ªå…¶ä»–å›ºå®šå…ƒç´ å’Œé¡µé¢è¾¹ç•Œï¼‰
  3. è®¡ç®—é«˜äº®å‚è€ƒçº¿ï¼ˆè·ç¦»åŠ¨æ€å‚è€ƒçº¿æœ€è¿‘çš„é™æ€å‚è€ƒçº¿ï¼‰
  4. åŒæ­¥åˆ°è¾“å‡º

#### performAlignment()
- **åŠŸèƒ½**: æ‰§è¡Œå¯¹é½å¸é™„ï¼ˆé¼ æ ‡é‡Šæ”¾æ—¶è°ƒç”¨ï¼‰
- **ç‰¹ç‚¹**:
  - åªå¯¹é«˜äº®çš„å‚è€ƒçº¿æ‰§è¡Œå¸é™„
  - è¿”å›å¯¹é½åçš„ä½ç½®å’Œå¯¹é½ä¿¡æ¯
  - æ”¯æŒæ°´å¹³å’Œå‚ç›´æ–¹å‘çš„å¯¹é½

#### å‚è€ƒçº¿åˆ†ç±»ç®¡ç†
- **åŠ¨æ€å‚è€ƒçº¿**: ç°è‰²æ˜¾ç¤ºï¼Œéšæ‹–æ‹½å…ƒç´ å®æ—¶æ›´æ–°
- **é™æ€å‚è€ƒçº¿**: é»˜è®¤é¢œè‰²ï¼Œæ¥è‡ªå…¶ä»–å›ºå®šå…ƒç´ 
- **é«˜äº®å‚è€ƒçº¿**: é’è‰²æ˜¾ç¤ºï¼Œè¡¨ç¤ºå°†è¦å¸é™„çš„ç›®æ ‡

### 3. è§†è§‰æç¤ºç³»ç»Ÿ
- **æ˜¾ç¤ºé˜ˆå€¼**: `_displayThreshold = 20.0` åƒç´ 
- **å¸é™„é˜ˆå€¼**: `_snapThreshold = 8.0` åƒç´ 
- **é«˜äº®æœºåˆ¶**: è·ç¦»åŠ¨æ€å‚è€ƒçº¿æœ€è¿‘çš„é™æ€å‚è€ƒçº¿ä¼šè¢«é«˜äº®æ˜¾ç¤º

### 4. æ‹–æ‹½çŠ¶æ€ç®¡ç†
- **æ‹–æ‹½å¼€å§‹**: è®¾ç½® `isDragging = true` å’Œ `draggingElementId`
- **æ‹–æ‹½è¿‡ç¨‹**: å®æ—¶è°ƒç”¨ `updateGuidelinesLive()` æ›´æ–°å‚è€ƒçº¿
- **æ‹–æ‹½ç»“æŸ**: è°ƒç”¨ `performAlignment()` æ‰§è¡Œå¸é™„ï¼Œç„¶åæ¸…é™¤çŠ¶æ€

### 5. å…¼å®¹æ€§æ¥å£
ä¸ºäº†ä¿æŒå‘åå…¼å®¹ï¼Œä¿ç•™äº†ä»¥ä¸‹å·²åºŸå¼ƒçš„æ–¹æ³•ï¼š
- `generateGuidelines()` (å·²åºŸå¼ƒï¼Œå†…éƒ¨è°ƒç”¨ `updateGuidelinesLive`)
- `detectAlignment()` (å…¼å®¹æ¥å£ï¼Œå†…éƒ¨è°ƒç”¨ `performAlignment`)
- `calculateBestAlignment()` (å…¼å®¹æ¥å£)
- `generateRealTimeGuidelines()` (å…¼å®¹æ¥å£)

## ğŸ“‚ ä¿®æ”¹çš„æ–‡ä»¶

### ä¸»è¦æ–‡ä»¶
1. **GuidelineManager** (`guideline_manager.dart`) - å®Œå…¨é‡æ„
2. **FreeControlPoints** (`free_control_points.dart`) - æ›´æ–°å‚è€ƒçº¿è°ƒç”¨é€»è¾‘
3. **SmartCanvasGestureHandler** (`smart_canvas_gesture_handler.dart`) - æ›´æ–°æ–¹æ³•è°ƒç”¨

### å¤‡ä»½æ–‡ä»¶
- `guideline_manager_old.dart` - åŸå§‹å®ç°çš„å¤‡ä»½

## ğŸ”§ æ ¸å¿ƒç‰¹æ€§

### åŠ¨æ€ä¸é™æ€åˆ†ç¦»
```dart
// åŠ¨æ€å‚è€ƒçº¿ï¼šæ¥è‡ªæ­£åœ¨æ‹–æ‹½çš„å…ƒç´ 
final dynamicGuidelines = manager.dynamicGuidelines;

// é™æ€å‚è€ƒçº¿ï¼šæ¥è‡ªå…¶ä»–å›ºå®šå…ƒç´ 
final staticGuidelines = manager.staticGuidelines;

// é«˜äº®å‚è€ƒçº¿ï¼šå°†è¦å¸é™„çš„ç›®æ ‡
final highlightedGuidelines = manager.highlightedGuidelines;
```

### å®æ—¶æ›´æ–°
```dart
// æ‹–æ‹½è¿‡ç¨‹ä¸­å®æ—¶æ›´æ–°å‚è€ƒçº¿
manager.updateGuidelinesLive(
  elementId: elementId,
  draftPosition: currentPosition,
  elementSize: currentSize,
);
```

### å¸é™„å¯¹é½
```dart
// é¼ æ ‡é‡Šæ”¾æ—¶æ‰§è¡Œå¸é™„
final result = manager.performAlignment(
  elementId: elementId,
  currentPosition: currentPosition,
  elementSize: elementSize,
);

if (result['hasAlignment'] == true) {
  final alignedPosition = result['position'] as Offset;
  // åº”ç”¨å¯¹é½åçš„ä½ç½®
}
```

## ğŸ¯ å…³é”®æ”¹è¿›

1. **æ€§èƒ½ä¼˜åŒ–**: åˆ†ç¦»åŠ¨æ€å’Œé™æ€å‚è€ƒçº¿è®¡ç®—ï¼Œå‡å°‘ä¸å¿…è¦çš„é‡å¤è®¡ç®—
2. **è§†è§‰ä½“éªŒ**: é«˜äº®æ˜¾ç¤ºå°†è¦å¸é™„çš„å‚è€ƒçº¿ï¼Œæä¾›æ¸…æ™°çš„è§†è§‰åé¦ˆ
3. **ç²¾ç¡®æ§åˆ¶**: åˆ†åˆ«è®¾ç½®æ˜¾ç¤ºé˜ˆå€¼å’Œå¸é™„é˜ˆå€¼ï¼Œå®ç°ç²¾å‡†çš„ç”¨æˆ·ä½“éªŒ
4. **æ¶æ„æ¸…æ™°**: æ˜ç¡®åˆ†ç¦»ç”Ÿæˆã€æ˜¾ç¤ºå’Œå¸é™„ä¸‰ä¸ªé˜¶æ®µçš„é€»è¾‘

## ğŸš€ æµ‹è¯•éªŒè¯

å‚è€ƒçº¿å¯¹é½ç³»ç»Ÿå·²ç»ä¸ç°æœ‰çš„ FreeControlPoints å’Œ Canvas ç³»ç»Ÿé›†æˆï¼š
- âœ… æ‹–æ‹½å¼€å§‹æ—¶æ­£ç¡®è®¾ç½®æ‹–æ‹½çŠ¶æ€å’Œå…ƒç´ ID
- âœ… æ‹–æ‹½è¿‡ç¨‹ä¸­å®æ—¶ç”Ÿæˆå’Œæ˜¾ç¤ºå‚è€ƒçº¿
- âœ… é¼ æ ‡é‡Šæ”¾æ—¶æ‰§è¡Œå¸é™„å¯¹é½
- âœ… æ‹–æ‹½ç»“æŸæ—¶æ¸…é™¤å‚è€ƒçº¿å’ŒçŠ¶æ€

## ğŸ“‹ ä½¿ç”¨è¯´æ˜

1. **å¯ç”¨å‚è€ƒçº¿**: `GuidelineManager.instance.enabled = true`
2. **è®¾ç½®é˜ˆå€¼**: `GuidelineManager.instance.snapThreshold = 8.0`
3. **æ›´æ–°å…ƒç´ **: `manager.updateElements(elementList)`
4. **æ›´æ–°é¡µé¢**: `manager.updatePageSize(size)`

ç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†æ‹–æ‹½è¿‡ç¨‹ä¸­çš„å‚è€ƒçº¿ç”Ÿæˆã€æ˜¾ç¤ºå’Œå¸é™„å¯¹é½ã€‚

---

**å®ç°å®Œæˆæ—¥æœŸ**: 2025å¹´6æœˆ14æ—¥  
**å®ç°çŠ¶æ€**: âœ… å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡é›†æˆæµ‹è¯•

## âœ… 2024å¹´12æœˆ14æ—¥æ›´æ–°: å¸é™„é€»è¾‘å®Œæˆå®ç°

### ğŸ”§ ä¿®å¤çš„å…³é”®é—®é¢˜

#### 1. å¸é™„é˜ˆå€¼é€»è¾‘ä¿®å¤
- **é—®é¢˜**: å¸é™„åœ¨ä»»ä½•è·ç¦»éƒ½ä¼šå‘ç”Ÿï¼Œæ²¡æœ‰ä¸¥æ ¼éµå®ˆå¸é™„é˜ˆå€¼
- **ä¿®å¤**: åœ¨ `performAlignment()` æ–¹æ³•ä¸­å¢åŠ ä¸¥æ ¼çš„è·ç¦»æ£€æŸ¥
- **å®ç°**:
  ```dart
  // åªæœ‰åœ¨å¸é™„é˜ˆå€¼å†…æ‰æ‰§è¡Œå¸é™„
  if (distance <= _snapThreshold) {
    alignedX = targetX; // æˆ– alignedY = targetY
  }
  ```

#### 2. è·ç¦»è®¡ç®—ä¿®æ­£
- **é—®é¢˜**: è·ç¦»è®¡ç®—æ–¹å¼ä¸æ­£ç¡®
- **ä¿®å¤**: 
  - æ°´å¹³å‚è€ƒçº¿ï¼šæ¯”è¾ƒ `(currentPosition.dy - targetY).abs()`
  - å‚ç›´å‚è€ƒçº¿ï¼šæ¯”è¾ƒ `(currentPosition.dx - targetX).abs()`

#### 3. alignmentMode å…¼å®¹æ€§å¢å¼º
- **é—®é¢˜**: éœ€è¦ `alignmentMode` ä¸º `AlignmentMode.guideline` æ‰æ‰§è¡Œå¸é™„
- **ä¿®å¤**: å½“ `alignmentMode` ä¸º `null` æ—¶ï¼Œé»˜è®¤å¯ç”¨å‚è€ƒçº¿å¯¹é½

### ğŸ“Š åŠŸèƒ½éªŒè¯æµ‹è¯•ç»“æœ

| æµ‹è¯•è·ç¦» | å¸é™„é˜ˆå€¼ | é¢„æœŸè¡Œä¸º | å®é™…è¡Œä¸º | ç»“æœ |
|---------|---------|---------|---------|------|
| 3åƒç´  | 8åƒç´  | åº”è¯¥å¸é™„ | âœ… å¸é™„ | âœ… æ­£ç¡® |
| 5åƒç´  | 8åƒç´  | åº”è¯¥å¸é™„ | âœ… å¸é™„ | âœ… æ­£ç¡® |
| 10åƒç´  | 8åƒç´  | ä¸åº”è¯¥å¸é™„ | âœ… ä¸å¸é™„ | âœ… æ­£ç¡® |
| 15åƒç´  | 8åƒç´  | ä¸åº”è¯¥å¸é™„ | âœ… ä¸å¸é™„ | âœ… æ­£ç¡® |

### ğŸ¯ å®Œæ•´çš„å¸é™„æµç¨‹

1. **æ‹–æ‹½å¼€å§‹**:
   - è®¾ç½® `GuidelineManager.instance.isDragging = true`
   - è®¾ç½® `GuidelineManager.instance.draggingElementId`

2. **æ‹–æ‹½è¿‡ç¨‹ä¸­**:
   - è°ƒç”¨ `updateGuidelinesLive()` å®æ—¶ç”Ÿæˆå‚è€ƒçº¿
   - åŠ¨æ€å‚è€ƒçº¿(6æ¡) + é™æ€å‚è€ƒçº¿(12æ¡) + é«˜äº®å‚è€ƒçº¿(6æ¡) = æ€»è®¡24æ¡

3. **æ‹–æ‹½ç»“æŸ**:
   - è°ƒç”¨ `performAlignment()` æ‰§è¡Œå¸é™„å¯¹é½
   - åªæœ‰è·ç¦» â‰¤ 8åƒç´ çš„é«˜äº®å‚è€ƒçº¿ä¼šè§¦å‘å¸é™„
   - è¿”å›å¸é™„åçš„ç²¾ç¡®ä½ç½®

4. **çŠ¶æ€æ¸…ç†**:
   - è®¾ç½® `GuidelineManager.instance.isDragging = false`
   - æ¸…é™¤ `draggingElementId` å’Œæ‰€æœ‰å‚è€ƒçº¿

### ğŸ—‘ï¸ é¡µé¢å‚è€ƒçº¿ç§»é™¤
- **å†³å®š**: åˆ é™¤é¡µé¢è¾¹ç•Œå‚è€ƒçº¿ï¼Œä¸“æ³¨äºå…ƒç´ é—´å¯¹é½
- **æ•ˆæœ**: é™æ€å‚è€ƒçº¿ä»18æ¡å‡å°‘åˆ°12æ¡
- **ä¼˜åŠ¿**: ç•Œé¢æ›´ç®€æ´ï¼Œå‡å°‘å¹²æ‰°
