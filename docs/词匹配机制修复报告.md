# 词匹配机制优化修复报告

## 问题描述
用户反馈在输入"nature 秋"时，系统将"nature"识别为6个字符，而不是作为一个词语整体。

## 修复内容

### 1. 文本分段算法优化
- **问题**: 原始算法在处理空格分隔文本时，索引计算错误
- **修复**: 重新实现 `_parseTextSegments` 方法，正确追踪每个分段的起始索引

```dart
List<TextSegment> _parseTextSegments(String text) {
  final segments = <TextSegment>[];
  
  // 按空格分割并追踪位置
  final parts = <String>[];
  final partIndices = <int>[];
  
  int index = 0;
  for (final part in text.split(' ')) {
    if (part.isNotEmpty) {
      parts.add(part);
      partIndices.add(index);
    }
    index += part.length + 1; // +1 for space
  }
  
  for (int i = 0; i < parts.length; i++) {
    final part = parts[i];
    final startIndex = partIndices[i];
    
    // 进一步分割混合内容
    final mixedSegments = _segmentMixedContent(part, startIndex);
    segments.addAll(mixedSegments);
  }
  
  return segments;
}
```

### 2. 字符分配逻辑修复
- **问题**: 在词匹配模式下，仍然按单个字符索引分配
- **修复**: 新增 `_assignCharacterToSegments` 方法，按分段分配字符

```dart
Future<void> _assignCharacterToSegments(CharacterEntity entity, Map<String, dynamic> format) async {
  // 解析文本分段
  final segments = _parseTextSegments(characters);
  
  // 找到包含当前选中字符索引的分段
  int segmentIndex = -1;
  for (int i = 0; i < segments.length; i++) {
    final segment = segments[i];
    final endIndex = segment.startIndex + segment.text.length - 1;
    if (_selectedCharIndex >= segment.startIndex && _selectedCharIndex <= endIndex) {
      segmentIndex = i;
      break;
    }
  }
  
  // 将字符分配给整个分段的所有位置
  if (segmentIndex != -1) {
    final selectedSegment = segments[segmentIndex];
    for (int i = selectedSegment.startIndex; i < selectedSegment.startIndex + selectedSegment.text.length; i++) {
      await _updateCharacterImage(i, entity.id, format['type'], format['format']);
    }
  }
}
```

### 3. 候选字符加载优化
- **问题**: 词匹配模式下，候选字符显示逻辑不合理
- **修复**: 根据当前选中的文本分段优先加载相关候选

```dart
if (_wordMatchingMode && characters.trim().isNotEmpty) {
  // 根据当前选中的分段加载候选
  final segments = _parseTextSegments(characters);
  
  // 找到当前选中的分段
  String searchQuery = characters;
  if (segmentIndex != -1) {
    searchQuery = segments[segmentIndex].text;
  }
  
  // 优先搜索选中的分段
  final primaryResults = await characterService.searchCharactersWithMode(
    searchQuery.trim(),
    wordMatchingPriority: true,
  );
  // ... 加载候选逻辑
}
```

## 测试验证

### 分段测试结果
对于输入 "nature 秋"：
- `nature` 被识别为分段 0 (索引 0-5)
- `秋` 被识别为分段 1 (索引 7)
- 空格字符 (索引 6) 不属于任何分段

### 字符分配测试
- 选中 "nature" 中任一字符时，整个 "nature" 分段都会被分配相同的字符
- 选中 "秋" 时，只有 "秋" 这个位置被分配

## 预期效果

1. **词匹配优先**: 输入"nature 秋"时，"nature"作为一个整体被搜索和分配
2. **分段分配**: 选择候选字符时，整个词语分段都使用同一个字符
3. **智能回退**: 如果词匹配无结果，自动回退到字符匹配
4. **正确预览**: UI 预览中 "nature" 显示为一个格子，"秋" 显示为一个格子

## 关键改进

1. **TextSegment 类**: 新增文本分段数据结构
2. **索引计算修复**: 正确处理空格分隔的文本索引
3. **分段查找算法**: 优化分段包含判断逻辑
4. **智能分配**: 按分段而非字符进行分配

这些修复确保了词匹配模式下的正确行为，解决了用户反馈的"nature 被识别成6个字符"的问题。
