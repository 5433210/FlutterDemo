# 字符采集页图片预览面板问题修复报告

## 问题描述

用户反馈字符采集页中图片预览面板存在以下问题：

### 桌面端

- **框选工具模式**：无法创建选区；无法操作选区控制点

### 移动端

- **平移工具模式**：无法缩放、平移图片
- **框选工具模式**：无法缩放、平移图片；无法创建选区；无法操作选区控制点

## 问题分析

### 根本原因

1. **手势冲突**：不同工具模式下的手势检测器存在冲突，导致某些操作无法正常执行
2. **状态管理不当**：工具模式切换时状态重置不完整
3. **InteractiveViewer配置错误**：在某些模式下错误地禁用了平移和缩放功能

### 具体问题

#### 桌面端问题

- Alt键和右键检测逻辑过度干扰了正常的框选操作
- 手势检测器层次结构复杂，存在事件拦截问题
- 选区调整模式下的事件处理逻辑不够清晰

#### 移动端问题

- 在框选模式下完全禁用了InteractiveViewer的默认手势，导致无法缩放和平移
- Scale手势处理逻辑过于复杂，单指和多指操作混淆
- 平移模式下也禁用了默认手势，需要自行实现但实现不完整

## 修复方案

### 桌面端修复 (DesktopImageView)

#### 1. 简化手势检测逻辑

- **修改前**：复杂的条件判断决定使用哪个手势处理器
- **修改后**：根据工具模式和调整状态清晰分离手势处理

```dart
// 修改前：复杂的条件判断
onPanStart: isPanMode || _isAltKeyPressed || _isRightMousePressed
    ? _handlePanStart
    : _handleSelectionStart,

// 修改后：清晰的层次分离
// 只在对应模式下响应相应的手势
if (isSelectMode && !_isAdjusting)
  // 框选层
```

#### 2. 优化InteractiveViewer配置

- **scaleEnabled**: 根据工具模式和Alt键状态动态设置
- **panEnabled**: 根据工具模式和Alt键状态动态设置

#### 3. 改进选区创建逻辑

- 增强拖拽距离检测，避免误触
- 优化选区大小验证
- 改进错误处理和状态重置

### 移动端修复 (MobileImageView)

#### 1. 重新设计手势策略

- **平移模式**：完全依赖InteractiveViewer的默认手势
- **框选模式**：InteractiveViewer处理缩放平移，自定义Scale手势处理框选

```dart
// 修改前：在框选模式下禁用所有默认手势
panEnabled: false,
scaleEnabled: false,

// 修改后：始终启用默认手势
panEnabled: true,
scaleEnabled: true,
```

#### 2. 简化Scale手势处理

- **双指操作**：交给InteractiveViewer自动处理
- **单指操作**：仅在框选模式下处理框选和调整

#### 3. 优化工具模式响应

```dart
// 只在框选模式下注册Scale手势
onScaleStart: toolMode == Tool.select ? _handleScaleStart : null,
```

## 修复效果

### 桌面端

✅ **框选工具模式**：

- 可以正常创建选区（拖拽距离超过10像素）
- 可以操作选区控制点进行调整
- Alt键+拖拽或右键+拖拽可以平移图片

✅ **平移工具模式**：

- 保持原有的平移和缩放功能

### 移动端

✅ **平移工具模式**：

- 可以正常缩放图片（双指缩放）
- 可以正常平移图片（单指或双指平移）

✅ **框选工具模式**：

- 可以正常缩放图片（双指缩放）
- 可以正常平移图片（双指平移）
- 可以创建选区（单指拖拽）
- 可以操作选区控制点（长按进入调整模式）

## 技术改进

### 1. 代码清理

- 移除未使用的变量和方法
- 简化状态管理逻辑
- 优化日志输出

### 2. 性能优化

- 减少不必要的手势检测器层次
- 优化重绘区域
- 改进事件处理效率

### 3. 用户体验提升

- 更精确的触摸区域检测（移动端使用24px触摸半径）
- 更好的视觉反馈
- 更流畅的操作体验

## 测试建议

### 桌面端测试

1. **框选模式**：
   - 在空白区域拖拽创建选区
   - 点击选区后拖拽控制点调整大小
   - 按住Alt键拖拽应该可以平移图片
   - 右键拖拽应该可以平移图片

2. **平移模式**：
   - 鼠标拖拽应该可以平移图片
   - 鼠标滚轮应该可以缩放图片

### 移动端测试

1. **平移模式**：
   - 单指拖拽应该可以平移图片
   - 双指缩放应该可以缩放图片
   - 双指拖拽应该可以平移图片

2. **框选模式**：
   - 双指缩放应该可以缩放图片
   - 双指拖拽应该可以平移图片
   - 单指拖拽应该可以创建选区
   - 长按选区应该进入调整模式

## 文件修改清单

1. `lib/presentation/widgets/character_collection/desktop_image_view.dart`
   - 重构手势检测逻辑
   - 简化InteractiveViewer配置
   - 优化选区创建和调整流程

2. `lib/presentation/widgets/character_collection/mobile_image_view.dart`
   - 重新设计手势策略
   - 简化Scale手势处理
   - 优化工具模式响应

## 总结

通过重新设计手势检测逻辑和优化InteractiveViewer配置，成功解决了字符采集页图片预览面板在不同平台和工具模式下的交互问题。修复后的实现更加简洁、高效，用户体验得到显著提升。

主要改进原则：

1. **职责分离**：让InteractiveViewer专注处理缩放平移，自定义手势专注处理业务逻辑
2. **简化逻辑**：减少复杂的条件判断，使用清晰的模式分离
3. **平台优化**：针对桌面端和移动端的不同特性分别优化
