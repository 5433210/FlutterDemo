name: Version Management

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version_increment:
        description: 'ç‰ˆæœ¬é€’å¢ç±»å‹'
        required: false
        default: 'patch'
        type: choice
        options:
        - major
        - minor
        - patch
      prerelease:
        description: 'é¢„å‘å¸ƒæ ‡è¯†ç¬¦ (å¯é€‰)'
        required: false
        type: string

env:
  FLUTTER_VERSION: '3.16.0'
  PYTHON_VERSION: '3.9'

jobs:
  version-check:
    name: ç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version-info.outputs.version }}
      build-number: ${{ steps.version-info.outputs.build-number }}
      
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´Gitå†å²ç”¨äºç‰ˆæœ¬ä¿¡æ¯
        
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml gitpython
        
    - name: è®¾ç½®Flutterç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        
    - name: è·å–Flutterä¾èµ–
      run: flutter pub get
      
    - name: è¿è¡Œç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥
      run: |
        echo "ğŸ” è¿è¡Œç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥..."
        python scripts/check_version_consistency.py
        
    - name: ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
      id: version-info
      run: |
        echo "ğŸ“‹ ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯..."
        python scripts/generate_version_info.py
        
        # è¯»å–ç‰ˆæœ¬ä¿¡æ¯å¹¶è®¾ç½®è¾“å‡º
        VERSION=$(python -c "import json; print(json.load(open('version.json'))['version']['major'], json.load(open('version.json'))['version']['minor'], json.load(open('version.json'))['version']['patch'], sep='.')")
        BUILD_NUMBER=$(python -c "import json; print(json.load(open('version.json'))['version']['build'])")
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "build-number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
        echo "ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯: $VERSION+$BUILD_NUMBER"
        
    - name: ä¸Šä¼ ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: version-info
        path: |
          version.json
          version.yaml

  multi-platform-build:
    name: å¤šå¹³å°æ„å»ºæµ‹è¯•
    needs: version-check
    strategy:
      fail-fast: false
      matrix:
        include:
          # Androidå¹³å°
          - platform: android
            os: ubuntu-latest
            build-command: 'flutter build apk --debug'
            artifact-path: 'build/app/outputs/flutter-apk/'
            
          # iOSå¹³å° (ä»…åœ¨macOSä¸Šæ„å»º)
          - platform: ios
            os: macos-latest
            build-command: 'flutter build ios --debug --no-codesign'
            artifact-path: 'build/ios/iphoneos/'
            
          # Webå¹³å°  
          - platform: web
            os: ubuntu-latest
            build-command: 'flutter build web'
            artifact-path: 'build/web/'
            
          # Windowså¹³å°
          - platform: windows
            os: windows-latest
            build-command: 'flutter build windows'
            artifact-path: 'build/windows/runner/Release/'
            
          # macOSå¹³å°
          - platform: macos
            os: macos-latest
            build-command: 'flutter build macos'
            artifact-path: 'build/macos/Build/Products/Release/'
            
          # Linuxå¹³å°
          - platform: linux
            os: ubuntu-latest
            build-command: 'flutter build linux'
            artifact-path: 'build/linux/x64/release/bundle/'
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Flutterç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        
    - name: å¹³å°ç‰¹å®šè®¾ç½® - Linux
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update -y
        sudo apt-get install -y ninja-build libgtk-3-dev
        
    - name: å¹³å°ç‰¹å®šè®¾ç½® - Android
      if: matrix.platform == 'android'
      uses: android-actions/setup-android@v3
      with:
        api-level: 33
        build-tools: 33.0.0
        
    - name: è·å–Flutterä¾èµ–
      run: flutter pub get
      
    - name: ä¸‹è½½ç‰ˆæœ¬ä¿¡æ¯
      uses: actions/download-artifact@v4
      with:
        name: version-info
        
    - name: æ„å»º ${{ matrix.platform }} å¹³å°
      run: |
        echo "ğŸ”¨ æ„å»º ${{ matrix.platform }} å¹³å°..."
        ${{ matrix.build-command }}
        
    - name: éªŒè¯æ„å»ºäº§ç‰©
      run: |
        echo "âœ… éªŒè¯ ${{ matrix.platform }} æ„å»ºäº§ç‰©..."
        if [ -d "${{ matrix.artifact-path }}" ]; then
          echo "æ„å»ºäº§ç‰©ç›®å½•å­˜åœ¨: ${{ matrix.artifact-path }}"
          ls -la "${{ matrix.artifact-path }}"
        else
          echo "âŒ æ„å»ºäº§ç‰©ç›®å½•ä¸å­˜åœ¨: ${{ matrix.artifact-path }}"
          exit 1
        fi
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.platform }}
        path: ${{ matrix.artifact-path }}
        retention-days: 7

  # é¸¿è’™OSå¹³å°æ„å»º (å•ç‹¬å¤„ç†ï¼Œå› ä¸ºéœ€è¦ç‰¹æ®Šç¯å¢ƒ)
  ohos-build:
    name: é¸¿è’™OSæ„å»ºå‡†å¤‡
    needs: version-check
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: éªŒè¯é¸¿è’™OSé…ç½®
      run: |
        echo "ğŸ” éªŒè¯é¸¿è’™OSé…ç½®æ–‡ä»¶..."
        if [ -f "ohos/entry/src/main/config.json" ]; then
          echo "âœ… é¸¿è’™OSé…ç½®æ–‡ä»¶å­˜åœ¨"
          python -c "import json; json.load(open('ohos/entry/src/main/config.json'))"
          echo "âœ… é¸¿è’™OSé…ç½®æ–‡ä»¶æ ¼å¼æ­£ç¡®"
        else
          echo "âš ï¸ é¸¿è’™OSé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡æ„å»º"
        fi
        
    - name: æ£€æŸ¥é¸¿è’™OSç‰ˆæœ¬é…ç½®
      run: |
        echo "ğŸ“‹ æ£€æŸ¥é¸¿è’™OSç‰ˆæœ¬é…ç½®..."
        python -c "
        import json
        try:
            with open('version.json') as f:
                version_info = json.load(f)
            ohos_info = version_info.get('platforms', {}).get('ohos', {})
            print(f'é¸¿è’™OSç‰ˆæœ¬ä¿¡æ¯: {ohos_info}')
            if ohos_info:
                print('âœ… é¸¿è’™OSç‰ˆæœ¬é…ç½®æ­£ç¡®')
            else:
                print('âš ï¸ é¸¿è’™OSç‰ˆæœ¬é…ç½®ç¼ºå¤±')
        except Exception as e:
            print(f'âŒ æ£€æŸ¥é¸¿è’™OSç‰ˆæœ¬é…ç½®å¤±è´¥: {e}')
        "
        
    - name: ä¸Šä¼ é¸¿è’™OSé…ç½®
      uses: actions/upload-artifact@v4
      with:
        name: ohos-config
        path: |
          ohos/
          !ohos/build/
        retention-days: 7

  build-number-update:
    name: æ„å»ºå·æ›´æ–°
    needs: [version-check, multi-platform-build]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml gitpython
        
    - name: æ›´æ–°æ„å»ºå·
      run: |
        echo "ğŸ”„ æ›´æ–°æ„å»ºå·..."
        python scripts/update_build_number.py --strategy increment
        
    - name: æäº¤æ„å»ºå·æ›´æ–°
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if git diff --quiet; then
          echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
        else
          git add .
          git commit -m "chore: æ›´æ–°æ„å»ºå· [skip ci]"
          git push
        fi

  version-release:
    name: ç‰ˆæœ¬å‘å¸ƒå¤„ç†
    needs: [version-check, multi-platform-build]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml gitpython
        
    - name: æ‰‹åŠ¨ç‰ˆæœ¬é€’å¢
      if: github.event.inputs.version_increment != ''
      run: |
        echo "ğŸ“ˆ æ‰‹åŠ¨ç‰ˆæœ¬é€’å¢: ${{ github.event.inputs.version_increment }}"
        PRERELEASE_ARG=""
        if [ "${{ github.event.inputs.prerelease }}" != "" ]; then
          PRERELEASE_ARG="--prerelease ${{ github.event.inputs.prerelease }}"
        fi
        
        python scripts/generate_version_info.py \
          --increment ${{ github.event.inputs.version_increment }} \
          $PRERELEASE_ARG
          
    - name: æäº¤ç‰ˆæœ¬æ›´æ–°
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if git diff --quiet; then
          echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
        else
          NEW_VERSION=$(python -c "import json; v=json.load(open('version.json'))['version']; print(f\"{v['major']}.{v['minor']}.{v['patch']}\")")
          git add .
          git commit -m "chore: å‘å¸ƒç‰ˆæœ¬ v$NEW_VERSION"
          git push
          
          # åˆ›å»ºGitæ ‡ç­¾
          git tag "v$NEW_VERSION"
          git push origin "v$NEW_VERSION"
        fi

  notification:
    name: é€šçŸ¥å¤„ç†
    needs: [version-check, multi-platform-build, ohos-build]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: æˆåŠŸé€šçŸ¥
      if: needs.version-check.result == 'success' && needs.multi-platform-build.result == 'success'
      run: |
        echo "âœ… ç‰ˆæœ¬ç®¡ç†å·¥ä½œæµæ‰§è¡ŒæˆåŠŸ"
        echo "ç‰ˆæœ¬: ${{ needs.version-check.outputs.version }}"
        echo "æ„å»ºå·: ${{ needs.version-check.outputs.build-number }}"
        
    - name: å¤±è´¥é€šçŸ¥
      if: needs.version-check.result == 'failure' || needs.multi-platform-build.result == 'failure'
      run: |
        echo "âŒ ç‰ˆæœ¬ç®¡ç†å·¥ä½œæµæ‰§è¡Œå¤±è´¥"
        echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—å¹¶ä¿®å¤é—®é¢˜"
        exit 1 