# 撤销重做问题测试方案

## 测试目标
验证字帖编辑页面中，元素平移、resize、旋转操作后，只需要点击一次undo按钮就能完全撤销的修复效果。

## 测试环境
- Flutter应用的字帖编辑页面
- 具备元素操作功能（拖拽、resize、旋转）
- 具备撤销重做功能（undo/redo按钮）

## 测试用例

### 测试用例1：元素平移操作
**前置条件**：
1. 打开字帖编辑页面
2. 页面中至少有一个可操作的元素

**测试步骤**：
1. 选中一个元素
2. 记录元素的初始位置坐标
3. 拖拽元素到新位置
4. 记录元素的新位置坐标
5. 点击undo按钮一次
6. 检查元素位置是否完全回到初始位置

**预期结果**：
- ✅ 元素应该在一次undo后完全回到初始位置
- ❌ 如果需要多次undo才能回到初始位置，则测试失败

### 测试用例2：元素Resize操作
**前置条件**：
1. 打开字帖编辑页面
2. 页面中至少有一个可resize的元素

**测试步骤**：
1. 选中一个元素
2. 记录元素的初始尺寸（width, height）和位置（x, y）
3. 拖拽控制点调整元素大小
4. 记录元素的新尺寸和位置
5. 点击undo按钮一次
6. 检查元素尺寸和位置是否完全回到初始状态

**预期结果**：
- ✅ 元素的尺寸和位置应该在一次undo后完全恢复
- ❌ 如果需要多次undo才能恢复，则测试失败

### 测试用例3：元素旋转操作
**前置条件**：
1. 打开字帖编辑页面
2. 页面中至少有一个可旋转的元素

**测试步骤**：
1. 选中一个元素
2. 记录元素的初始旋转角度
3. 拖拽旋转控制点改变元素角度
4. 记录元素的新旋转角度
5. 点击undo按钮一次
6. 检查元素旋转角度是否完全回到初始角度

**预期结果**：
- ✅ 元素的旋转角度应该在一次undo后完全恢复
- ❌ 如果需要多次undo才能恢复，则测试失败

### 测试用例4：复合操作（移动+resize）
**前置条件**：
1. 打开字帖编辑页面
2. 页面中至少有一个可操作的元素

**测试步骤**：
1. 选中一个元素
2. 记录元素的初始状态（位置、尺寸）
3. 先拖拽元素到新位置
4. 再调整元素大小
5. 记录元素的最终状态
6. 点击undo按钮一次
7. 检查是否回到resize前的状态
8. 再点击undo按钮一次
9. 检查是否回到初始状态

**预期结果**：
- ✅ 第一次undo应该撤销resize操作
- ✅ 第二次undo应该撤销move操作
- ✅ 总共两次操作应该对应两次undo

## 日志监控要点

在测试过程中，注意观察控制台日志中以下关键信息：

### 正常情况（修复后）
```
创建撤销操作 - elementId: xxx, operationKey: xxx
```
每次操作只应该出现一次这样的日志。

### 异常情况（修复前）
```
创建撤销操作 - elementId: xxx, operationKey: xxx
创建撤销操作 - elementId: xxx, operationKey: xxx  // 重复
创建撤销操作 - elementId: xxx, operationKey: xxx  // 重复
```
如果看到重复的创建日志，说明还有重复创建的问题。

### 防重复机制日志
```
跳过重复撤销操作 - operationKey: xxx
```
如果看到这样的日志，说明防重复机制在正常工作。

## 性能测试

### 测试用例5：连续操作性能
**测试步骤**：
1. 连续快速拖拽元素10次
2. 观察每次操作的响应时间
3. 检查撤销栈中是否有10个独立的操作
4. 连续点击undo按钮10次
5. 检查元素是否回到初始位置

**性能指标**：
- 每次操作响应时间 < 100ms
- 撤销操作响应时间 < 50ms
- 内存使用量稳定，无明显泄漏

## 边界测试

### 测试用例6：极小移动
**测试步骤**：
1. 选中元素
2. 进行极小的移动（<3像素）
3. 检查是否创建撤销操作

**预期结果**：
- 极小移动可能被视为点击，不应创建撤销操作

### 测试用例7：快速连续操作
**测试步骤**：
1. 在200ms内快速进行多次相同操作
2. 检查是否只创建一个撤销操作

**预期结果**：
- 防重复机制应该生效，避免创建多个相同的撤销操作

## 回归测试

### 确保现有功能不受影响
1. **基本操作功能**：确保元素的增删改查功能正常
2. **选择功能**：确保单选、多选功能正常
3. **图层功能**：确保图层操作不受影响
4. **保存加载功能**：确保文件保存和加载功能正常
5. **其他撤销操作**：确保非移动/resize的撤销操作（如删除、添加）正常

## 测试记录模板

| 测试用例 | 执行日期 | 测试结果 | 备注 |
|---------|---------|---------|------|
| 元素平移 | YYYY-MM-DD | ✅/❌ | |
| 元素Resize | YYYY-MM-DD | ✅/❌ | |
| 元素旋转 | YYYY-MM-DD | ✅/❌ | |
| 复合操作 | YYYY-MM-DD | ✅/❌ | |
| 连续操作性能 | YYYY-MM-DD | ✅/❌ | |
| 极小移动 | YYYY-MM-DD | ✅/❌ | |
| 快速连续操作 | YYYY-MM-DD | ✅/❌ | |

## 问题排查

如果测试失败，按以下步骤排查：

1. **检查日志**：查看是否有重复的"创建撤销操作"日志
2. **检查调用栈**：确认撤销操作的创建来源
3. **检查时间戳**：确认防重复机制的时间窗口是否合适
4. **检查方法调用**：确认是否使用了正确的不创建撤销操作的方法

## 成功标准

所有测试用例通过，且满足以下条件：
- 每次用户操作只创建一个对应的撤销操作
- 撤销操作能够完全恢复到操作前的状态
- 性能指标在可接受范围内
- 现有功能不受影响 