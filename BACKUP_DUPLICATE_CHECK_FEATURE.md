# 备份文件导入导出重复检查功能

## 概述

为备份管理系统添加了完善的重复文件检查机制，确保在导入和导出备份文件时能够智能处理重复文件，提升用户体验并避免数据冲突。

## 新增功能

### 1. 重复备份检测 (`BackupRegistryManager`)

#### 新增方法：

1. **`checkForDuplicateBackup(String filePath)`**
   - 检查待导入的文件是否与现有备份重复
   - 基于文件名、大小和校验和进行多层检查
   - 返回重复的备份条目或null

2. **`checkFileExistsAtPath(String targetPath)`**
   - 检查指定路径是否已存在文件
   - 用于导出时避免文件覆盖

3. **`generateUniqueFilename(String targetDirectory, String originalFilename)`**
   - 自动生成不重复的文件名
   - 格式：`原文件名_数字.扩展名`

#### 检查逻辑：

```
1. 文件名 + 大小匹配 → 进一步检查校验和
2. 校验和完全匹配 → 确认为重复文件
3. 仅校验和匹配 → 内容相同但文件名不同的重复
```

### 2. 导入备份重复处理

当检测到重复备份时，系统会：

1. **显示重复文件信息对话框**
   - 现有备份的详细信息（文件名、创建时间、大小、校验和）
   - 询问用户是否继续导入

2. **用户选择**
   - 取消导入：停止操作
   - 继续导入：允许重复文件导入

3. **成功消息增强**
   - 普通导入：显示标准成功消息
   - 重复导入：显示"重复文件已导入"提示

### 3. 导出备份冲突处理

当目标位置存在同名文件时，系统提供三种选择：

1. **取消操作**：停止导出
2. **重命名导出**：自动生成唯一文件名
3. **覆盖文件**：替换现有文件

#### 重命名规则：
- `backup.db` → `backup_1.db`
- `backup_1.db` → `backup_2.db`
- 以此类推...

### 4. 导入到当前路径冲突处理

与导出功能类似，提供相同的三种处理选项：

1. **取消操作**
2. **重命名导入**：在当前备份路径下生成唯一文件名
3. **覆盖文件**：替换现有备份

## 用户界面改进

### 重复检测对话框
```
┌─────────────────────────────┐
│ ⚠️ 发现重复备份              │
├─────────────────────────────┤
│ 检测到要导入的备份文件与现有 │
│ 备份重复：                   │
│                             │
│ ┌─────────────────────────┐ │
│ │ 现有备份: backup.db     │ │
│ │ 创建时间: 2024-07-14... │ │
│ │ 大小: 2.5 MB           │ │
│ │ 校验和: a1b2c3d4...    │ │
│ └─────────────────────────┘ │
│                             │
│ 是否仍要继续导入此备份？     │
├─────────────────────────────┤
│        取消      继续导入    │
└─────────────────────────────┘
```

### 文件冲突对话框
```
┌─────────────────────────────┐
│ ⚠️ 文件已存在               │
├─────────────────────────────┤
│ 目标位置已存在同名文件：     │
│                             │
│ ┌─────────────────────────┐ │
│ │ /path/to/backup.db     │ │
│ └─────────────────────────┘ │
│                             │
│ 请选择操作：                 │
├─────────────────────────────┤
│  取消  重命名导出  覆盖文件  │
└─────────────────────────────┘
```

## 技术实现细节

### 校验和计算
- 使用 MD5 算法计算文件内容哈希
- 确保内容级别的重复检测精度

### 异步处理
- 所有文件操作均为异步执行
- 避免阻塞UI线程

### 错误处理
- 完善的异常捕获和日志记录
- 用户友好的错误提示

### 性能优化
- 分层检查（文件名+大小 → 校验和）
- 避免不必要的校验和计算

## 使用场景

### 1. 备份导入场景
- **场景**：用户尝试导入之前已存在的备份文件
- **处理**：提示重复并询问是否继续
- **结果**：避免意外的重复导入，用户可做明智选择

### 2. 备份导出场景
- **场景**：导出到已包含同名文件的目录
- **处理**：提供重命名或覆盖选项
- **结果**：防止意外覆盖重要文件

### 3. 跨路径导入场景
- **场景**：从历史备份路径导入文件到当前路径
- **处理**：检查当前路径下的文件冲突
- **结果**：灵活的冲突解决方案

## 配置与扩展

### 未来可扩展功能
1. **自定义重命名规则**：允许用户定义重命名格式
2. **批量冲突处理**：对多个文件应用相同策略
3. **智能重复检测**：基于内容相似性的高级检测
4. **备份合并功能**：合并重复备份的元数据

### 配置选项（预留）
- 默认冲突处理策略
- 是否启用校验和检查
- 重命名文件的命名规则

## 测试建议

1. **单文件导入测试**
   - 导入全新文件
   - 导入重复文件（相同内容）
   - 导入同名但不同内容的文件

2. **批量操作测试**
   - 导出多个文件到同一目录
   - 连续导入多个可能重复的文件

3. **边界情况测试**
   - 文件权限不足
   - 磁盘空间不足
   - 网络中断（如果涉及）

## 日志和监控

系统会记录以下关键操作：
- 重复文件检测结果
- 用户选择的冲突处理策略
- 文件重命名操作
- 导入导出成功/失败状态

这些日志有助于：
- 故障排查
- 用户行为分析
- 功能优化决策
