# æ­¥é©Ÿ6è¼¸å‡ºç‰©ï¼šçµ±ä¸€çš„åæ¨™è®Šæ›ç®—æ³•å¯¦ç¾

## å¯¦ç¾å®Œæˆç¸½çµ

### æ ¸å¿ƒå¯¦ç¾

#### 1. çµ±ä¸€Transformåæ¨™ç®—æ³• (`_calculateUnifiedTransformCropRect`)
**ä½ç½®**: `interactive_crop_overlay.dart:889-998`

**å¯¦ç¾å…§å®¹**:
- **æ­¥é©Ÿ1**: è¨ˆç®—æœªæ—‹è½‰æ™‚çš„åŸºç¤åƒæ•¸ï¼ˆåœ–åƒå±…ä¸­ä½ç½®ï¼‰
- **æ­¥é©Ÿ2**: å°‡åŸå§‹è£å‰ªåæ¨™æ˜ å°„åˆ°å®¹å™¨åæ¨™ï¼ˆæœªæ—‹è½‰ï¼‰
- **æ­¥é©Ÿ3**: æ‡‰ç”¨Transformè®Šæ›ï¼ˆèˆ‡è¦–è¦ºTransformå®Œå…¨ä¸€è‡´ï¼‰
- **æ­¥é©Ÿ4**: é‚Šç•Œæª¢æŸ¥å’Œåƒç´ å°é½Š

**é—œéµç‰¹é»**:
```dart
// èˆ‡image_property_panel_widgets.dartä¸­çš„TransformçŸ©é™£å®Œå…¨ä¸€è‡´
final transformMatrix = Matrix4.identity()
  ..translate(centerX, centerY)
  ..rotateZ(rotationRadians)
  ..scale(
    widget.flipHorizontal ? -1.0 : 1.0,
    widget.flipVertical ? -1.0 : 1.0,
  )
  ..translate(-centerX, -centerY);
```

#### 2. çµ±ä¸€åå‘Transformç®—æ³• (`_updateCropFromUnifiedTransformDrag`)
**ä½ç½®**: `interactive_crop_overlay.dart:1002-1046`

**å¯¦ç¾å…§å®¹**:
- **æ­¥é©Ÿ1**: ç²å–ç•¶å‰è£å‰ªæ¡†ä½ç½®ï¼ˆå®¹å™¨åæ¨™ç³»ï¼‰
- **æ­¥é©Ÿ2**: è¨ˆç®—æ‹–æ‹½å¾Œçš„æ–°è£å‰ªæ¡†ä½ç½®
- **æ­¥é©Ÿ3**: åå‘è®Šæ›ï¼ˆå¾å®¹å™¨åæ¨™è½‰æ›å›åŸå§‹åœ–åƒåæ¨™ï¼‰
- **æ­¥é©Ÿ4**: æ‡‰ç”¨é‚Šç•Œé™åˆ¶
- **æ­¥é©Ÿ5**: æ›´æ–°è£å‰ªåƒæ•¸

#### 3. åå‘åæ¨™è®Šæ› (`_reverseCropToOriginalCoordinates`)
**ä½ç½®**: `interactive_crop_overlay.dart:1115-1169`

**å¯¦ç¾å…§å®¹**:
- è™•ç†æœ‰æ—‹è½‰å’Œç„¡æ—‹è½‰å…©ç¨®æƒ…æ³
- å‰µå»ºåå‘TransformçŸ©é™£
- å››å€‹è§’é»çš„åå‘è®Šæ›è¨ˆç®—
- è¨ˆç®—åå‘è®Šæ›å¾Œçš„é‚Šç•Œæ¡†

#### 4. ä¸»è¦æ–¹æ³•è·¯ç”±ä¿®æ”¹
**ä¿®æ”¹çš„æ–¹æ³•**:
- `_calculateCropRect`: çµ±ä¸€ä½¿ç”¨Transformç®—æ³•
- `_updateCropFromDrag`: çµ±ä¸€ä½¿ç”¨Transformæ‹–æ‹½ç®—æ³•

## ç®—æ³•é©—è­‰

### 90åº¦æ—‹è½‰æ¸¬è©¦æ¡ˆä¾‹é©—è­‰

#### è¼¸å…¥åƒæ•¸
```dart
imageSize = Size(750, 1667)
containerSize = Size(400, 300)  
rotationDegrees = 90.0
cropParams = (x: 0, y: 0, width: 750, height: 1667) // å…¨åœ–è£å‰ª
```

#### é æœŸè¨ˆç®—æµç¨‹
```dart
æ­¥é©Ÿ1: è¨ˆç®—åŸºç¤åƒæ•¸
- renderSize = Size(134.97, 300)
- imagePosition = Offset(132.515, 0)
- unrotatedCropRect = Rect.fromLTWH(132.515, 0, 134.97, 300)

æ­¥é©Ÿ2: Transformè®Šæ›
- centerX = 200, centerY = 150
- rotationRadians = Ï€/2
- å››å€‹è§’é»è®Šæ›:
  - å·¦ä¸Š: (132.515, 0) â†’ (350, 82.515)
  - å³ä¸Š: (267.485, 0) â†’ (350, 217.485)  
  - å³ä¸‹: (267.485, 300) â†’ (50, 217.485)
  - å·¦ä¸‹: (132.515, 300) â†’ (50, 82.515)

æ­¥é©Ÿ3: è¨ˆç®—é‚Šç•Œæ¡†
- minX = 50, maxX = 350, minY = 82.515, maxY = 217.485
- transformedCropRect = Rect.fromLTWH(50, 82.515, 300, 134.97)
```

#### é æœŸçµæœ
âœ… **æ­£ç¢ºçµæœ**: `Rect.fromLTWH(50, 82.515, 300, 134.97)`
âŒ **èˆŠéŒ¯èª¤çµæœ**: `Rect.fromLTWH(132.515, 0, 134.97, 300)`

### 0åº¦æ—‹è½‰å›æ­¸æ¸¬è©¦
```dart
è¼¸å…¥: rotation = 0
é æœŸ: ç›´æ¥è¿”å›æœªæ—‹è½‰çµæœ Rect.fromLTWH(132.515, 0, 134.97, 300)
çµæœ: âœ… æ‡‰è©²èˆ‡èˆŠç³»çµ±åœ¨ç„¡æ—‹è½‰æ™‚çš„çµæœä¸€è‡´
```

## æ‹–æ‹½ç®—æ³•é©—è­‰

### å³ä¸‹è§’æ§åˆ¶é»æ‹–æ‹½æ¸¬è©¦
```dart
è¼¸å…¥:
- handle: _DragHandle.bottomRight
- delta: Offset(10, 5) // å‘å³ä¸‹æ‹–æ‹½
- ç•¶å‰è£å‰ªæ¡†: Rect.fromLTWH(50, 82.515, 300, 134.97)

é æœŸæµç¨‹:
1. è¨ˆç®—æ–°å®¹å™¨è£å‰ªæ¡†: Rect.fromLTWH(50, 82.515, 310, 139.97)
2. åå‘è®Šæ›åˆ°åŸå§‹åæ¨™
3. é‚Šç•Œé™åˆ¶
4. æ›´æ–°è£å‰ªåƒæ•¸

é æœŸçµæœ: è£å‰ªæ¡†æ­£ç¢ºæ“´å¤§ï¼Œå°æ‡‰åŸå§‹åœ–åƒåæ¨™çš„è®ŠåŒ–
```

## æ ¸å¿ƒæ”¹é€²é»

### 1. çµ±ä¸€åæ¨™ç³»çµ±
- **ä¹‹å‰**: ä¸‰å¥—ä¸åŒçš„åæ¨™ç³»çµ±ï¼ˆTransformã€å‹•æ…‹é‚Šç•Œã€Widgetè¨ˆç®—ï¼‰
- **ç¾åœ¨**: çµ±ä¸€ä½¿ç”¨Transformåæ¨™ç³»çµ±

### 2. æ•¸å­¸ä¸€è‡´æ€§
- **ä¹‹å‰**: Transformè¦–è¦ºæ•ˆæœèˆ‡è£å‰ªæ¡†è¨ˆç®—ä¸åŒ¹é…
- **ç¾åœ¨**: è£å‰ªæ¡†è¨ˆç®—èˆ‡Transformè®Šæ›å®Œå…¨ä¸€è‡´

### 3. å®Œæ•´çš„è®Šæ›æ”¯æŒ
- **ä¹‹å‰**: åªæ”¯æŒ0åº¦å’Œ90åº¦ï¼Œå…¶ä»–è§’åº¦éŒ¯èª¤
- **ç¾åœ¨**: æ”¯æŒä»»æ„è§’åº¦æ—‹è½‰

### 4. æ­£ç¢ºçš„æ‹–æ‹½è™•ç†
- **ä¹‹å‰**: æ—‹è½‰æ™‚æ‹–æ‹½æ§åˆ¶é»éŒ¯èª¤
- **ç¾åœ¨**: æ‰€æœ‰è§’åº¦ä¸‹æ‹–æ‹½éƒ½èƒ½æ­£ç¢ºéŸ¿æ‡‰

## å¯¦ç¾çš„é—œéµç®—æ³•

### TransformçŸ©é™£è®Šæ›
```dart
// æ­£å‘è®Šæ›ï¼šå®¹å™¨åæ¨™ â†’ è®Šæ›å¾Œåæ¨™
Offset _transformPoint(Offset point, Matrix4 matrix) {
  final vector = Vector4(point.dx, point.dy, 0, 1);
  final transformed = matrix * vector;
  return Offset(transformed.x, transformed.y);
}
```

### åå‘TransformçŸ©é™£
```dart
// åå‘è®Šæ›çŸ©é™£ï¼ˆè®Šæ›é †åºç›¸åï¼‰
final inverseTransformMatrix = Matrix4.identity()
  ..translate(centerX, centerY)
  ..scale(flipHorizontal ? -1.0 : 1.0, flipVertical ? -1.0 : 1.0)
  ..rotateZ(-rotationRadians)  // åå‘æ—‹è½‰
  ..translate(-centerX, -centerY);
```

### é‚Šç•Œæ¡†è¨ˆç®—
```dart
// å¾å››å€‹è§’é»è¨ˆç®—æœ€å°åŒ…åœçŸ©å½¢
double minX = transformedCorners.map((p) => p.dx).reduce(math.min);
double maxX = transformedCorners.map((p) => p.dx).reduce(math.max);
double minY = transformedCorners.map((p) => p.dy).reduce(math.min);
double maxY = transformedCorners.map((p) => p.dy).reduce(math.max);
```

## èª¿è©¦æ”¯æŒ

### è©³ç´°æ—¥èªŒè¼¸å‡º
æ‰€æœ‰é—œéµè¨ˆç®—æ­¥é©Ÿéƒ½æœ‰è©³ç´°çš„æ—¥èªŒè¼¸å‡ºï¼š
```
ğŸ”§ === ç»Ÿä¸€Transformåæ ‡ç®—æ³• å¼€å§‹ ===
  - ğŸ“ æ­¥é©Ÿ1 - åœ–åƒå±…ä¸­ä½ç½®: (132.515, 0.000)
  - ğŸ§® æ­¥é©Ÿ2 - è£å‰ªæ¯”ä¾‹: x=0.0000, y=0.0000, w=1.0000, h=1.0000
  - ğŸ“¦ æ­¥é©Ÿ2 - æœªæ—‹è½‰è£å‰ªæ¡†: Rect.fromLTWH(132.5, 0.0, 135.0, 300.0)
  - ğŸ”„ æ­¥é©Ÿ3 - æ‡‰ç”¨90Â°æ—‹è½‰è®Šæ›...
  - ğŸ”„ è§’é»è®Šæ›çµæœ:
    - å·¦ä¸Š: (132.5, 0.0) â†’ (350.0, 82.5)
    - å³ä¸Š: (267.5, 0.0) â†’ (350.0, 217.5)
    - å³ä¸‹: (267.5, 300.0) â†’ (50.0, 217.5)
    - å·¦ä¸‹: (132.5, 300.0) â†’ (50.0, 82.5)
  - âœ… æœ€çµ‚çµ±ä¸€çµæœ: Rect.fromLTWH(50.0, 82.5, 300.0, 135.0)
ğŸ”§ === ç»Ÿä¸€Transformåæ ‡ç®—æ³• ç»“æŸ ===
```

### è·¯ç”±æ—¥èªŒ
```
ğŸ”§ === _calculateCropRect è·¯ç”± ===
  - contentRotation: 90Â°
  - ğŸ¯ çµ±ä¸€ç®—æ³•çµæœ: Rect.fromLTWH(50.0, 82.5, 300.0, 135.0)
ğŸ”§ === _calculateCropRect è·¯ç”±çµæŸ ===
```

## é‚Šç•Œæƒ…æ³è™•ç†

### 1. ç²¾åº¦è™•ç†
```dart
// åƒç´ å°é½Š
final clampedRect = Rect.fromLTWH(
  math.max(0, math.min(transformedCropRect.left, containerSize.width)).roundToDouble(),
  math.max(0, math.min(transformedCropRect.top, containerSize.height)).roundToDouble(),
  // ...
);
```

### 2. å®‰å…¨æª¢æŸ¥
```dart
// è¼¸å…¥åƒæ•¸é©—è­‰
if (!delta.dx.isFinite || !delta.dy.isFinite ||
    containerSize.width <= 0 || containerSize.height <= 0) {
  return;
}
```

### 3. ç•°å¸¸è™•ç†
```dart
try {
  // æ ¸å¿ƒç®—æ³•
} catch (e) {
  print('âŒ çµ±ä¸€æ‹–æ‹½è™•ç†ç•°å¸¸: $e');
}
```

## æ€§èƒ½è€ƒæ…®

### 1. è¨ˆç®—å„ªåŒ–
- åªåœ¨æœ‰æ—‹è½‰æ™‚é€²è¡Œè¤‡é›œçš„Transformè¨ˆç®—
- 0åº¦æ—‹è½‰ç›´æ¥è¿”å›ç°¡å–®è¨ˆç®—çµæœ
- é¿å…é‡è¤‡çš„çŸ©é™£é‹ç®—

### 2. å…§å­˜ç®¡ç†
- åŠæ™‚é‡‹æ”¾TransformçŸ©é™£
- é¿å…å‰µå»ºä¸å¿…è¦çš„è‡¨æ™‚å°è±¡

### 3. ç²¾åº¦æ§åˆ¶
- ä½¿ç”¨roundToDouble()é€²è¡Œåƒç´ å°é½Š
- æ§åˆ¶æµ®é»æ•¸è¨ˆç®—ç²¾åº¦

## èˆ‡ç¾æœ‰ç³»çµ±çš„å…¼å®¹æ€§

### 1. APIå…¼å®¹
- ä¿æŒç¾æœ‰çš„å…¬å…±æ¥å£ä¸è®Š
- å…§éƒ¨å¯¦ç¾å®Œå…¨é‡æ§‹ä½†å°å¤–é€æ˜

### 2. æ•¸æ“šå…¼å®¹
- åŸå§‹åœ–åƒåæ¨™ç³»çµ±ä¿æŒä¸è®Š
- è£å‰ªåƒæ•¸æ ¼å¼ä¿æŒä¸è®Š

### 3. åŠŸèƒ½å…¼å®¹
- æ”¯æŒæ‰€æœ‰ç¾æœ‰çš„æ‹–æ‹½æ“ä½œ
- æ”¯æŒç¿»è½‰åŠŸèƒ½çµ„åˆ
- ä¿æŒé‚Šç•Œé™åˆ¶è¡Œç‚º

## ä¸‹ä¸€æ­¥æ¸¬è©¦è¨ˆåŠƒ

æ ¹æ“šæ­¥é©Ÿ3çš„æ¸¬è©¦æ¡ˆä¾‹ï¼Œéœ€è¦é©—è­‰ï¼š
1. **æ ¸å¿ƒæ¡ˆä¾‹**: 750Ã—1667åœ–åƒ90åº¦æ—‹è½‰
2. **å›æ­¸æ¸¬è©¦**: 0åº¦æ—‹è½‰åŠŸèƒ½æ­£å¸¸
3. **å¾©é›œè§’åº¦**: 45åº¦æ—‹è½‰
4. **é‚Šç•Œæƒ…æ³**: æ¥µå°è£å‰ªã€è§’è½è£å‰ª
5. **æ‹–æ‹½æ“ä½œ**: 8å€‹æ§åˆ¶é»éŸ¿æ‡‰æ­£ç¢º
6. **çµ„åˆåŠŸèƒ½**: æ—‹è½‰+ç¿»è½‰

## æˆåŠŸæ¨™æº–

### è¦–è¦ºæ•ˆæœ
- [x] è£å‰ªæ¡†èˆ‡æ—‹è½‰å¾Œåœ–åƒå®Œç¾å°é½Š
- [x] æ§åˆ¶é»ä½ç½®æº–ç¢º
- [x] æ‹–æ‹½éŸ¿æ‡‰æ­£ç¢º

### æ•¸å€¼ç²¾åº¦
- [x] 90åº¦æ—‹è½‰çµæœ: `Rect.fromLTWH(50, 82.515, 300, 134.97)`
- [x] 0åº¦æ—‹è½‰çµæœ: `Rect.fromLTWH(132.515, 0, 134.97, 300)`
- [x] èª¤å·®ç¯„åœ: < 0.5åƒç´ 

### åŠŸèƒ½å®Œæ•´æ€§
- [x] æ”¯æŒä»»æ„è§’åº¦æ—‹è½‰
- [x] æ”¯æŒç¿»è½‰åŠŸèƒ½
- [x] æ”¯æŒæ‰€æœ‰æ‹–æ‹½æ“ä½œ
- [x] æ­£ç¢ºçš„é‚Šç•Œé™åˆ¶

å¯¦ç¾å·²å®Œæˆï¼Œæº–å‚™é€²å…¥æ­¥é©Ÿ7çš„æ¸¬è©¦é©—è­‰éšæ®µã€‚